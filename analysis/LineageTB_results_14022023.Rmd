---
title: "Lineage TB analysis"
author: "Duc Du"
date: "20/10/2022"
output:
  word_document: default
  html_document: default
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
#.libPaths( c( .libPaths(), "C:/Program Files/R/R-devel/library") )
rm(list = ls(all.names = TRUE))
knitr::opts_chunk$set(echo = FALSE, cache=TRUE,
                      tidy.opts=list(width.cutoff=60),
                      tidy=TRUE)
options(repos = getOption("repos")["CRAN"])

## Required R packages  
#install.packages("installr") # install installr
library(installr) #load

#install.packages(c("knitr", "rmarkdown", "markdown"))

library(knitr)
#install.packages("rlang")
library(rmarkdown)
library(markdown)

library(stringr)
library(forcats)
library(RColorBrewer)
#install.packages("cli")
#library(tidyverse)
library(dplyr)
library(readxl)
library(writexl)
library(ggplot2)
library(Hmisc)
library(gtsummary)
library(flextable)
library(huxtable)

library(readxl)
library(data.table)
library(lubridate)
library(stringi)

library(psych) # for describing the data
library(tableone)
#library(compareGroups)
library(forcats)
library(ggpubr)
library(rstatix)

library(lme4)
library(MASS)
# install.packages("remotes") # if not already installed
# remotes::install_github("https://github.com/StatsGary/ConfusionTableR")
#library(ConfusionTableR)
#install.packages("dlookr")
library(dlookr)
library(flextable)
library(data.table)
#install.packages("remotes")
library(remotes)
# remotes::install_github("lampk/C306", force=TRUE)
# remotes::install_github("oucru-biostats/C306@experimental")
# remotes::install_github("oucru-biostats/ST306", force=TRUE)

library(C306)
library(ST306)
library(reshape2)
library(rms)
```

```{r, results='hide', message=FALSE, warning=FALSE}
## Load dataset
data_path <- file.path("D:/OMICS/Lineage")
load(file.path("lineage_all.Rdata"))

### read from excel
all2_new_raw <- read.csv("for_duc_22062022.csv", header = TRUE)
#all2_new_raw <- read_excel("for_Duc_22062022.xlsx", col_types = "text")
sputum <- read_excel("sputum28_29TB_Tim.xlsx", col_types = "text")
outcome <- read_excel("outcome_28_29TB_Tim.xlsx", col_types = "text")

### remove duplication
all2_new_raw <- unique(all2_new_raw, by = c("id"))

outcome <- unique(outcome, by = c("id"))

#vn_outcome <- merge(as.data.frame(all2_new_raw), as.data.frame(outcome), by="id")

all2_new2 <- as.data.frame(all2_new_raw) %>%
  mutate(age=as.numeric(age),
         age=structure(age, label="Age", unit="years"),
         sex=factor(sex, levels = c(0,1), labels = c("Female", "Male")),
         sex=structure(sex, label="Sex"),
         hiv=factor(hiv, levels = c(0,1), labels = c("Negative", "Positive")),
         hiv=structure(hiv, label="HIV"),
         cavity=factor(cavity, levels = c(0,1), labels = c("No", "Yes")),
         cavity=structure(cavity, label="Cavitary TB"),
         timika=structure(timika, label="Timika score"),
         timika=as.numeric(timika),
         rtimeculture=as.numeric(rtimeculture),
         ltimeculture=as.numeric(ltimeculture),
         rtimesmear=as.numeric(rtimesmear),
         ltimesmear=as.numeric(ltimesmear),
         pulmonary=factor(pulmonary, levels = c(0,1), labels = c("No", "Yes")),
         pulmonary=structure(pulmonary, label="Pulmonary TB"),
         cns=factor(cns, levels = c(0,1), labels = c("No", "Yes")),
         cns=structure(cns, label="CNS"),
         osteo=factor(osteo, levels = c(0,1), labels = c("No", "Yes")),
         osteo=structure(osteo, label="Osteoraticular TB"),
         other=factor(other, levels = c(0,1), labels = c("No", "Yes")),
         other=structure(other, label="Other TB"),
         site = factor(site, levels = c(0,1,2,3), labels = c("Pulmonary TB", "TBM", "Osteoraticular TB", "Other TB")),
         lineage = na_if(lineage, ""),
         lineage = dplyr::recode(lineage, "1"=1, "2"=2, "3"=3, "4"=4, "5"=5, "6"=6, "Mbov"=7, "mixed"=8),
         lineage = factor(lineage, levels = c(1,2,3,4,5,6,7,8), labels = c("Lineage 1", "Lineage 2", "Lineage 3", "Lineage 4", "Lineage 5", "Lineage 6", "Lineage BOV","Mixed")),
         inh=structure(inh, label="Resistance to Isoniazid"),
         rif=structure(rif, label="Resistance to Rifampin"),
         binary_culture_con = na_if(binary_culture_con, ""),
         binary_culture_con = dplyr::recode(binary_culture_con, ">60"=0, "60"=1),
         binary_culture_con=factor(binary_culture_con, levels = c(0,1), labels = c("Negative", "Positive")),
         binary_culture_con=structure(binary_culture_con, label="Binary culture conversion"),
         binary_smear_con = na_if(binary_smear_con, ""),
         binary_smear_con = dplyr::recode(binary_smear_con, ">60"=0, "60"=1),
         binary_smear_con=factor(binary_smear_con, levels = c(0,1), labels = c("Negative", "Positive")),
         binary_smear_con=structure(binary_smear_con, label="Binary smear conversion"),
         symptom_duration=as.numeric(symptom_duration),
         symptom_duration=structure(symptom_duration, label="Symptom duration", unit="days"),
         symptomaticdisease=factor(symptomaticdisease, levels = c(0,1), labels = c("Asymptomatic", "Symtomatic")),
         smear_con_t=as.numeric(smear_con_t),
         culture_con_t=as.numeric(culture_con_t),
         smear=as.character(smear),
         smear=na_if(smear, "666"),
         smear=na_if(smear, "NA"),
         smear=factor(smear),
         previousTB=factor(previousTB, levels = c(0,1), labels = c("No", "Yes")),
         outcome=na_if(outcome, "unknown"),
         outcome=na_if(outcome, ""),
         outcome= dplyr::recode(outcome, "unsuccessful"=0, "successful"=1),
         outcome=factor(outcome , levels = c(0,1), labels = c("Unsuccessful", "Successful")),
         outcome=structure(outcome, label="Treatment outcome"),
         dm=factor(dm, levels = c(0,1), labels = c("No", "Yes")),
         dm=structure(dm, label="Diabetes"),
         country=structure(country, label="Country"),
         spoligo=structure(spoligo, label="Spoligotype"),
         regimen=structure(regimen, label="Regimen"),
         mdr=structure(mdr, label="Drug resistance"),
         mdr=factor(mdr, levels = c(0,1,2), labels = c("Drug susceptible", "Isoniazid resistance", "Rifampicin resistance")),
         lin1234=factor(lin1234, levels = c(1,2,3,4), labels = c("Lineage 1", "Lineage 2", "Lineage 3", "Lineage 4"))) %>% droplevels() %>%
  dplyr::filter(!is.na(lin1234)) %>% droplevels() %>% as.data.frame()
```

```{r clean sputum data, results='hide', message=FALSE, warning=FALSE}
# Clean data
## choose right timepoint, and exclude other
Time_point <- c("N0", "N14", "T01","T02","T03", "T04", "T05", "T06", "T07", "T08", "T09", "T10", "T11","T12", "T13","T14", "T15"
                ,"T16", "T17", "T18", "T19", "T20", "T21", "T22", "T23", "T24", "T25"
                ,"T26", "T27", "T28", "T29", "T30", "T31", "T32", "T33", "T34", "T35", "T36")

## subset samples in right timepoint
sputum <- subset(sputum, SampleNumber %in%  Time_point)

## subset 28TB and 29TB
#sputum <- subset(sputum,substr(studycode,1,4)=="29TB"|substr(studycode,1,4)=="28TB")

##-----------------28TB----------------
## subset 28TB
#sputum_raw <- subset(sputum, substr(studycode,1,4)=="28TB")

## exlucded ID that we LFU or not eligible to recruite
excluded_28TB <- read_excel("exclude_28.xlsx",sheet = "excluded")
excluded_28TB <- subset(excluded_28TB,!is.na(ID))

excluded_ID_28TB = paste("28TB",
                         as.character(excluded_28TB$ID),
                         sep = "-")
sputum_raw <- subset(sputum ,studycode %nin% c(excluded_ID_28TB)) #28TB-D13-008 1st month treat by 1st line, then LFU until T08
sputum_raw$MgitCulture<-as.factor(sputum_raw$MgitCulture)
sputum_raw$MgitCulture <- as.character(droplevels(sputum_raw$MgitCulture)) ## remove some levels with no obs and convert value of Mgitculture to character

## change blank of Mgitculture to "waiting"
sputum_raw$MgitCulture[sputum_raw$MgitCulture==""] <- "waiting"
## change "False Positive" to "Contamination"
sputum_raw$MgitCulture[sputum_raw$MgitCulture=="False Positive"] <- "Contamination"

## summary Culture resutls with following definition
#---- LJ Pos -> Culture Positive
#---- LJ not Pos and MGIT Negative -> Culture Negative
#---- LJ not Pos and MGIT not Negative, Check MGIT_Re_result,MGIT_de_result,Check_ZN_For_MGIT_Neg if any of them Neg -> Culture Negative
#---- LJ not Pos and MGIT Positive, Check MGIT_Re_result,MGIT_de_result,Check_ZN_For_MGIT_Neg if all of them show not Neg ->Culture MGITPositive
#---- remaining will be assign with MGITculture (Contamination or waiting)


# sputum_raw$Culture <- with(sputum_raw,ifelse(!is.na(LJ_Result)&LJ_Result=="Pos","Positive",ifelse((is.na(LJ_Result)|LJ_Result!="Pos") & MgitCulture =="Negative","Negative",
#                                                                                       ifelse(MGIT_de_result=="Neg"|MGIT_Re_result=="Neg"|Check_ZN_For_MGIT_Neg=="Neg",
#                                                                                              "Neg",ifelse(MgitCulture=="Positive","MGITPositive",MgitCulture)))))

sputum_raw$Culture <- with(sputum_raw,ifelse(!is.na(LJ_Result) & LJ_Result=="Pos","Positive","Negative"))


## subset data for important variables and export to csv file
sputum_raw_subset <- sputum_raw[,c("studycode", "SampleNumber", "DateSample", "DateMgit", "MgitCulture", "Archive", "DateLJ_Pos", "LJ_Result", "ZN", "Culture")]
sputum_raw_subset$id<-paste(sputum_raw_subset$studycode, sputum_raw_subset$SampleNumber, sep="-")

which(is.na(sputum_raw_subset$Culture))
## check duplicate sample ID
sputum_raw_subset$studycode[duplicated(sputum_raw_subset$id)] #remove manually in excel file

## sputum_raw_subset[which(sputum_raw_subset$studycode=="28TB-D15-012"),]


## convert to wide data that contains culture results

sputum_wide_culture <- dcast(sputum_raw_subset, studycode~ SampleNumber,value.var="Culture" )

Access_date<- dcast(sputum_raw_subset, studycode~ SampleNumber,value.var ="DateSample" )

## rename of new column to culture
colnames(sputum_wide_culture)[2:ncol(sputum_wide_culture)] <- paste(rep("Culture",ncol(sputum_wide_culture)-1),
                                                                              colnames(sputum_wide_culture)[2:ncol(sputum_wide_culture)], sep = ".")

## fill NA with no sputum
sputum_wide_culture[is.na(sputum_wide_culture)] <- "no sputum"

##END
## convert to wide data that contains date of timepoint for 28TB
sputum_wide_date <- dcast(sputum_raw_subset, studycode~ SampleNumber,value.var="DateSample" )

## rename of new colume to date
colnames(sputum_wide_date)[2:ncol(sputum_wide_date)] <- paste(rep("date",ncol(sputum_wide_date)-1),
                                                                              colnames(sputum_wide_date)[2:ncol(sputum_wide_date)], sep = ".")

## Merge Date of sample N0 to culture data
sputum_clean <- merge(sputum_wide_culture, sputum_wide_date,by="studycode",all=T)


#Treatment_data = dplyr::select(Treatment_data, -c(1,2,"DateComplete","CompleteEntire",
#                                           "DateLastASS","DateLastALIVE","OUT","DateDeath", "DateLastFU",
#                                           which(colnames(Treatment_data)== "Culture.N0") : length(colnames(Treatment_data))))


## sellect treatment regimen and started day
#Treatment_day_data = dplyr::select(Treatment_data, c("studycode","Regimen", "STDAT"))

## Merge treatment day data with new DTU treatment oucome
#Treatment_final <-left_join(Treatment_day_data, DTU_outcome, by="studycode")

## Merge culture sputum data with treatment and outcome data
sputum_clean <-left_join(outcome, sputum_clean, by="studycode")
## Impute the missing date N0 of 29TB
sputum_clean$date.N0[sputum_clean$studycode=="29TB-D06-011"]<-sputum_clean$STDAT[sputum_clean$studycode=="29TB-D06-011"]
sputum_clean$date.N0[sputum_clean$studycode=="29TB-D06-012"]<-sputum_clean$STDAT[sputum_clean$studycode=="29TB-D06-012"]
sputum_clean$date.N0[sputum_clean$studycode=="29TB-D06-032"]<-sputum_clean$STDAT[sputum_clean$studycode=="29TB-D06-032"]
sputum_clean$date.N0[sputum_clean$studycode=="29TB-D12-071"]<-sputum_clean$STDAT[sputum_clean$studycode=="29TB-D12-071"]
sputum_clean$date.N0[sputum_clean$studycode=="29TB-D19-011"]<-sputum_clean$STDAT[sputum_clean$studycode=="29TB-D19-011"]


##-------------- function for last conversion
Timetoconvert_last <- function(row_data) {
  temp_time = NA
  Convert_result = NA
  if (is.na(row_data[["Regimen"]]) | "Positive" %nin% c(row_data[["Culture.N0"]], row_data[["Culture.N14"]])) {Convert_result = NA 
  } 
  else if (substr(row_data[["studycode"]],1,4)=="29TB" & row_data[["Regimen"]]=="6M") {
    row_data_culture = row_data[1:which(colnames(row_data)=="Culture.T06")]
    for (t in 1:length(row_data_culture)) {
      if (as.character(row_data_culture[t])=="Negative" & "Positive" %nin% as.character(row_data_culture[-c(1:t)])) {
        temp_time = t;
        Convert_result = colnames(row_data)[temp_time]
        break;
      }
    }
  }
  else if (substr(row_data[["studycode"]],1,4)=="29TB" & row_data[["Regimen"]]=="8M") {
    row_data_culture = row_data[1:which(colnames(row_data)=="Culture.T08")]
    for (t in 1:length(row_data_culture)) {
      if (as.character(row_data_culture[t])=="Negative" & "Positive" %nin% as.character(row_data_culture[-c(1:t)])) {
        temp_time = t;
        Convert_result = colnames(row_data)[temp_time]
        break;
      }
    }
  }
  else if (substr(row_data[["studycode"]],1,4)=="28TB" & row_data[["Regimen"]]=="9M") {
    row_data_culture = row_data[1:which(colnames(row_data)=="Culture.T09")]
    for (t in 1:length(row_data_culture)) {
      if (as.character(row_data_culture[t])=="Negative" & "Positive" %nin% 
          as.character(row_data_culture[-c(1:t)]) & "Negative" %in% as.character(row_data_culture[-c(1:t)])) {
        temp_time = t;
        Convert_result = colnames(row_data)[temp_time]
        break;
      }
    }
  }
  else if (substr(row_data[["studycode"]],1,4)=="28TB" & row_data[["Regimen"]]=="20M") {
    row_data_culture = row_data[1:which(colnames(row_data)=="Culture.T20")]
    for (t in 1:length(row_data_culture)) {
      if (as.character(row_data_culture[t])=="Negative" & "Positive" %nin% 
          as.character(row_data_culture[-c(1:t)]) & "Negative" %in% as.character(row_data_culture[-c(1:t)])) {
        temp_time = t;
        Convert_result = colnames(row_data)[temp_time]
        break;
      }
    }
  }
  
  if (is.na(temp_time)) Convert_result = "censor"
  return(Convert_result)
  
}


last_days_to_convert <- function(last_convert_time_point,v){
  if(is.na(last_convert_time_point)){
    last_time = NA
  }
  else if (last_convert_time_point == "censor" & is.na(v[["OUT"]])){
    last_time = 620
  }
  else if (last_convert_time_point == "censor" & v[["OUT"]]!="Died" & v[["OUT"]]!="LOSTFU"){
    last_time = 620
  }
  else if (last_convert_time_point == "censor" & (v[["OUT"]]=="Died"|v[["OUT"]]=="LOSTFU") & substr(v[["studycode"]],1,4)=="29TB"){
    last_time = as.Date(v[["DateLastASS"]],format="%m/%d/%Y") - as.Date(v[["date.N0"]],format="%m/%d/%Y")
  }
  else if (last_convert_time_point == "censor" & (v[["OUT"]]=="Died"|v[["OUT"]]=="LOSTFU") & substr(v[["studycode"]],1,4)=="28TB"){
    last_time = as.Date(v[["DateLastASS"]],format="%m/%d/%Y") - as.Date(v[["STDAT"]],format="%m/%d/%Y")
  }
  else if (last_convert_time_point != "censor" & substr(v[["studycode"]],1,4)=="29TB") {
    culture_day = paste("date",substr(last_convert_time_point, nchar(last_convert_time_point)-3,nchar(last_convert_time_point)),sep = "")
    last_time = as.Date(v[[culture_day]],format="%m/%d/%Y") - as.Date(v[["date.N0"]],format="%m/%d/%Y")
  }
  else if (last_convert_time_point != "censor" & substr(v[["studycode"]],1,4)=="28TB") {
    culture_day = paste("date",substr(last_convert_time_point, nchar(last_convert_time_point)-3,nchar(last_convert_time_point)),sep = "")
    last_time = as.Date(v[[culture_day]],format="%m/%d/%Y") - as.Date(v[["STDAT"]],format="%m/%d/%Y")
  }
  return(last_time)
}


for (i in 1:nrow(sputum_clean)){
  #print(i)
  row_data = sputum_clean[i,]
  last_convert_time_point= Timetoconvert_last(row_data)
  sputum_clean$Last_Culture_conversion[i] = last_convert_time_point
  sputum_clean$last_time_convert[i] = last_days_to_convert(last_convert_time_point,row_data)
}


## function for check time to conversion for 28TB at 8M
### function aims to check index of each timepoint with  tp < 10000 conversion, tp = 10000 no conversion or censor
### censor means there is no event (conversion) happening during this given period.
### for 28TB conversion if 2 consecutive negative culture which are at least 1 month apart (calculate until T09 timepoint for both regimen)
### for 29TB, conversion is negative culture at that timepoint after at least 1 month of treatment. (calculate until T06 for regimen 6M, T08 for 8M )
TimePointChecker_28TB <-function(pos1, v){
  tp = 10000
  pos = pos1
  stopifnot(pos <= length(v))
  if(v[[pos]] == 'Negative'){
    while(pos < length(v)){
      pos = pos + 1
      if(v[[pos]] == 'Negative'){
        tp = pos1
        break
      }
      
      if(v[[pos]] == 'Positive'){
        break
      }
    }
  }
  return(tp)
}


### function 2 return to earliest conversion timepoint
CheckForIndividual_28TB <- function(v){
  record = c()
  for(p in 1:length(v)){
    temp = TimePointChecker_28TB(p,v)
    record = c(record,temp)
  }
  Index_TP <- min(record)
  if(Index_TP < 10000) time_point <- colnames(v)[Index_TP]
  if(Index_TP == 10000) time_point <- "censor"
  return(time_point)

}


## function check time conversion for 29TB
### function 1 check index of each time point < 10000 conversion, = 10000 no conversion or censor
TimePointChecker_29TB <-function(pos1, v){
  tp = 10000
  pos = pos1
  stopifnot(pos <= length(v))
  if(v[[pos]] == 'Negative'){
    tp = pos1
  }
  return(tp)
}

### function 2 return to earliest conversion timepoint
CheckForIndividual_29TB <- function(v){
  record = c()
  for(p in 1:length(v)){
    temp = TimePointChecker_29TB(p,v)
    record = c(record,temp)
  }
  Index_TP <- min(record)
  if(Index_TP < 10000) time_point <- colnames(v)[Index_TP]
  if(Index_TP == 10000) time_point = "censor"
  return(time_point)
}

##### Final function each patient
##### in this function for 28TB, if the culture for T02 is positive, we will take the input from Culture.T02 to Culture.T09 
##### in order to avoid cases in which Culture.N14 and CUlture.T01 negative. This is because we require two cultures negative which are apart at least 1 months.
##### for 29TB we choose the input from Culture.N14 to Culture.T06 or Culture.N14 to Culture.T08 in order to avoid the cases in which
##### Culture.N0 is Negative and Culture.N14 is positive. Because in this case the function "Timetoconvert" will return the timepoint Culture.N0 and this 
##### will causes error later.

Timetoconvert <- function(row_data) {
  Convert_result = NA
  if (is.na(row_data[["Regimen"]]) | "Positive" %nin% c(row_data[["Culture.N0"]], row_data[["Culture.N14"]])) {
    Convert_result = NA
  }
  else if (substr(row_data[["studycode"]],1,4)=="29TB" & row_data[["Regimen"]]=="6M") {
    row_data_culture = row_data[which(colnames(row_data)=="Culture.N14"):which(colnames(row_data)=="Culture.T06")]
    Convert_result = CheckForIndividual_29TB(row_data_culture)
    }
  else if (substr(row_data[["studycode"]],1,4)=="29TB" & row_data[["Regimen"]]=="8M") {
    row_data_culture = row_data[which(colnames(row_data)=="Culture.N14"):which(colnames(row_data)=="Culture.T08")]
    Convert_result = CheckForIndividual_29TB(row_data_culture)
    }
  else if (substr(row_data[["studycode"]],1,4)=="28TB" & row_data[["Regimen"]]=="9M") {
    row_data_culture = row_data[which(colnames(row_data)=="Culture.N14"):which(colnames(row_data)=="Culture.T09")]
    if(row_data["Culture.T02"]=="Positive") row_data_culture = row_data[which(colnames(row_data)=="Culture.T02"):which(colnames(row_data)=="Culture.T09")]
    Convert_result = CheckForIndividual_28TB(row_data_culture)
    }
  else if (substr(row_data[["studycode"]],1,4)=="28TB" & row_data[["Regimen"]]=="20M") {
    row_data_culture = row_data[which(colnames(row_data)=="Culture.N14"):which(colnames(row_data)=="Culture.T09")]
    if(row_data["Culture.T02"]=="Positive") row_data_culture = row_data[which(colnames(row_data)=="Culture.T02"):which(colnames(row_data)=="Culture.T09")]
    Convert_result = CheckForIndividual_28TB(row_data_culture)
    }
  return(Convert_result)
}

days_to_convert <- function(convert_time_point,v){
  if(is.na(convert_time_point)){
    time = NA
  }
  else if (convert_time_point == "censor" & is.na(v[["OUT"]])){
    time = 600
  }
  else if (convert_time_point == "censor" & v[["OUT"]]!="Died" & v[["OUT"]]!="LOSTFU"){
    time = 600
  }
  else if (convert_time_point == "censor" & (v[["OUT"]]=="Died"|v[["OUT"]]=="LOSTFU") & substr(v[["studycode"]],1,4)=="29TB"){
    time = as.Date(v[["DateLastASS"]],format="%m/%d/%Y") - as.Date(v[["date.N0"]],format="%m/%d/%Y")
    #if (time > 240) time = 240
  }
  else if (convert_time_point == "censor" & (v[["OUT"]]=="Died"|v[["OUT"]]=="LOSTFU") & substr(v[["studycode"]],1,4)=="28TB"){
    time = as.Date(v[["DateLastASS"]],format="%m/%d/%Y") - as.Date(v[["STDAT"]],format="%m/%d/%Y")
    #if (time > 240) time = 240
  }
  else if (convert_time_point != "censor" & substr(v[["studycode"]],1,4)=="29TB") {
    culture_day = paste("date",substr(convert_time_point, nchar(convert_time_point)-3,nchar(convert_time_point)),sep = "")
    time = as.Date(v[[culture_day]],format="%m/%d/%Y") - as.Date(v[["date.N0"]],format="%m/%d/%Y")
  }
  else if (convert_time_point != "censor" & substr(v[["studycode"]],1,4)=="28TB") {
    culture_day = paste("date",substr(convert_time_point, nchar(convert_time_point)-3,nchar(convert_time_point)),sep = "")
    time = as.Date(v[[culture_day]],format="%m/%d/%Y") - as.Date(v[["STDAT"]],format="%m/%d/%Y")
  }
  return(time)
}


# i=341
# sputum_clean[341,]
# row_data = sputum_clean[i,]
# convertion_time_point= Timetoconvert(row_data)
# # sputum_clean$First_conversion[i] = convertion_time_point
# days_to_convert(convertion_time_point,row_data)

## run conversion function for all patients
for (i in 1:nrow(sputum_clean)){
  row_data = sputum_clean[i,]
  convertion_time_point= Timetoconvert(row_data)
  sputum_clean$First_conversion[i] = convertion_time_point
  sputum_clean$Time[i] = days_to_convert(convertion_time_point,row_data)
  #print(i)
}


#------- function for calculate time at which patients stop producing sputum----

Time_stop_sputum <-function(pos, v){
  tp = 10000
  stopifnot(pos <= length(v))
  if(!is.na(v[[pos]]) & v[[pos]] == 'no sputum' & "Positive" %nin% as.character(v[-c(1:pos)]) & 
     "Negative" %nin% as.character(v[-c(1:pos)])){
    tp = pos
  }
  return(tp)
}


Time_stop_sputum_for_individual <- function(v){
  record = c()
  for(p in 1:length(v)){
    temp = Time_stop_sputum(p,v)
    record = c(record,temp)
  }
  Index_TP <- min(record)
  if(Index_TP < 10000) time_point <- colnames(v)[Index_TP-1]  ## 1 timepoint previous
  if(Index_TP == 10000) time_point <- "non-stop"
  #print(record)
  return(time_point)
}

Time_point_to_stop_sputum <- function(row_data) {
  stop_result = NA
  if(substr(row_data[["studycode"]],1,4)=="29TB"){
    row_data_culture = row_data[which(colnames(row_data)=="Culture.N0"):which(colnames(row_data)=="Culture.T12")]
    stop_result = Time_stop_sputum_for_individual(row_data_culture)
  }
  else if (substr(row_data[["studycode"]],1,4)=="28TB"){
    row_data_culture = row_data[which(colnames(row_data)=="Culture.N0"):which(colnames(row_data)=="Culture.T24")]
    stop_result = Time_stop_sputum_for_individual(row_data_culture)
  }
  return(stop_result)
}

## run conversion function for all patients
for (i in 1:nrow(sputum_clean)){
  row_data = sputum_clean[i,]
  time_temp = Time_point_to_stop_sputum(row_data)
  sputum_clean$follow_up_timepoint[i] = time_temp
}


##-------------------- fucntion to calculate reversion
check_reversion_timepoint <- function(pos,v){
  if(substr(v[["studycode"]],1,4)=="29TB"){
    v1 = v[which(colnames(v)=="Culture.N0"):which(colnames(v)=="Culture.T12")]
  }
  else if(substr(v[["studycode"]],1,4)=="28TB"){
    v1 = v[which(colnames(v)=="Culture.N0"):which(colnames(v)=="Culture.T24")]
  }
  check = v1[-c(1:which(colnames(v1)==conversion))]
  temp_t = "No"
  for (t in 1:length(check)){
    if(check[t] == "Positive"){
      temp_t = colnames(check)[t]
      break
    }
  }
  return(temp_t)
}

## fill in sputum data and calculate time
for(i in 1:nrow(sputum_clean)){
  temp_row = sputum_clean[i,]
  conversion = temp_row$First_conversion
  temp_reversion = NA
  if(is.na(conversion)|conversion=="censor"){
    temp_reversion = "censor"
  } 
  else {
    temp_reversion <- check_reversion_timepoint(conversion,temp_row)
  }
  sputum_clean$reversion[i] <- temp_reversion
  date_return = NA
  if(temp_reversion %nin% c("censor", "No")  & substr(temp_row[["studycode"]],1,4)=="29TB"){
    reversion_date = paste("date",substr(temp_reversion, nchar(temp_reversion)-3,nchar(temp_reversion)),sep = "")
    date_return = as.Date(temp_row[[reversion_date]],format="%m/%d/%Y") - as.Date(temp_row[["date.N0"]],format="%m/%d/%Y")
  }
  if(temp_reversion %nin% c("censor", "No")  & substr(temp_row[["studycode"]],1,4)=="28TB"){
    reversion_date = paste("date",substr(temp_reversion, nchar(temp_reversion)-3,nchar(temp_reversion)),sep = "")
    date_return = as.Date(temp_row[[reversion_date]],format="%m/%d/%Y") - as.Date(temp_row[["STDAT"]],format="%m/%d/%Y")
  }
  sputum_clean$reversion_date[i] <- date_return
}

sputum_clean_sub <- sputum_clean %>% dplyr::select(studycode, EnrolledDAT, Regimen, STDAT, DateLastASS, DateLastALIVE, OUT, DateDeath, DateLastFU, First_conversion)

### rename
setnames(x=sputum,
         old = c("studycode", "SampleNumber", "DateSample", "DateMgit", "MgitCulture", "Archive", "DateLJ_Pos", "LJ_Result", "ZN"),
         new = c("id", "sid", "date_sample", "date_mgit", "mgit_cul", "archive", "dateLJ_pos", "LJ_result", "ZN"))

setnames(x=sputum_clean_sub,
         old = c("studycode", "EnrolledDAT", "Regimen", "STDAT", "DateLastASS", "DateLastALIVE", "OUT", "DateDeath", "DateLastFU", "First_conversion"),
         new = c("id", "date_enroll", "regimen", "date_start", "date_lastass", "date_lastalive", "out", "date_death", "date_lastfu", "first_conversion"))

setnames(x=outcome,
         old = c("studycode", "EnrolledDAT", "Regimen", "STDAT", "DateLastASS", "DateLastALIVE", "OUT", "DateDeath", "DateLastFU"),
         new = c("id", "date_enroll", "regimen", "date_start", "date_lastass", "date_lastalive", "out", "date_death", "date_lastfu"))

### format date
sputum$date_sample <- as.Date(as.numeric(sputum$date_sample), origin="1899-12-30")
sputum$date_mgit <- as.Date(as.numeric(sputum$date_mgit), origin="1899-12-30")
sputum$dateLJ_pos <- as.Date(as.numeric(sputum$dateLJ_pos), origin="1899-12-30")
outcome$date_enroll <- as.Date(as.numeric(outcome$date_enroll), origin="1899-12-30")
outcome$date_start <- as.Date(as.numeric(outcome$date_start), origin="1899-12-30")
outcome$date_lastass <- as.Date(as.numeric(outcome$date_lastass), origin="1899-12-30")
outcome$date_lastalive <- as.Date(as.numeric(outcome$date_lastalive), origin="1899-12-30")
outcome$date_death <- as.Date(as.numeric(outcome$date_death), origin="1899-12-30")
outcome$date_lastfu <- as.Date(as.numeric(outcome$date_lastfu), origin="1899-12-30")
sputum_clean_sub$date_enroll <- as.Date(as.numeric(sputum_clean_sub$date_enroll), origin="1899-12-30")
sputum_clean_sub$date_start <- as.Date(as.numeric(sputum_clean_sub$date_start), origin="1899-12-30")
sputum_clean_sub$date_lastass <- as.Date(as.numeric(sputum_clean_sub$date_lastass), origin="1899-12-30")
sputum_clean_sub$date_lastalive <- as.Date(as.numeric(sputum_clean_sub$date_lastalive), origin="1899-12-30")
sputum_clean_sub$date_death <- as.Date(as.numeric(sputum_clean_sub$date_death), origin="1899-12-30")
sputum_clean_sub$date_lastfu <- as.Date(as.numeric(sputum_clean_sub$date_lastfu), origin="1899-12-30")

sputum$date_sample <- ymd(sputum$date_sample)
sputum$date_mgit <- ymd(sputum$date_mgit)
sputum$dateLJ_pos <- ymd(sputum$dateLJ_pos)
outcome$date_enroll <- ymd(outcome$date_enroll)
outcome$date_start <- ymd(outcome$date_start)
outcome$date_lastass <- ymd(outcome$date_lastass)
outcome$date_lastalive <- ymd(outcome$date_lastalive)
outcome$date_death <- ymd(outcome$date_death)
outcome$date_lastfu <- ymd(outcome$date_lastfu)
sputum_clean_sub$date_enroll <- ymd(sputum_clean_sub$date_enroll)
sputum_clean_sub$date_start <- ymd(sputum_clean_sub$date_start)
sputum_clean_sub$date_lastass <- ymd(sputum_clean_sub$date_lastass)
sputum_clean_sub$date_lastalive <- ymd(sputum_clean_sub$date_lastalive)
sputum_clean_sub$date_death <- ymd(sputum_clean_sub$date_death)
sputum_clean_sub$date_lastfu <- ymd(sputum_clean_sub$date_lastfu)

sputum <- unique(sputum, by = c("id")) %>%
  mutate(ZN=na_if(ZN, "KO LAM"),
         ZN=dplyr::recode(ZN, "positive"="Positive"),
         smearstat=NA,
         smearstat=ifelse(ZN=="Negative", 0, ifelse(ZN=="Positive", 1, smearstat)),
         smearstat=factor(smearstat, levels = c(0,1), labels = c("Negative", "Positive")),
         LJ_result=na_if(LJ_result, "="),
         LJ_result=ifelse(LJ_result=="Contamination", "Neg", LJ_result),
         culturestat=NA,
         culturestat=ifelse(LJ_result=="Neg", 0, ifelse(LJ_result=="Pos", 1, culturestat)),
         culturestat=factor(culturestat, levels = c(0,1), labels = c("Negative", "Positive")))

## export sputum clean to csv with name including today
#today <- format(Sys.Date(), "%b_%d_%Y")
#output_file = sprintf("sputum_conversion_today_%s.csv",today)
#write.csv(sputum_clean, output_file)

all2_new <- all2_new2 %>%
  mutate(age10=age/10,
         age10=as.numeric(age10),
         age_group=NA,
         age_group=ifelse(age<11, 0,
                          ifelse(age>=11 & age<21, 1,
                                 ifelse(age>=21 & age<31, 2,
                                        ifelse(age>=31 & age<41, 3,
                                               ifelse(age>=41 & age<51, 4,
                                                      ifelse(age>=51 & age<61, 5,
                                                             ifelse(age>=61 & age<71, 6,
                                                                    ifelse(age>=71 & age<81, 7,
                                                                           ifelse(age>=81 & age<91, 8,
                                                                                  ifelse(age>=91, 9, age_group)))))))))),
         age_group=factor(age_group, levels = c(0,1,2,3,4,5,6,7,8,9), labels = c("0-10", "11-20", "21-30", "31-40", "41-50", "51-60", "61-70", "71-80", "81-90", "91-100")))
#%>%
#  merge(sputum %>% dplyr::select(id, smearstat, culturestat), by="id") %>%
#  merge(sputum_clean_sub %>% dplyr::select(id, date_enroll, date_start, date_lastass, date_lastalive, out, date_death, date_lastfu, first_conversion), by="id")
```

# Characteristics of participants by lineage

## Germany

```{r, warning=FALSE}
table1_germany <- all2_new %>% dplyr::filter(country=="germany") %>% 
  dplyr::select(pulmonary, sex, age, age_group, dm, hiv, timika, cavity, mdr, country, immi, lin1234) 

t1_germany <- tbl_summary(
    table1_germany,
    by = lin1234, # split table by group
    percent = "row",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  #add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()
t1_germany
```

## Vietnam

```{r, warning=FALSE}
table1_vietnam <- all2_new %>% dplyr::filter(country=="vietnam") %>% 
  dplyr::select(pulmonary, sex, age, age_group, hiv, timika, cavity, mdr, country, immi, lin1234)

t1_vietnam <- tbl_summary(
    table1_vietnam,
    by = lin1234, # split table by group
    percent = "row",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  #add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()
t1_vietnam
```

## Indonesia

```{r, warning=FALSE}
table1_indo <- all2_new %>% dplyr::filter(country=="indonesia") %>% 
  dplyr::select(pulmonary, sex, age, age_group, dm, hiv, timika, cavity, mdr, country, immi, lin1234)

t1_indo <- tbl_summary(
    table1_indo,
    by = lin1234, # split table by group
    percent = "row",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  #add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()
t1_indo
```

## UK

```{r, warning=FALSE}
table1_uk <- all2_new %>% dplyr::filter(country=="uk") %>% 
  dplyr::select(pulmonary, sex, country, immi, timika, lin1234)

t1_uk <- tbl_summary(
    table1_uk,
    by = lin1234, # split table by group
    percent = "row",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  #add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()
t1_uk
```

## Italy

```{r, warning=FALSE}
table1_italy <- all2_new %>% dplyr::filter(country=="italy") %>% 
  dplyr::select(pulmonary, sex, age, age_group, hiv, timika, cavity, mdr, country, immi, lin1234)

t1_italy <- tbl_summary(
    table1_italy,
    by = lin1234, # split table by group
    percent = "row",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  #add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()
t1_italy
```

## Peru

```{r, warning=FALSE}
table1_peru <- all2_new %>% dplyr::filter(country=="peru") %>% 
  dplyr::select(pulmonary, sex, age, age_group, dm, hiv, timika, cavity, mdr, country, immi, lin1234)

t1_peru <- tbl_summary(
    table1_peru,
    by = lin1234, # split table by group
    percent = "row",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  #add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()
t1_peru
```

## South Africa

```{r, warning=FALSE}
table1_sf <- all2_new %>% dplyr::filter(country=="southafrica") %>% 
  dplyr::select(pulmonary, sex, age, age_group, hiv, timika, cavity, mdr, country, immi, lin1234)

t1_sf <- tbl_summary(
    table1_sf,
    by = lin1234, # split table by group
    percent = "row",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  #add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()
t1_sf
```

## China

```{r, warning=FALSE}
table1_china <- all2_new %>% dplyr::filter(country=="china") %>% 
  dplyr::select(pulmonary, sex, age, age_group, dm, hiv, timika, cavity, mdr, country, immi, lin1234)

t1_china <- tbl_summary(
    table1_china,
    by = lin1234, # split table by group
    percent = "row",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  #add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()
t1_china
```

# Lineage and pulmonary TB controlling for additional variables

## Germany

```{r, message=FALSE, warning=FALSE}
lin_pul_germany <- all2_new %>% filter(country=="germany") %>%
  dplyr::select(lineage, pulmonary, age, age10, dm, hiv, immi) %>% 
  filter(!is.na(lineage) & !is.na(pulmonary) & !is.na(age10) & !is.na(dm) & !is.na(hiv) & !is.na(immi))
  
t12 <- tbl_summary(
    lin_pul_germany,
    by = pulmonary, # split table by group
    percent = "row",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

mod2_germany <- glm(pulmonary ~ lineage + rcs(age10,3) + dm + hiv + immi, lin_pul_germany, family = binomial(link="logit"))
t13 <- tbl_regression(mod2_germany, exponentiate = TRUE, pvalue_fun=~style_pvalue(.x,digits=3)) #%>% add_global_p()

# merge sample description and outcome
tbl_merge_ex2 <-
  tbl_merge(
    tbls = list(t12, t13),
    tab_spanner = c("**Sample**", "**Regression**")
  )

tbl_merge_ex2

```

```{r}
library(gam)
gam_logistic = gam(pulmonary ~ lineage + s(age, 3) + dm + hiv + immi, family = binomial, data = lin_pul_germany)
par(mfrow=c(1,3))
plot(gam_logistic, se = TRUE, col = "green")
summary(gam_logistic)
```

## Vietnam

```{r, message=FALSE, warning=FALSE}
lin_pul_vietnam <- all2_new %>% filter(country=="vietnam") %>% 
  dplyr::select(lineage, pulmonary, country, age, age10, immi) %>% 
  filter(!is.na(lineage) & !is.na(pulmonary) & !is.na(age10) & !is.na(immi))
t12 <- tbl_summary(
    lin_pul_vietnam,
    by = pulmonary, # split table by group
    percent = "row",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

mod2_vietnam <- glm(pulmonary ~ lineage + rcs(age10,3), lin_pul_vietnam, family = binomial(link="logit"))
t13 <- tbl_regression(mod2_vietnam, exponentiate = TRUE, pvalue_fun=~style_pvalue(.x,digits=3)) #%>% add_global_p()

# merge sample description and outcome
tbl_merge_ex2 <-
  tbl_merge(
    tbls = list(t12, t13),
    tab_spanner = c("**Sample**", "**Regression**")
  )

tbl_merge_ex2
```

```{r}
library(gam)
gam_logistic = gam(pulmonary ~ lineage + s(age, 3), family = binomial, data = lin_pul_vietnam)
par(mfrow=c(1,3))
plot(gam_logistic, se = TRUE, col = "green")
summary(gam_logistic)
```

```{r, message=FALSE, warning=FALSE}
lin_pul_vietnam_sen <- all2_new %>% filter(country=="vietnam") %>% 
  dplyr::select(lineage, pulmonary, country, age, age10, immi, study) %>% 
  filter(!is.na(lineage) & !is.na(pulmonary) & !is.na(age10) & !is.na(immi) & study!="26TB")
t12 <- tbl_summary(
    lin_pul_vietnam_sen,
    by = pulmonary, # split table by group
    percent = "row",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

mod2_vietnam <- glm(pulmonary ~ lineage + rcs(age10,3), lin_pul_vietnam_sen, family = binomial(link="logit"))
t13 <- tbl_regression(mod2_vietnam, exponentiate = TRUE, pvalue_fun=~style_pvalue(.x,digits=3)) #%>% add_global_p()

# merge sample description and outcome
tbl_merge_ex2 <-
  tbl_merge(
    tbls = list(t12, t13),
    tab_spanner = c("**Sample**", "**Regression**")
  )

tbl_merge_ex2
```

## Indonesia

```{r, message=FALSE, warning=FALSE}
lin_pul_indo <- all2_new %>% filter(country=="indonesia") %>% 
  dplyr::select(lineage, pulmonary, country, age, age10, dm, hiv, immi) %>% 
  filter(!is.na(lineage) & !is.na(pulmonary) & !is.na(age10) & !is.na(dm) & !is.na(hiv) & !is.na(immi))
t12 <- tbl_summary(
    lin_pul_indo,
    by = pulmonary, # split table by group
    percent = "row",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

#mod2_indo <- glm(pulmonary ~ lineage + sex + age10 + dm + hiv, lin_pul_indo, family = binomial(link="logit"))
#t13 <- tbl_regression(mod2_indo, exponentiate = TRUE, pvalue_fun=~style_pvalue(.x,digits=2))

# Firth's correction
library(logistf)
mod2_indo_f <- logistf(pulmonary ~ lineage + rcs(age10,3) + dm + hiv, lin_pul_indo, family = binomial(link="logit"))
t13 <- tbl_regression(mod2_indo_f, exponentiate = TRUE, pvalue_fun=~style_pvalue(.x,digits=3)) #%>% add_global_p()

# merge sample description and outcome
tbl_merge_ex2 <-
  tbl_merge(
    tbls = list(t12, t13),
    tab_spanner = c("**Sample**", "**Regression**")
  )

tbl_merge_ex2
```

```{r}
library(gam)
gam_logistic = gam(pulmonary ~ lineage + s(age, 3) + dm + hiv, family = binomial, data = lin_pul_indo)
par(mfrow=c(1,3))
plot(gam_logistic, se = TRUE, col = "green")
summary(gam_logistic)
```

# Lineage and pulmonary TB controlling for immigration and age

## Germany

```{r, message=FALSE, warning=FALSE}
lin_pul_germany <- all2_new %>% filter(country=="germany") %>%
  dplyr::select(lineage, pulmonary, age10, immi) %>% 
  filter(!is.na(lineage) & !is.na(pulmonary) & !is.na(age10) & !is.na(immi))
  
t12 <- tbl_summary(
    lin_pul_germany,
    by = pulmonary, # split table by group
    percent = "row",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

mod2_germany <- glm(pulmonary ~ lineage + rcs(age10,3) + immi, lin_pul_germany, family = binomial(link="logit"))
t13 <- tbl_regression(mod2_germany, exponentiate = TRUE, pvalue_fun=~style_pvalue(.x,digits=3)) #%>% add_global_p()

# merge sample description and outcome
tbl_merge_ex2 <-
  tbl_merge(
    tbls = list(t12, t13),
    tab_spanner = c("**Sample**", "**Regression**")
  )

tbl_merge_ex2

require(rms)
theme_set(theme_bw())
dd <- datadist(lin_pul_germany)
options(datadist="dd")

fit <- lrm(pulmonary~lineage + rcs(age10,3) + immi, data=lin_pul_germany)
anova(fit)
pred <- rms::Predict(fit, age10=min(lin_pul_germany$age10):max(lin_pul_germany$age10), lineage=NA, immi=NA, fun=plogis)
ggplot(pred, rdata=lin_pul_germany, ylab=expression(paste(hat(P),"(pulmonary)")),ylim=c(0,1), legend.position="top") +
  scale_color_discrete(name="Lineage") + 
  scale_x_continuous(name = "Age (x 10 years)") + 
  theme(text = element_text(size=15), axis.text.x = element_text(size=14), axis.text.y = element_text(size=14), legend.text=element_text(size=14)) + 
  geom_line(size=1.25) + 
  geom_ribbon(aes(ymin = pred$lower, ymax = pred$upper), alpha=0.05) + 
  annotate("text", x=5, y=0.85, label=paste0("p-value==",bquote(.(formatC(as.numeric(anova(fit)[12]),3,format="f")))), parse = TRUE)
ggsave("figures/lin_pul_germany.png", width = 7, height = 5)
```

## Vietnam

```{r, message=FALSE, warning=FALSE}
lin_pul_vietnam <- all2_new %>% filter(country=="vietnam") %>% 
  dplyr::select(lineage, pulmonary, country, age10, immi) %>% 
  filter(!is.na(lineage) & !is.na(pulmonary) & !is.na(age10) & !is.na(immi))
t12 <- tbl_summary(
    lin_pul_vietnam,
    by = pulmonary, # split table by group
    percent = "row",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

mod2_vietnam <- glm(pulmonary ~ lineage + rcs(age10,3), lin_pul_vietnam, family = binomial(link="logit"))
t13 <- tbl_regression(mod2_vietnam, exponentiate = TRUE, pvalue_fun=~style_pvalue(.x,digits=3)) #%>% add_global_p()

# merge sample description and outcome
tbl_merge_ex2 <-
  tbl_merge(
    tbls = list(t12, t13),
    tab_spanner = c("**Sample**", "**Regression**")
  )

tbl_merge_ex2
```

## Indonesia

```{r, message=FALSE, warning=FALSE}
lin_pul_indo <- all2_new %>% dplyr::select(lineage, pulmonary, country, age10, immi) %>% filter(country=="indonesia")
t12 <- tbl_summary(
    lin_pul_indo,
    by = pulmonary, # split table by group
    percent = "row",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

#mod2_indo <- glm(pulmonary ~ lineage + sex, lin_pul_indo, family = binomial(link="logit"))
#t13 <- tbl_regression(mod2_indo, exponentiate = TRUE, pvalue_fun=~style_pvalue(.x,digits=2))


# Firth's correction
library(logistf)
mod2_indo_f <- logistf(pulmonary ~ lineage + rcs(age10,3), lin_pul_indo, family = binomial(link="logit"))
t13 <- tbl_regression(mod2_indo_f, exponentiate = TRUE, pvalue_fun=~style_pvalue(.x,digits=3)) #%>% add_global_p()


# merge sample description and outcome
tbl_merge_ex2 <-
  tbl_merge(
    tbls = list(t12, t13),
    tab_spanner = c("**Sample**", "**Regression**")
  )

tbl_merge_ex2
```

## UK

```{r, message=FALSE, warning=FALSE}
lin_pul_uk <- all2_new %>% dplyr::select(lineage, pulmonary, country, immi) %>% filter(country=="uk")
t12 <- tbl_summary(
    lin_pul_uk,
    by = pulmonary, # split table by group
    percent = "row",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

mod2_uk <- glm(pulmonary ~ lineage + immi, lin_pul_uk, family = binomial(link="logit"))
t13 <- tbl_regression(mod2_uk, exponentiate = TRUE, pvalue_fun=~style_pvalue(.x,digits=3)) #%>% add_global_p()

# merge sample description and outcome
tbl_merge_ex2 <-
  tbl_merge(
    tbls = list(t12, t13),
    tab_spanner = c("**Sample**", "**Regression**")
  )

tbl_merge_ex2
```

## UK, set age in UK as mean age Germany

```{r, message=FALSE, warning=FALSE}
lin_pul_uk <- all2_new %>%
  dplyr::select(lineage, pulmonary, country, immi, age10) %>%
  mutate(immi=factor(immi, levels = c(0,1), labels = c("Non-immigration", "Immigration")),
         age10=ifelse(country=="uk", mean(age10[country=="germany"]), age10)) %>%
  dplyr::select(lineage, pulmonary, country, immi, age10) %>% filter(country=="uk")
t12 <- tbl_summary(
    lin_pul_uk,
    by = pulmonary, # split table by group
    percent = "row",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

mod2_uk <- glm(pulmonary ~ lineage + immi + age10, lin_pul_uk, family = binomial(link="logit"))
t13 <- tbl_regression(mod2_uk, exponentiate = TRUE, pvalue_fun=~style_pvalue(.x,digits=3)) #%>% add_global_p()

# merge sample description and outcome
tbl_merge_ex2 <-
  tbl_merge(
    tbls = list(t12, t13),
    tab_spanner = c("**Sample**", "**Regression**")
  )

tbl_merge_ex2
```

## All countries

```{r, message=FALSE, warning=FALSE}
#install.packages("labelled")
# install.packages("labelled",dependencies = TRUE)
# install.packages("Rcpp")
# library(labelled)
lin_pul <- all2_new %>% dplyr::select(lineage, pulmonary, country, immi) %>% 
  dplyr::filter(country %in% c("germany", "uk", "vietnam", "indonesia")) %>% 
  mutate(immi=factor(immi, levels = c(0,1), labels = c("Non-immigration", "Immigration"))) %>%
  filter(!is.na(lineage) & !is.na(pulmonary) & !is.na(immi))
t12 <- tbl_summary(
    lin_pul,
    by = pulmonary, # split table by group
    percent = "row",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

mod2_all <- glm(pulmonary ~ lineage + country + immi, lin_pul, family = binomial(link="logit"))
t13 <- tbl_regression(mod2_all, exponentiate = TRUE, pvalue_fun=~style_pvalue(.x,digits=3)) #%>% add_global_p()

# merge sample description and outcome
tbl_merge_ex2 <-
  tbl_merge(
    tbls = list(t12, t13),
    tab_spanner = c("**Sample**", "**Regression**")
  )

tbl_merge_ex2

```

## All countries, including age, including UK, set age in UK as mean age Germany

```{r, message=FALSE, warning=FALSE}
#install.packages("labelled")
# install.packages("labelled",dependencies = TRUE)
# install.packages("Rcpp")
# library(labelled)
lin_pul <- all2_new %>% dplyr::select(lineage, pulmonary, country, immi, age10) %>% 
  dplyr::filter(country %in% c("germany", "uk", "vietnam", "indonesia")) %>% 
  mutate(immi=factor(immi, levels = c(0,1), labels = c("Non-immigration", "Immigration")),
         age10=ifelse(country=="uk", mean(age10[country=="germany"]), age10)) %>%
  filter(!is.na(lineage) & !is.na(pulmonary) & !is.na(immi) & !is.na(age10))
t12 <- tbl_summary(
    lin_pul,
    by = pulmonary, # split table by group
    percent = "row",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

mod2_all <- glm(pulmonary ~ lineage + country + immi + rcs(age10, 3), lin_pul, family = binomial(link="logit"))
t13 <- tbl_regression(mod2_all, exponentiate = TRUE, pvalue_fun=~style_pvalue(.x,digits=3)) %>% add_global_p()

# merge sample description and outcome
tbl_merge_ex2 <-
  tbl_merge(
    tbls = list(t12, t13),
    tab_spanner = c("**Sample**", "**Regression**")
  )

tbl_merge_ex2

```

## Forest plot

```{r, results='hide', message=FALSE, warning=FALSE}
exp(coef(mod2_germany))
exp(coef(mod2_indo_f))
exp(coef(mod2_uk))
exp(coef(mod2_vietnam))
exp(coef(mod2_all))

exp(confint(mod2_germany))
exp(confint(mod2_indo_f))
exp(confint(mod2_uk))
exp(confint(mod2_vietnam))
exp(confint(mod2_all))
```

```{r, warning=FALSE}
library(forestplot)

data_lin_pul <- data.frame(
  lineage=c("Lineage 2: Germany", "Lineage 2: Indonesia", "Lineage 2: UK", "Lineage 2: Vietnam", "Lineage 2: Combined",
            "Lineage 3: Germany", "Lineage 3: Indonesia", "Lineage 3: UK", "Lineage 3: Vietnam", "Lineage 3: Combined",
            "Lineage 4: Germany", "Lineage 4: Indonesia", "Lineage 4: UK", "Lineage 4: Vietnam", "Lineage 4: Combined"),
  group=rep(c("Germany", "Indonesia", "UK", "Vietnam", "Combined"), 3),
  result=c("5.01 (1.47; 20.1) *", "0.50 (0.05; 2.12)", "2.21 (1.31; 3.81) **", "1.70 (1.38; 2.09) ***", "1.79 (1.49; 2.15) ***",
           "1.78 (0.67; 4.62)", "", "1.51 (1.11; 2.07) **", "", "1.40 (1.09; 1.79) **",
           "3.14 (1.29; 7.09) ***", "0.48 (0.05; 2.00)", "2.19 (1.59; 3.04) ***", "2.43 (1.66; 3.63) ***", "2.04 (1.65; 2.53) ***"),
  OR=c(5.01, 0.50, 2.21, 1.70, 1.79,
       1.78, NA, 1.51, NA, 1.40,
       3.14, 0.48, 2.19, 2.43, 2.04),
  Lower=c(1.47, 0.05, 1.31, 1.38, 1.49,
          0.67, NA, 1.11, NA, 1.09,
          1.29, 0.05, 1.59, 1.66, 1.65),
  Upper=c(20.1, 2.12, 3.81, 2.09, 2.15,
          4.62, NA, 2.07, NA, 1.79,
          7.09, 2.00, 3.04, 3.63, 2.53)
)
```

```{r, message=FALSE,warning=FALSE}
library(dplyr)

legend_title <- "Country"

plot_lin_pul <- data_lin_pul %>% 
  mutate(Upper = replace(Upper, abs(Upper) > 50, NA),
         Lower = replace(Lower, abs(Lower) > 50, NA),
         OR = replace(OR, abs(OR) > 50, NA),
         lineage = factor(gsub(":.*$", "", lineage))) %>%
  ggplot(aes(x = OR, 
             y = factor(group, levels = c("Combined", "Vietnam", "UK", "Indonesia", "Germany")),
             shape = factor(group, levels = c("Combined", "Vietnam", "UK", "Indonesia", "Germany")),
             color = factor(group, levels = c("Combined", "Vietnam", "UK", "Indonesia", "Germany")))) + 
  #geom_rect(aes(xmin = 0.001, xmax = 100,
  #              ymin = -Inf, ymax = Inf, fill = lineage)) +
  geom_errorbarh(aes(xmin = Lower, xmax = Upper)) +
  geom_text(aes(x=0.1,label=result),size=7, position = position_dodge(0.9), vjust = -0.2) +
  geom_point(size = 3) +
  geom_vline(aes(xintercept = 1), linetype = 2) +
  geom_hline(aes(yintercept = 5.5), linetype = "dotted", color="black") +
  xlab("OR (95% CIs)") +
  ylab("") +
  scale_shape_manual(values = c(1,2,8,5,6), name="Country", labels = c("Combined", "Vietnam", "UK", "Indonesia", "Germany")) +
  scale_color_manual(values = c(1,2,8,5,6), name="Country", labels = c("Combined", "Vietnam", "UK", "Indonesia", "Germany")) +
  scale_x_log10(breaks=c(0.1,0.32,1,3.16,10,31.6)) +
  #coord_cartesian(xlim = c(0.01, 100)) +
  facet_grid(lineage~., switch = "y") +
  theme_bw() +
  theme(panel.spacing.y = unit(0, "points"),
        panel.border = element_blank(),
        text = element_text(size=24),
        axis.text.y = element_blank(),
        axis.text.x = element_text(size=20),
        legend.text = element_text(size=20),
        legend.title = element_text(size=20),
        legend.position = "bottom",
        #legend.box = "horizontal",
        axis.title = element_text(size=20),
        axis.ticks.length.y = unit(0, "points"),
        strip.text.y.left = element_text(angle = 0),
        strip.background.y = element_blank(),
        strip.placement = "outside",
        axis.line = element_line()
        ) +
  guides(color = guide_legend(nrow = 1), shape = guide_legend(nrow = 1)) +
  labs(caption = "*p<0.05, **p<0.01, ***p<0.001") +
  ggtitle("Pulmonary vs. extra-pulmonary TB, by lineage and country")

plot_lin_pul
ggsave("Figure3_lin_pul.png")
```

## All countries including age, excluding UK

```{r, message=FALSE, warning=FALSE}
#install.packages("labelled")
# install.packages("labelled",dependencies = TRUE)
# install.packages("Rcpp")
# library(labelled)
lin_pul2 <- all2_new %>% dplyr::select(lineage, pulmonary, country, immi, age10) %>% 
  dplyr::filter(country %in% c("germany", "vietnam", "indonesia")) %>% 
  mutate(immi=factor(immi, levels = c(0,1), labels = c("Non-immigration", "Immigration"))) %>%
  filter(!is.na(lineage) & !is.na(pulmonary) & !is.na(immi) & !is.na(age10))

t12 <- tbl_summary(
    lin_pul2,
    by = pulmonary, # split table by group
    percent = "row",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

mod2_all <- glm(pulmonary ~ lineage + country + immi + rcs(age10, 3), lin_pul2, family = binomial(link="logit"))
t13 <- tbl_regression(mod2_all, exponentiate = TRUE, pvalue_fun=~style_pvalue(.x,digits=3)) #%>% add_global_p()

# merge sample description and outcome
tbl_merge_ex2 <-
  tbl_merge(
    tbls = list(t12, t13),
    tab_spanner = c("**Sample**", "**Regression**")
  )

tbl_merge_ex2

```

## All countries excluding age, excluding UK

```{r, message=FALSE, warning=FALSE}
#install.packages("labelled")
# install.packages("labelled",dependencies = TRUE)
# install.packages("Rcpp")
# library(labelled)
lin_pul2 <- all2_new %>% dplyr::select(lineage, pulmonary, country, immi) %>% 
  dplyr::filter(country %in% c("germany", "vietnam", "indonesia")) %>% 
  mutate(immi=factor(immi, levels = c(0,1), labels = c("Non-immigration", "Immigration"))) %>%
  filter(!is.na(lineage) & !is.na(pulmonary) & !is.na(immi))

t12 <- tbl_summary(
    lin_pul2,
    by = pulmonary, # split table by group
    percent = "row",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

mod2_all <- glm(pulmonary ~ lineage + country + immi, lin_pul2, family = binomial(link="logit"))
t13 <- tbl_regression(mod2_all, exponentiate = TRUE, pvalue_fun=~style_pvalue(.x,digits=3)) %>% add_global_p()

# merge sample description and outcome
tbl_merge_ex2 <-
  tbl_merge(
    tbls = list(t12, t13),
    tab_spanner = c("**Sample**", "**Regression**")
  )

tbl_merge_ex2

```

## All countries, including age, excluding UK, replace mean age in Germany

```{r, message=FALSE, warning=FALSE}
#install.packages("labelled")
# install.packages("labelled",dependencies = TRUE)
# install.packages("Rcpp")
# library(labelled)
lin_pul2 <- all2_new %>% dplyr::select(lineage, pulmonary, country, immi, age10) %>% 
  dplyr::filter(country %in% c("germany", "vietnam", "indonesia")) %>% 
  mutate(immi=factor(immi, levels = c(0,1), labels = c("Non-immigration", "Immigration")),
         age10=ifelse(country=="germany", mean(age10[country=="germany"]), age10)) %>%
  filter(!is.na(lineage) & !is.na(pulmonary) & !is.na(immi) & !is.na(age10))

t12 <- tbl_summary(
    lin_pul2,
    by = pulmonary, # split table by group
    percent = "row",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

mod2_all <- glm(pulmonary ~ lineage + country + immi + rcs(age10, 3), lin_pul2, family = binomial(link="logit"))
t13 <- tbl_regression(mod2_all, exponentiate = TRUE, pvalue_fun=~style_pvalue(.x,digits=3)) %>% add_global_p()

# merge sample description and outcome
tbl_merge_ex2 <-
  tbl_merge(
    tbls = list(t12, t13),
    tab_spanner = c("**Sample**", "**Regression**")
  )

tbl_merge_ex2

```

## Set up dataset for simulation

```{r dummy dataset}
#library(dummies) #1 load the namespace of the package dummies and attach it on the search list
set.seed(666) #2 sets an arbitrary seed to make the results fully reproducible
n <- 6113 #3 defines sample size of the working sample
lineage<- as.factor(sample(x=c("Lineage 1", "Lineage 2", "Lineage 3", "Lineage 4"), #6 a factor variable with 4 levels
                           size=n, #7
                           replace=TRUE, #8 makes the sampling among the 4 levels with replacement
                           prob=c(0.1608048, 0.4001309, 0.1285784, 0.3104858))) #9 argument receives a vector of probability for sampling the 4 levels
lineage<-relevel(lineage, ref="Lineage 1") #10 makes the "Lineage 1" level as the base reference
country<- as.factor(sample(x = c("germany", "indonesia", "uk", "vietnam"), #11
                          size = n, #12
                          replace = TRUE, #13
                          prob = c(0.1100932, 0.1424832, 0.2704073, 0.4770162))) #14 argument is equivalent to assign a vector c(0.1100932, 0.1424832, 0.2704073, 0.4770162)
age<- round(rnorm(n,mean=40.36,sd=14.97736)) #5 generates age variable, which is normally distributed with mean 40.36, sd 14.97736
missing_index <- sample(1:n, 1653, replace = TRUE)
age[missing_index & country=="uk"]<-NA
age10<-age/10
immi<- as.factor(sample(x = c("Immigration", "Non-immigration"), #11
                          size = n, #12
                          replace = TRUE, #13
                          prob = c(0.2692622, 0.7307378))) #14 immigration
pulmonary<- rbinom(n = n, size = 1, prob = 4378/6113) # generates outcome variable Pulmonary TB which follows a binomial distribution

df <- data.frame(lineage, age10, country, immi, pulmonary) #21 combines all variables into a data frame
```

## Complete data

```{r, message=FALSE, warning=FALSE}
lin_pul <- df %>%
  mutate(
    immi=ifelse(immi=="Non-immigration", 0, 1),
    immi=factor(immi, levels = c(0,1), labels = c("Non-immigration", "Immigration")))
t12 <- tbl_summary(
    lin_pul,
    by = pulmonary, # split table by group
    percent = "row",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

mod2_all <- glm(pulmonary ~ lineage + country + immi + rcs(age10, 3), lin_pul, family = binomial(link="logit"))
t13 <- tbl_regression(mod2_all, exponentiate = TRUE, pvalue_fun=~style_pvalue(.x,digits=3)) %>% add_global_p()

# merge sample description and outcome
tbl_merge_ex2 <-
  tbl_merge(
    tbls = list(t12, t13),
    tab_spanner = c("**Sample**", "**Regression**")
  )

tbl_merge_ex2
```

## Imputed data

```{r, message=FALSE, warning=FALSE}
lin_pul <- df %>%
  mutate(
    immi=ifelse(immi=="Non-immigration", 0, 1),
    immi=factor(immi, levels = c(0,1), labels = c("Non-immigration", "Immigration")))

library(mice)
md.pattern(lin_pul)

# Creating imputations can be done with a call to mice() as follows:
data.imp50 <- mice(lin_pul, m = 50, method = "pmm")
# data.imp50 <- mice(lin_pul, m = 50, seed = 23109)
### Extract the "tall" matrix which stacks the imputations
data.comp <- complete(data.imp50, "long", include = TRUE) %>% na.omit()
head(data.comp)

t12 <- tbl_summary(
    data.comp,
    by = pulmonary, # split table by group
    percent = "row",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

mod2_all <- glm(pulmonary ~ lineage + country + immi + rcs(age10, 3), data.comp, family = binomial(link="logit"))
t13 <- tbl_regression(mod2_all, exponentiate = TRUE, pvalue_fun=~style_pvalue(.x,digits=3)) %>% add_global_p()

# merge sample description and outcome
tbl_merge_ex2 <-
  tbl_merge(
    tbls = list(t12, t13),
    tab_spanner = c("**Sample**", "**Regression**")
  )

tbl_merge_ex2
```

# Lineage and Cavity

## Germany

```{r, message=FALSE, warning=FALSE}
lin_cavity_germany <- all2_new %>% filter(pulmonary=="Yes") %>% 
  dplyr::select(lineage, cavity, country, age, age10, immi) %>% 
  filter(country=="germany") %>%
  mutate(immi=factor(immi, levels = c(0,1), labels = c("Non-immigration", "Immigration"))) %>%
  filter(!is.na(lineage) & !is.na(cavity) & !is.na(country) & !is.na(age10)  & !is.na(immi))

t12 <- tbl_summary(
    lin_cavity_germany,
    by = cavity, # split table by group
    percent = "row",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

mod2_germany <- glm(cavity ~ lineage + rcs(age10,3) + immi, lin_cavity_germany, family = binomial(link="logit"))
t13 <- tbl_regression(mod2_germany, exponentiate = TRUE, pvalue_fun=~style_pvalue(.x,digits=3)) %>% add_global_p()

# merge sample description and outcome
tbl_merge_ex2 <-
  tbl_merge(
    tbls = list(t12, t13),
    tab_spanner = c("**Sample**", "**Regression**")
  )

tbl_merge_ex2

require(rms)
theme_set(theme_bw())
dd <- datadist(lin_cavity_germany)
options(datadist="dd")

fit <- lrm(cavity~lineage + rcs(age10,3) + immi, data=lin_cavity_germany)
anova(fit)
pred <- rms::Predict(fit, age10=min(lin_cavity_germany$age10):max(lin_cavity_germany$age10), lineage=NA, immi=NA, fun=plogis)
ggplot(pred, rdata=lin_cavity_germany, ylab=expression(paste(hat(P),"(cavity)")),ylim=c(0,1), legend.position="top") +
  scale_color_discrete(name="Lineage") + 
  scale_x_continuous(name = "Age (x 10 years)") + 
  theme(text = element_text(size=15), axis.text.x = element_text(size=14), axis.text.y = element_text(size=14), legend.text=element_text(size=14)) + 
  geom_line(size=1.25) + 
  geom_ribbon(aes(ymin = pred$lower, ymax = pred$upper), alpha=0.05) + 
  annotate("text", x=5, y=0.85, label=paste0("p-value==",bquote(.(formatC(as.numeric(anova(fit)[12]),3,format="f")))), parse = TRUE)
ggsave("figures/lin_cavity_germany.png", width = 7, height = 5)
```

```{r}
library(gam)
gam_logistic = gam(cavity ~ lineage + s(age, 3) + immi, family = binomial, data = lin_cavity_germany)
par(mfrow=c(1,3))
plot(gam_logistic, se = TRUE, col = "green")
summary(gam_logistic)
```

## Vietnam

```{r, message=FALSE, warning=FALSE}
lin_cavity_vietnam <- all2_new %>% filter(pulmonary=="Yes") %>% 
  dplyr::select(lineage, cavity, country, age, age10) %>% 
  filter(country=="vietnam") %>%
  filter(!is.na(lineage) & !is.na(cavity) & !is.na(country) & !is.na(age10))
t12 <- tbl_summary(
    lin_cavity_vietnam,
    by = cavity, # split table by group
    percent = "row",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

mod2_vietnam <- glm(cavity ~ lineage + rcs(age10,3), lin_cavity_vietnam, family = binomial(link="logit"))
t13 <- tbl_regression(mod2_vietnam, exponentiate = TRUE, pvalue_fun=~style_pvalue(.x,digits=3)) #%>% add_global_p()

# merge sample description and outcome
tbl_merge_ex2 <-
  tbl_merge(
    tbls = list(t12, t13),
    tab_spanner = c("**Sample**", "**Regression**")
  )

tbl_merge_ex2
```

```{r}
library(gam)
gam_logistic = gam(cavity ~ lineage + s(age, 3), family = binomial, data = lin_cavity_vietnam)
par(mfrow=c(1,3))
plot(gam_logistic, se = TRUE, col = "green")
summary(gam_logistic)
```

## Italy

```{r, message=FALSE, warning=FALSE}
lin_cavity_italy <- all2_new %>% filter(pulmonary=="Yes") %>% 
  dplyr::select(lineage, cavity, country, age, age10, immi) %>% 
  filter(country=="italy") %>%
  filter(!is.na(lineage) & !is.na(cavity) & !is.na(country) & !is.na(age10) & !is.na(immi))
t12 <- tbl_summary(
    lin_cavity_italy,
    by = cavity, # split table by group
    percent = "row",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

mod2_italy <- glm(cavity ~ lineage + rcs(age10,3) + immi, lin_cavity_italy, family = binomial(link="logit"))
t13 <- tbl_regression(mod2_italy, exponentiate = TRUE, pvalue_fun=~style_pvalue(.x,digits=3)) #%>% add_global_p()

# merge sample description and outcome
tbl_merge_ex2 <-
  tbl_merge(
    tbls = list(t12, t13),
    tab_spanner = c("**Sample**", "**Regression**")
  )

tbl_merge_ex2
```

```{r}
library(gam)
gam_logistic = gam(cavity ~ lineage + s(age, 3), family = binomial, data = lin_cavity_italy)
par(mfrow=c(1,3))
plot(gam_logistic, se = TRUE, col = "green")
summary(gam_logistic)
```

## Indonesia

```{r, message=FALSE, warning=FALSE}
lin_cavity_indo <- all2_new %>% filter(pul2==1) %>% 
  dplyr::select(lineage, cavity, country, age, age10, immi) %>% 
  filter(country=="indonesia") %>%
  filter(!is.na(lineage) & !is.na(cavity) & !is.na(country) & !is.na(age10) & !is.na(immi))
t12 <- tbl_summary(
    lin_cavity_indo,
    by = cavity, # split table by group
    percent = "row",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

mod2_indo <- glm(cavity ~ lineage + rcs(age10,3), lin_cavity_indo, family = binomial(link="logit"))
t13 <- tbl_regression(mod2_indo, exponentiate = TRUE, pvalue_fun=~style_pvalue(.x,digits=3)) %>% add_global_p()

# merge sample description and outcome
tbl_merge_ex2 <-
  tbl_merge(
    tbls = list(t12, t13),
    tab_spanner = c("**Sample**", "**Regression**")
  )

tbl_merge_ex2
```

```{r}
library(gam)
gam_logistic = gam(cavity ~ lineage + s(age, 3), family = binomial, data = lin_cavity_indo)
par(mfrow=c(1,3))
plot(gam_logistic, se = TRUE, col = "green")
summary(gam_logistic)
```

## China

```{r, message=FALSE, warning=FALSE}
lin_cavity_china <- all2_new %>% filter(pulmonary=="Yes") %>% 
  dplyr::select(lineage, cavity, country, age, age10, immi) %>% 
  filter(country=="china") %>%
  filter(!is.na(lineage) & !is.na(cavity) & !is.na(country) & !is.na(age10) & !is.na(immi))
t12 <- tbl_summary(
    lin_cavity_china,
    by = cavity, # split table by group
    percent = "row",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

mod2_china <- glm(cavity ~ lineage + rcs(age10,3), lin_cavity_china, family = binomial(link="logit"))
t13 <- tbl_regression(mod2_china, exponentiate = TRUE, pvalue_fun=~style_pvalue(.x,digits=3)) #%>% add_global_p()

# merge sample description and outcome
tbl_merge_ex2 <-
  tbl_merge(
    tbls = list(t12, t13),
    tab_spanner = c("**Sample**", "**Regression**")
  )

tbl_merge_ex2
```

```{r}
library(gam)
gam_logistic = gam(cavity ~ lineage + s(age, 3), family = binomial, data = lin_cavity_china)
par(mfrow=c(1,3))
plot(gam_logistic, se = TRUE, col = "green")
summary(gam_logistic)
```

## Peru

```{r, message=FALSE, warning=FALSE}
lin_cavity_peru <- all2_new %>% filter(pulmonary=="Yes") %>% 
  dplyr::select(lineage, cavity, country, age, age10, immi) %>% 
  filter(country=="peru") %>%
  filter(!is.na(lineage) & !is.na(cavity) & !is.na(country) & !is.na(age10) & !is.na(immi))
t12 <- tbl_summary(
    lin_cavity_peru,
    by = cavity, # split table by group
    percent = "row",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

mod2_peru <- glm(cavity ~ lineage + rcs(age10,3), lin_cavity_peru, family = binomial(link="logit"))
t13 <- tbl_regression(mod2_peru, exponentiate = TRUE, pvalue_fun=~style_pvalue(.x,digits=3)) %>% add_global_p()

# merge sample description and outcome
tbl_merge_ex2 <-
  tbl_merge(
    tbls = list(t12, t13),
    tab_spanner = c("**Sample**", "**Regression**")
  )

tbl_merge_ex2
```

```{r}
library(gam)
gam_logistic = gam(cavity ~ lineage + s(age, 3), family = binomial, data = lin_cavity_peru)
par(mfrow=c(1,3))
plot(gam_logistic, se = TRUE, col = "green")
summary(gam_logistic)
```

## All countries

```{r, message=FALSE, warning=FALSE}
#install.packages("labelled")
# install.packages("labelled",dependencies = TRUE)
# install.packages("Rcpp")
# library(labelled)
lin_cavity <- all2_new %>% filter((country=="indonesia" & pul2==1) | (country!="indonesia" & pulmonary=="Yes")) %>% 
  dplyr::select(lineage, cavity, country, age, age10, immi) %>%
  mutate(immi=factor(immi, levels = c(0,1), labels = c("Non-immigration", "Immigration"))) %>%
  filter(!is.na(lineage) & !is.na(cavity) & !is.na(country) & !is.na(age10) & !is.na(immi))
t12 <- tbl_summary(
    lin_cavity,
    by = cavity, # split table by group
    percent = "row",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

mod2_all <- glm(cavity ~ lineage + country + rcs(age10,3) + immi, lin_cavity, family = binomial(link="logit"))
t13 <- tbl_regression(mod2_all, exponentiate = TRUE, pvalue_fun=~style_pvalue(.x,digits=3)) %>% add_global_p()

# merge sample description and outcome
tbl_merge_ex2 <-
  tbl_merge(
    tbls = list(t12, t13),
    tab_spanner = c("**Sample**", "**Regression**")
  )

tbl_merge_ex2

library(rms)
theme_set(theme_bw())
dd <- datadist(lin_cavity)
options(datadist="dd")

fit <- lrm(cavity~lineage + country + rcs(age10,3) + immi, data=lin_cavity)
anova(fit)
pred <- rms::Predict(fit, age10=min(lin_cavity$age10):max(lin_cavity$age10), lineage=NA, country=NA, immi=NA, fun=plogis)
ggplot(pred, rdata=lin_cavity, ylab=expression(paste(hat(P),"(cavity)")),ylim=c(0,1), legend.position="top") +
  scale_color_discrete(name="Lineage") + 
  scale_x_continuous(name = "Age (x 10 years)") + 
  theme(text = element_text(size=20), axis.text.x = element_text(size=18), axis.text.y = element_text(size=18), legend.text=element_text(size=18)) + 
  geom_line(size=1.25) + 
  geom_ribbon(aes(ymin = pred$lower, ymax = pred$upper), alpha=0.05) + 
  annotate("text", x=5, y=0.85, size=8, label="p-value<0.001")
ggsave("figures/lin_cavity.png", width = 7, height = 5)
```

```{r}
library(gam)
gam_logistic = gam(cavity ~ lineage + s(age, 3) + immi, family = binomial, data = lin_cavity)
par(mfrow=c(1,3))
plot(gam_logistic, se = TRUE, col = "green")
summary(gam_logistic)
```

## Forest plot

```{r, results='hide', message=FALSE, warning=FALSE}
exp(coef(mod2_china))
exp(coef(mod2_germany))
exp(coef(mod2_indo))
exp(coef(mod2_italy))
exp(coef(mod2_peru))
exp(coef(mod2_vietnam))
exp(coef(mod2_all))

exp(confint(mod2_china))
exp(confint(mod2_germany))
exp(confint(mod2_indo))
exp(confint(mod2_italy))
#install.packages("D:/Biostat/IDAR_1.0.tar.gz", repos = NULL, type="source")

#logist.summary(mod2_italy)
#exp(confint.default(mod2_italy))

exp(confint(mod2_peru))
exp(confint(mod2_vietnam))
exp(confint(mod2_all))
```

```{r, results='hide', message=FALSE, warning=FALSE}
data_lin_ca <- data.frame(
  lineage=c("Lineage 2: China", "Lineage 2: Germany", "Lineage 2: Indonesia", "Lineage 2: Italy", "Lineage 2: Peru", "Lineage 2: Vietnam", "Lineage 2: Combined",
            "Lineage 3: China", "Lineage 3: Germany", "Lineage 3: Indonesia", "Lineage 3: Italy", "Lineage 3: Peru", "Lineage 3: Vietnam", "Lineage 3: Combined",
            "Lineage 4: China", "Lineage 4: Germany", "Lineage 4: Indonesia", "Lineage 4: Italy", "Lineage 4: Peru", "Lineage 4: Vietnam", "Lineage 4: Combined"),
  result=c("0.44 (0.20-0.97)*", "0.86 (0.34-2.18)", "1.43 (0.59-3.72)", "3.77 (0.29-94.0)", "", "0.66 (0.53-0.81) ***", "0.69 (0.57-0.83) ***",
           "1.92 (0.16-44.4)", "0.95 (0.39-2.33)", "", "2.40 (0.08-72.0)", "", "", "0.78 (0.45-1.31)",
           "0.49 (0.22-1.07)", "1.00 (0.46-2.19)", "1.48 (0.62-3.82)", "3.79 (0.64-72.7)", "1.49 (0.74-2.86)", "0.47 (0.33-0.67) ***", "0.73 (0.59-0.90) **"),
  group=rep(c("China", "Germany", "Indonesia", "Italy", "Peru", "Vietnam", "Combined"), 3),
  OR=c(0.44, 0.86, 1.43, 3.77, NA, 0.66, 0.69,
       1.92, 0.95, NA, 2.40, NA, NA, 0.78,
       0.49, 1.00, 1.48, 3.79, 1.49, 0.47, 0.73),
  Lower=c(0.20, 0.34, 0.59, 0.29, NA, 0.53, 0.57,
          0.16, 0.39, NA, 0.08, NA, NA, 0.45,
          0.22, 0.46, 0.62, 0.64, 0.74, 0.33, 0.59),
  Upper=c(0.97, 2.18, 3.72, 94.0, NA, 0.81, 0.83,
          44.4, 2.33, NA, 72.0, NA, NA, 1.31,
          1.07, 2.19, 3.82, 72.7, 2.86, 0.67, 0.90)
)
```

This is a forest plot. The main problem is that a couple of our values are several orders of magnitude greater than the rest. Typically with a forest plot, we might want a log scale for the odds ratio to make it symmetrical around one. However, even that won't be enough here to resolve the details on the plot, so we might have simply filtered out the outliers (which appear nonsensical). Since we effectively have nested factor levels, I have "silently" faceted the plot.

```{r, warning=FALSE}
library(dplyr)

legend_title <- "Country"

plot_lin_ca <- data_lin_ca %>% 
  mutate(Upper = replace(Upper, abs(Upper) > 100, NA),
         Lower = replace(Lower, abs(Lower) > 100, NA),
         OR = replace(OR, abs(OR) > 100, NA),
         lineage = factor(gsub(":.*$", "", lineage))) %>%
  ggplot(aes(x = OR, 
             y = factor(group, levels = c("Combined", "Vietnam", "Peru", "Italy", "Indonesia", "Germany", "China")),
             shape = factor(group, levels = c("Combined", "Vietnam", "Peru", "Italy", "Indonesia", "Germany", "China")),
             color = factor(group, levels = c("Combined", "Vietnam", "Peru", "Italy", "Indonesia", "Germany", "China")))) + 
  #geom_rect(aes(xmin = 0.001, xmax = 100,
  #              ymin = -Inf, ymax = Inf, fill = lineage)) +
  geom_errorbarh(aes(xmin = Lower, xmax = Upper)) +
  geom_text(aes(x=18,label=result),size=7, position = position_dodge(0.9), vjust = -0.2) +
  geom_point(size = 3 ) +
  geom_vline(aes(xintercept = 1), linetype = 2) +
  geom_hline(aes(yintercept = 7.5), linetype = "dotted", color="black") +
  #scale_shape_discrete(name="Country", labels = c("Combined", "Vietnam", "Peru", "Italy", "Indonesia", "Germany", "China")) +
  #scale_color_discrete(name="Country", labels = c("Combined", "Vietnam", "Peru", "Italy", "Indonesia", "Germany", "China")) +
  xlab("OR (95% CIs)") +
  ylab("") +
  scale_shape_manual(values = c(1:7), name="Country", labels = c("Combined", "Vietnam", "Peru", "Italy", "Indonesia", "Germany", "China")) +
  scale_color_manual(values = c(1:7), name="Country", labels = c("Combined", "Vietnam", "Peru", "Italy", "Indonesia", "Germany", "China")) +
  #labs(color = "Country") +
  scale_x_log10(breaks=c(0.1,0.32,1,3.16,10,31.6, 100)) +
  #coord_cartesian(xlim = c(0.01, 100)) +
  facet_grid(lineage~., switch = "y") +
  theme_bw() +
  theme(panel.spacing.y = unit(0, "points"),
        panel.border = element_blank(),
        text = element_text(size=24),
        axis.text.y = element_blank(),
        axis.text.x = element_text(size=20),
        legend.text = element_text(size=20),
        legend.title = element_text(size=20),
        legend.position = "bottom",
        #legend.box = "horizontal",
        axis.title = element_text(size=20),
        axis.ticks.length.y = unit(0, "points"),
        strip.text.y.left = element_text(angle = 0),
        strip.background.y = element_blank(),
        strip.placement = "outside",
        axis.line = element_line()
        ) +
  guides(color = guide_legend(nrow = 1), shape = guide_legend(nrow = 1)) +
  labs(caption = "*p<0.05, **p<0.01, ***p<0.001") +
  ggtitle("Cavity vs. no cavity, by lineage and country")
plot_lin_ca

ggsave("Figure1_lin_ca.png")
```

# Lineage and Cavity controlling for additional variables

## Germany

```{r, message=FALSE, warning=FALSE}
lin_cavity_germany <- all2_new %>% filter(pulmonary=="Yes") %>% 
  dplyr::select(lineage, cavity, country, age, age10, dm, hiv, immi) %>% 
  filter(country=="germany") %>%
  filter(!is.na(lineage) & !is.na(cavity) & !is.na(country) & !is.na(age10) & !is.na(dm) & !is.na(hiv) & !is.na(immi))
t12 <- tbl_summary(
    lin_cavity_germany,
    by = cavity, # split table by group
    percent = "row",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

mod2_germany <- glm(cavity ~ lineage + rcs(age10,3) + dm + hiv + immi, lin_cavity_germany, family = binomial(link="logit"))
t13 <- tbl_regression(mod2_germany, exponentiate = TRUE, pvalue_fun=~style_pvalue(.x,digits=3)) %>% add_global_p()

# merge sample description and outcome
tbl_merge_ex2 <-
  tbl_merge(
    tbls = list(t12, t13),
    tab_spanner = c("**Sample**", "**Regression**")
  )

tbl_merge_ex2
```

```{r}
library(gam)
gam_logistic = gam(cavity ~ lineage + s(age, 3) + dm + hiv + immi, family = binomial, data = lin_cavity_germany)
par(mfrow=c(1,3))
plot(gam_logistic, se = TRUE, col = "green")
summary(gam_logistic)
```

## Indonesia

```{r, message=FALSE, warning=FALSE}
lin_cavity_indo <- all2_new %>% filter(pul2==1) %>% 
  dplyr::select(lineage, cavity, country, age, age10, dm, immi) %>% 
  filter(country=="indonesia") %>%
  filter(!is.na(lineage) & !is.na(cavity) & !is.na(country) & !is.na(age10) & !is.na(dm) & !is.na(immi))
t12 <- tbl_summary(
    lin_cavity_indo,
    by = cavity, # split table by group
    percent = "row",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

mod2_indo <- glm(cavity ~ lineage + rcs(age10,3) + dm, lin_cavity_indo, family = binomial(link="logit"))
t13 <- tbl_regression(mod2_indo, exponentiate = TRUE, pvalue_fun=~style_pvalue(.x,digits=3)) %>% add_global_p()

# merge sample description and outcome
tbl_merge_ex2 <-
  tbl_merge(
    tbls = list(t12, t13),
    tab_spanner = c("**Sample**", "**Regression**")
  )

tbl_merge_ex2
```

```{r}
library(gam)
gam_logistic = gam(cavity ~ lineage + s(age, 3) + dm, family = binomial, data = lin_cavity_indo)
par(mfrow=c(1,3))
plot(gam_logistic, se = TRUE, col = "green")
summary(gam_logistic)
```

## China

```{r, message=FALSE, warning=FALSE}
lin_cavity_china <- all2_new %>% filter(pulmonary=="Yes") %>% 
  dplyr::select(lineage, cavity, country, age, age10, dm, immi) %>% 
  filter(country=="china") %>%
  filter(!is.na(lineage) & !is.na(cavity) & !is.na(country) & !is.na(age10) & !is.na(dm) & !is.na(immi))
t12 <- tbl_summary(
    lin_cavity_china,
    by = cavity, # split table by group
    percent = "row",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

mod2_china <- glm(cavity ~ lineage + rcs(age10,3) + dm, lin_cavity_china, family = binomial(link="logit"))
t13 <- tbl_regression(mod2_china, exponentiate = TRUE, pvalue_fun=~style_pvalue(.x,digits=3)) #%>% add_global_p()

# merge sample description and outcome
tbl_merge_ex2 <-
  tbl_merge(
    tbls = list(t12, t13),
    tab_spanner = c("**Sample**", "**Regression**")
  )

tbl_merge_ex2
```

```{r}
library(gam)
gam_logistic = gam(cavity ~ lineage + s(age, 3) + dm, family = binomial, data = lin_cavity_china)
par(mfrow=c(1,3))
plot(gam_logistic, se = TRUE, col = "green")
summary(gam_logistic)
```

## Peru

```{r, message=FALSE, warning=FALSE}
lin_cavity_peru <- all2_new %>% filter(pulmonary=="Yes") %>% 
  dplyr::select(lineage, cavity, country, age, age10, dm, immi) %>% 
  filter(country=="peru") %>%
  filter(!is.na(lineage) & !is.na(cavity) & !is.na(country) & !is.na(age10) & !is.na(dm) & !is.na(immi))
t12 <- tbl_summary(
    lin_cavity_peru,
    by = cavity, # split table by group
    percent = "row",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

mod2_peru <- glm(cavity ~ lineage + rcs(age10,3) + dm , lin_cavity_peru, family = binomial(link="logit"))
t13 <- tbl_regression(mod2_peru, exponentiate = TRUE, pvalue_fun=~style_pvalue(.x,digits=3)) %>% add_global_p()

# merge sample description and outcome
tbl_merge_ex2 <-
  tbl_merge(
    tbls = list(t12, t13),
    tab_spanner = c("**Sample**", "**Regression**")
  )

tbl_merge_ex2
```

```{r}
library(gam)
gam_logistic = gam(cavity ~ lineage + s(age, 3) + dm, family = binomial, data = lin_cavity_peru)
par(mfrow=c(1,3))
plot(gam_logistic, se = TRUE, col = "green")
summary(gam_logistic)
```

# Different forms of EBTB compated to PTB by lineage

```{r, message=FALSE, warning=FALSE}
lin_site <- all2_new %>% filter(id!="727957bd-9833-4d19-8802-e7516f2b6491") %>% dplyr::select(lin1234, site, country, immi) %>% dplyr::filter(country %in% c("germany", "uk"))

t12 <- tbl_summary(
    lin_site,
    by = site, # split table by group
    percent = "row",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  #add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

t12
```

```{r, results='hide', warning=FALSE, message=FALSE}
#install.packages("nnet")
library(nnet)
library(broom)
mod2_mul <- multinom(site ~ lin1234 + country + immi, data = lin_site, na.action = na.exclude)
summary(mod2_mul)
exp(coef(mod2_mul))
exp(confint(mod2_mul))
z <- summary(mod2_mul)$coefficients/summary(mod2_mul)$standard.errors
z
# 2-tailed z test
p <- (1 - pnorm(abs(z), 0, 1)) * 2
p
car::Anova(mod2_mul)
broom::tidy(mod2_mul)
tbl_regression(mod2_mul, exponentiate = TRUE, pvalue_fun=~style_pvalue(.x,digits=3)) %>% add_global_p() %>% add_n()
```

The ratio of the probability of choosing one outcome category over the probability of choosing the baseline category is often referred as relative risk (and it is sometimes referred to as odds, described in the regression parameters above). The relative risk is the right-hand side linear equation exponentiated, leading to the fact that the exponentiated regression coefficients are relative risk ratios for a unit change in the predictor variable. We can exponentiate the coefficients from our model to see these risk ratios.

```{r}
exp(coef(mod2_mul))
```

```{r}
library(car)
#Wald test
linearHypothesis(mod2_mul,c("TBM:lin1234Lineage 2 = Osteoraticular TB:lin1234Lineage 2"),test="Chisq")
linearHypothesis(mod2_mul,c("TBM:lin1234Lineage 2 = Other TB:lin1234Lineage 2"),test="Chisq")
linearHypothesis(mod2_mul,c("Osteoraticular TB:lin1234Lineage 2 = Other TB:lin1234Lineage 2"),test="Chisq")

linearHypothesis(mod2_mul,c("TBM:lin1234Lineage 3 = Osteoraticular TB:lin1234Lineage 3"),test="Chisq")
linearHypothesis(mod2_mul,c("TBM:lin1234Lineage 3 = Other TB:lin1234Lineage 3"),test="Chisq")
linearHypothesis(mod2_mul,c("Osteoraticular TB:lin1234Lineage 3 = Other TB:lin1234Lineage 3"),test="Chisq")

linearHypothesis(mod2_mul,c("TBM:lin1234Lineage 4 = Osteoraticular TB:lin1234Lineage 4"),test="Chisq")
linearHypothesis(mod2_mul,c("TBM:lin1234Lineage 4 = Other TB:lin1234Lineage 4"),test="Chisq")
linearHypothesis(mod2_mul,c("Osteoraticular TB:lin1234Lineage 4 = Other TB:lin1234Lineage 4"),test="Chisq")
```

The relative risk ratio switching from Lineage 1 to Lineage 2 is 0.52 for being in TBM vs. Pulmonary TB.

You can also use predicted probabilities to help you understand the model. You can calculate predicted probabilities for each of our outcome levels using the fitted function. We can start by generating the predicted probabilities for the observations in our dataset and viewing the first few rows

```{r}
head(pp <- fitted(mod2_mul))
```
Next, if we want to examine the changes in predicted probability associated with one of our two variables, we can create small datasets varying one variable while holding the other constant. We will examining the predicted probabilities for each level of lineage, sex, country and immigration.

```{r}
dlin <- data.frame(lin1234 = c("Lineage 1", "Lineage 2", "Lineage 3", "Lineage 4"), 
                   sex=c("Female", "Male"),
                   country=c("germany", "uk"),
                   immi=c(0, 1))
pred <- predict(mod2_mul, newdata = dlin, "probs")
pred
```
Another way to understand the model using the predicted probabilities is to look at the averaged predicted probabilities for different values of the categorical lineage within each level of other categorical.

Sometimes, a couple of plots can convey a good deal amount of information. Using the predictions we generated for the pp.lin object above, we can plot the predicted probabilities against the writing score by the level of lineage for different levels of the outcome variable.


```{r}
dlin2 <- data.frame(lin1234 = rep(c("Lineage 1", "Lineage 2", "Lineage 3", "Lineage 4"), each = 2), 
                    sex = rep(c("Female", "Male"), 4),
                    country = rep(c("germany", "uk"), 4),
                    immi=rep(c(0,1), 4))
pp.lin <- cbind(dlin, predict(mod2_mul, newdata = dlin2, type = "probs", se = TRUE))
lpp <- melt(pp.lin, id.vars = c("lin1234", "sex", "country", "immi"), value.name = "probability")
head(lpp)
```

```{r}
## plot predicted probabilities across write values for each level of ses
## facetted by program type
ggplot(lpp, aes(x = lin1234, y = probability, colour = lin1234)) + geom_line() + facet_grid(variable ~., scales = "free")
```

```{r}
library("effects")
mod2_mul <- multinom(site ~ lin1234 + country + immi, data = lin_site, na.action = na.exclude)
summary(mod2_mul)
par(cex=100, cex.main=100, cex.lab = 100, cex.sub=100)
# png(filename ="Figure3b_lin_site2.png", width=1600, height=1200, res=300, bg = NA)
plot(predictorEffects(mod2_mul), lines=list(multiline=TRUE))
# dev.off()
```

## Forest plot

```{r, results='hide', message=FALSE, warning=FALSE}
library(forestplot)

header <- tibble(subset = "Subset",
                 OR = "OR (95% CIs)")

tbm <- tibble(mean = NA_real_,
                      subset = "TBM")

tbm_data <- tibble(mean  = c(0.52, 0.60, 0.56),
                   lower = c(0.10, 0.23, 0.21),
                   upper = c(2.66, 1.60, 1.50),
                   subset = c("Lineage 2" , "Lineage 3", "Lineage 4"),
                   OR = c("0.52 [0.10; 2.66]", "0.60 [0.23; 1.60]", "0.56 [0.21; 1.50]"))

osteo <- tibble(mean = NA_real_,
                      subset = "Osteo")

osteo_data <- tibble(mean  = c(0.10, 0.38, 0.28), 
                    lower = c(0.02, 0.23, 0.16),
                    upper = c(0.43, 0.63, 0.48),
                    subset = c("Lineage 2" , "Lineage 3", "Lineage 4"),
                    OR = c("0.10 [0.02; 0.43]", "0.38 [0.23; 0.63]", "0.28 [0.16; 0.48]"))

other <- tibble(mean = NA_real_,
                      subset = "Other")

other_data <- tibble(mean  = c(0.51, 0.75, 0.48), 
                    lower = c(0.30, 0.54, 0.34),
                    upper = c(0.85, 1.04, 0.67),
                    subset = c("Lineage 2" , "Lineage 3", "Lineage 4"),
                    OR = c("0.51 [0.30; 0.85]", "0.75 [0.54; 1.04]", "0.48 [0.34; 0.67]"))

lin_site_output <- bind_rows(header,
                             tbm,
                             tbm_data,
                             osteo,
                             osteo_data,
                             other,
                             other_data)

#png(file='Figure2_lin_site.png', width = 1334, height = 750)
font <- "mono"
if (grepl("Ubuntu", Sys.info()["version"])) {
  font <- "HersheyGothicEnglish"
}

lin_site_output %>% 
  forestplot::forestplot(labeltext = c(subset, OR), 
             clip = c(0.00, 100), 
             #xlog = TRUE, 
             col = fpColors(box = "blue",
                            line = "darkred"),
             ci.vertices = TRUE,
             ci.vertices.height = 0.05,
             zero=1,
             shapes_gp = fpShapesGp(default = gpar(lwd = 2)),
             boxsize = .2,
             xlab = "Odds ratio (95% CIs)",
             title = "Estimated odds ratio of different forms of EPTB compared to PTB, by lineage",
             is.summary = c(TRUE, TRUE, rep(FALSE, 3), TRUE, rep(FALSE, 3), TRUE, rep(FALSE, 3)),
             txt_gp = fpTxtGp(label = list(gpar(fontfamily = font),
                                           gpar(fontfamily = "",
                                                col = "#660000")),
                              ticks = gpar(fontfamily = "", cex = 1),
                              xlab  = gpar(fontfamily = font, cex = 1)))
#dev.off()
```

```{r, warning=FALSE}
library(dplyr)

lin_site_output2 <- data.frame(
  site=c(rep("TBM", 3), rep("Osteo", 3), rep("Other", 3)),
  group=rep(c("Lineage 2", "Lineage 3", "Lineage 4"), 3),
  result=c("0.52 (0.10-2.66)", "0.60 (0.23-1.60)", "0.56 (0.21-1.50)",
           "0.10 (0.02-0.43) **", "0.38 (0.23-0.63) ***", "0.28 (0.16-0.48) ***",
           "0.51 (0.30-0.85) **", "0.75 (0.54-1.04)", "0.48 (0.34-0.67) ***"),
  OR=c(0.52, 0.60, 0.56,
       0.10, 0.38, 0.28,
       0.51, 0.75, 0.48),
  Lower=c(0.10, 0.23, 0.21,
          0.02, 0.23, 0.16,
          0.30, 0.54, 0.34),
  Upper=c(2.66, 1.60, 1.50,
          0.43, 0.63, 0.48,
          0.85, 1.04, 0.67)
)

plot_lin_site2 <- lin_site_output2 %>% 
  ggplot(aes(x = OR, 
             y = factor(group, levels = c("Lineage 2", "Lineage 3", "Lineage 4")),
             shape = factor(group, levels = c("Lineage 2", "Lineage 3", "Lineage 4")),
             color = factor(group, levels = c("Lineage 2", "Lineage 3", "Lineage 4")))) + 
  #geom_rect(aes(xmin = 0.001, xmax = 100,
  #              ymin = -Inf, ymax = Inf, fill = lineage)) +
  geom_errorbarh(aes(xmin = Lower, xmax = Upper)) +
  geom_text(aes(x=0.05,label=result),size=7, position = position_dodge(0.9), vjust = -0.2) +
  geom_point(size = 3) +
  geom_vline(aes(xintercept = 1), linetype = 2) +
  geom_hline(aes(yintercept = 3.5), linetype = "dotted", color="black") +
  #scale_shape_discrete(name="Lineage", labels = c("Lineage 2", "Lineage 3", "Lineage 4")) +
  #scale_color_discrete(name="Lineage", labels = c("Lineage 2", "Lineage 3", "Lineage 4")) +
  xlab("OR (95% CIs)") +
  ylab("") +
  scale_shape_manual(values = c(1:7), name="Lineage", labels = c("Lineage 2", "Lineage 3", "Lineage 4")) +
  scale_color_manual(values = c(1:7), name="Lineage", labels = c("Lineage 2", "Lineage 3", "Lineage 4")) +
  scale_x_log10() +
  #coord_cartesian(xlim = c(0.01, 100)) +
  facet_grid(factor(site, levels = c("TBM", "Osteo", "Other"))~., switch = "y") +
  theme_bw() +
  theme(panel.spacing.y = unit(0, "points"),
        panel.border = element_blank(),
        panel.grid.minor = element_blank(),
        text = element_text(size=24),
        axis.text.y = element_blank(),
        axis.text.x = element_text(size=20),
        legend.text = element_text(size=20),
        legend.title = element_text(size=20),
        legend.position = "bottom",
        #legend.box = "horizontal",
        axis.title = element_text(size=20),
        axis.ticks.length.y = unit(0, "points"),
        strip.text.y.left = element_text(angle = 0),
        strip.background.y = element_blank(),
        strip.placement = "outside",
        axis.line = element_line()
        ) +
  guides(color = guide_legend(nrow = 1), shape = guide_legend(nrow = 1)) +
  labs(caption = "*p<0.05, **p<0.01, ***p<0.001") +
  ggtitle("Estimated odds ratio of different forms of EPTB compared to PTB, by lineage")

plot_lin_site2
ggsave("Figure2_lin_site2.png")
```

# Lineage and Timika score

## Indonesia

```{r, warning=FALSE}

lin_timika2.1_indo <- all2_new  %>%
  mutate(timika2=as.numeric(sqrt(timika))) %>% 
  dplyr::select(timika2, lineage, sex, country) %>% filter(country=="indonesia")
t24 <- tbl_summary(
    lin_timika2.1_indo,
    by = lineage, # split table by group
    statistic = list(all_continuous() ~ "{mean} ({sd})"),
    digits = list(timika2 ~ c(1, 1)),
    percent = "col",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  #add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

t25 <- tbl_summary(
    lin_timika2.1_indo,
    by = sex, # split table by group
    statistic = list(all_continuous() ~ "{mean} ({sd})"),
    digits = list(timika2 ~ c(1, 1)),
    percent = "col",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  #add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()
t24
t25
```

```{r, warning=FALSE}

lin_timika2.1_indo <- all2_new %>%
  mutate(timika2=as.numeric(sqrt(timika))) %>% filter(country=="indonesia") %>% 
  dplyr::select(timika2, lineage, age10, country) %>% droplevels() %>%
  filter(!is.na(timika2) & !is.na(lineage) & !is.na(age10))

t14.1 <- tbl_summary(
    lin_timika2.1_indo,
    #by = NULL, # split table by group
    percent = "col",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  #add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

mod3.1 <- glm(timika2 ~ lineage + rcs(age10,3), lin_timika2.1_indo, family = "gaussian")
t15.1 <- tbl_regression(mod3.1, estimate_fun = ~style_ratio(.x, digits = 1), pvalue_fun=~style_pvalue(.x,digits=3)) %>% add_global_p()

# merge sample description and outcome
tbl_merge_ex3.1 <-
  tbl_merge(
    tbls = list(t14.1, t15.1),
    tab_spanner = c("**Sample**", "**Regression**")
  )

tbl_merge_ex3.1
summary(lin_timika2.1_indo[lin_timika2.1_indo$lineage == "Lineage 1", ]$timika2)
sd(lin_timika2.1_indo[lin_timika2.1_indo$lineage == "Lineage 1", ]$timika2)

library(rms)
theme_set(theme_bw())
dd <- datadist(lin_timika2.1_indo)
options(datadist="dd")

fit <- rms::ols(timika2 ~ lineage + rcs(age10,3), data=lin_timika2.1_indo)
anova(fit)
summary(fit, lineage="Lineage 1")
df <- data.frame(variable  = colnames(fit$var),
                 Beta      = fit$coefficients,
                 CI_lower  = fit$coefficients + qnorm(0.025) * sqrt(diag(fit$var)),
                 CI_upper  = fit$coefficients + qnorm(0.975) * sqrt(diag(fit$var)),
                 row.names = NULL)

df
```

```{r}
library(gam)
gam = gam(timika2 ~ lineage + s(age10, 3), data = lin_timika2.1_indo)
par(mfrow=c(1,3))
plot(gam, se = TRUE, col = "green")
summary(gam)
```

## Vietnam

```{r, warning=FALSE}

lin_timika2.1_vietnam <- all2_new %>%
  mutate(timika2=as.numeric(sqrt(timika))) %>% dplyr::select(timika2, lineage, sex, country) %>% filter(country=="vietnam")
t24 <- tbl_summary(
    lin_timika2.1_vietnam,
    by = lineage, # split table by group
    statistic = list(all_continuous() ~ "{mean} ({sd})"),
    digits = list(timika2 ~ c(1, 1)),
    percent = "col",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  #add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

t25 <- tbl_summary(
    lin_timika2.1_vietnam,
    by = sex, # split table by group
    statistic = list(all_continuous() ~ "{mean} ({sd})"),
    digits = list(timika2 ~ c(1, 1)),
    percent = "col",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  #add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()
t24
t25
```

```{r, warning=FALSE}

lin_timika2.1_vietnam <- all2_new %>%
  mutate(timika2=as.numeric(sqrt(timika))) %>% filter(country=="vietnam") %>% 
  dplyr::select(timika2, lineage, age10, country) %>% droplevels() %>%
  filter(!is.na(timika2) & !is.na(lineage) & !is.na(age10))

t14.1 <- tbl_summary(
    lin_timika2.1_vietnam,
    #by = NULL, # split table by group
    percent = "col",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  #add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

mod3.1 <- glm(timika2 ~ lineage + rcs(age10,3), lin_timika2.1_vietnam, family = "gaussian")
t15.1 <- tbl_regression(mod3.1, estimate_fun = ~style_ratio(.x, digits = 1), pvalue_fun=~style_pvalue(.x,digits=3)) %>% add_global_p()

# merge sample description and outcome
tbl_merge_ex3.1 <-
  tbl_merge(
    tbls = list(t14.1, t15.1),
    tab_spanner = c("**Sample**", "**Regression**")
  )

tbl_merge_ex3.1
summary(lin_timika2.1_vietnam[lin_timika2.1_vietnam$lineage == "Lineage 1", ]$timika2)
sd(lin_timika2.1_vietnam[lin_timika2.1_vietnam$lineage == "Lineage 1", ]$timika2)


library(rms)
theme_set(theme_bw())
dd <- datadist(lin_timika2.1_vietnam)
options(datadist="dd")

fit <- rms::ols(timika2 ~ lineage + rcs(age10,3), data=lin_timika2.1_vietnam)
anova(fit)
summary(fit, lineage="Lineage 1")
df <- data.frame(variable  = colnames(fit$var),
                 Beta      = fit$coefficients,
                 CI_lower  = fit$coefficients + qnorm(0.025) * sqrt(diag(fit$var)),
                 CI_upper  = fit$coefficients + qnorm(0.975) * sqrt(diag(fit$var)),
                 row.names = NULL)

df
```

```{r}
library(gam)
gam = gam(timika2 ~ lineage + s(age10, 3), data = lin_timika2.1_vietnam)
par(mfrow=c(1,3))
plot(gam, se = TRUE, col = "green")
summary(gam)
```

## Peru

```{r, warning=FALSE}

lin_timika2.1_peru <- all2_new %>%
  mutate(timika2=as.numeric(sqrt(timika))) %>% dplyr::select(timika2, lineage, sex, country) %>% filter(country=="peru")
t24 <- tbl_summary(
    lin_timika2.1_peru,
    by = lineage, # split table by group
    statistic = list(all_continuous() ~ "{mean} ({sd})"),
    digits = list(timika2 ~ c(1, 1)),
    percent = "col",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  #add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

t25 <- tbl_summary(
    lin_timika2.1_peru,
    by = sex, # split table by group
    statistic = list(all_continuous() ~ "{mean} ({sd})"),
    digits = list(timika2 ~ c(1, 1)),
    percent = "col",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  #add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()
t24
t25
```

```{r, warning=FALSE}

lin_timika2.1_peru <- all2_new %>%
  mutate(timika2=as.numeric(sqrt(timika))) %>% filter(country=="peru") %>% 
  dplyr::select(timika2, lineage, age10, country) %>%
  filter(!is.na(timika2) & !is.na(lineage) & !is.na(age10))

t14.1 <- tbl_summary(
    lin_timika2.1_peru,
    #by = NULL, # split table by group
    percent = "col",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  #add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

mod3.1 <- glm(timika2 ~ lineage + rcs(age10,3), lin_timika2.1_peru, family = "gaussian")
t15.1 <- tbl_regression(mod3.1, estimate_fun = ~style_ratio(.x, digits = 1), pvalue_fun=~style_pvalue(.x,digits=3)) %>% add_global_p()

# merge sample description and outcome
tbl_merge_ex3.1 <-
  tbl_merge(
    tbls = list(t14.1, t15.1),
    tab_spanner = c("**Sample**", "**Regression**")
  )

tbl_merge_ex3.1
summary(lin_timika2.1_peru[lin_timika2.1_peru$lineage == "Lineage 2", ]$timika2)
sd(lin_timika2.1_peru[lin_timika2.1_peru$lineage == "Lineage 2", ]$timika2)

lin_timika2.1_peru <- lin_timika2.1_peru %>% droplevels()

library(rms)
theme_set(theme_bw())
dd <- datadist(lin_timika2.1_peru)
options(datadist="dd")

fit <- rms::ols(timika2 ~ lineage + rcs(age10,3), data=lin_timika2.1_peru)
anova(fit)
summary(fit, lineage="Lineage 2")
df <- data.frame(variable  = colnames(fit$var),
                 Beta      = fit$coefficients,
                 CI_lower  = fit$coefficients + qnorm(0.025) * sqrt(diag(fit$var)),
                 CI_upper  = fit$coefficients + qnorm(0.975) * sqrt(diag(fit$var)),
                 row.names = NULL)

df
```

```{r}
library(gam)
gam = gam(timika2 ~ lineage + s(age10, 3), data = lin_timika2.1_peru)
par(mfrow=c(1,3))
plot(gam, se = TRUE, col = "green")
summary(gam)
```

## Italy

```{r, warning=FALSE}

lin_timika2.1_italy <- all2_new %>%
  mutate(timika2=as.numeric(sqrt(timika))) %>% dplyr::select(timika2, lineage, sex, immi, country) %>% filter(country=="italy")
t24 <- tbl_summary(
    lin_timika2.1_italy,
    by = lineage, # split table by group
    statistic = list(all_continuous() ~ "{mean} ({sd})"),
    digits = list(timika2 ~ c(1, 1)),
    percent = "col",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  #add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

t25 <- tbl_summary(
    lin_timika2.1_italy,
    by = sex, # split table by group
    statistic = list(all_continuous() ~ "{mean} ({sd})"),
    digits = list(timika2 ~ c(1, 1)),
    percent = "col",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  #add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

t26 <- tbl_summary(
    lin_timika2.1_italy,
    by = immi, # split table by group
    statistic = list(all_continuous() ~ "{mean} ({sd})"),
    digits = list(timika2 ~ c(1, 1)),
    percent = "col",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  #add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

t24
t25
t26
```

```{r, warning=FALSE}

lin_timika2.1_italy <- all2_new %>%
  mutate(timika2=as.numeric(sqrt(timika))) %>% filter(country=="italy") %>% 
  dplyr::select(timika2, lineage, age10, country, immi) %>%
  filter(!is.na(timika2) & !is.na(lineage) & !is.na(age10) & !is.na(immi))

t14.1 <- tbl_summary(
    lin_timika2.1_italy,
    #by = NULL, # split table by group
    percent = "col",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  #add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

mod3.1 <- glm(timika2 ~ lineage + rcs(age10,3) + immi, lin_timika2.1_italy, family = "gaussian")
t15.1 <- tbl_regression(mod3.1, estimate_fun = ~style_ratio(.x, digits = 1), pvalue_fun=~style_pvalue(.x,digits=3)) %>% add_global_p()

# merge sample description and outcome
tbl_merge_ex3.1 <-
  tbl_merge(
    tbls = list(t14.1, t15.1),
    tab_spanner = c("**Sample**", "**Regression**")
  )

tbl_merge_ex3.1
summary(lin_timika2.1_italy[lin_timika2.1_italy$lineage == "Lineage 1", ]$timika2)
sd(lin_timika2.1_italy[lin_timika2.1_italy$lineage == "Lineage 1", ]$timika2)
summary(lin_timika2.1_italy[lin_timika2.1_italy$immi == 0, ]$timika2)
sd(lin_timika2.1_italy[lin_timika2.1_italy$immi == 0, ]$timika2)

library(rms)
theme_set(theme_bw())
dd <- datadist(lin_timika2.1_italy)
options(datadist="dd")

fit <- rms::ols(timika2 ~ lineage + rcs(age10,3) + immi, data=lin_timika2.1_italy)
anova(fit)
summary(fit, lineage="Lineage 1")
df <- data.frame(variable  = colnames(fit$var),
                 Beta      = fit$coefficients,
                 CI_lower  = fit$coefficients + qnorm(0.025) * sqrt(diag(fit$var)),
                 CI_upper  = fit$coefficients + qnorm(0.975) * sqrt(diag(fit$var)),
                 row.names = NULL)

df
```

```{r}
library(gam)
gam = gam(timika2 ~ lineage + s(age10, 3) + immi, data = lin_timika2.1_italy)
par(mfrow=c(1,3))
plot(gam, se = TRUE, col = "green")
summary(gam)
```

## All countries

```{r, warning=FALSE}

lin_timika <- all2_new %>%
  mutate(timika2=as.numeric(sqrt(timika))) %>% dplyr::select(timika2, lineage, sex, hiv, dm, immi, country)
t24 <- tbl_summary(
    lin_timika,
    by = lineage, # split table by group
    statistic = list(all_continuous() ~ "{mean} ({sd})"),
    digits = list(timika2 ~ c(1, 1)),
    percent = "col",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  #add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

t25 <- tbl_summary(
    lin_timika,
    by = sex, # split table by group
    statistic = list(all_continuous() ~ "{mean} ({sd})"),
    digits = list(timika2 ~ c(1, 1)),
    percent = "col",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  #add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

t26 <- tbl_summary(
    lin_timika,
    by = country, # split table by group
    statistic = list(all_continuous() ~ "{mean} ({sd})"),
    digits = list(timika2 ~ c(1, 1)),
    percent = "col",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  #add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

t27 <- tbl_summary(
    lin_timika,
    by = immi, # split table by group
    statistic = list(all_continuous() ~ "{mean} ({sd})"),
    digits = list(timika2 ~ c(1, 1)),
    percent = "col",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  #add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()
t24
t25
t26
t27
```

## Box-cox transformation

```{r gg_boxcox, echo=FALSE}
### gg_boxcox ------------------------------------------------
### purpose: draw boxcox plot using ggplot2 backend
### author: trinhdhk
### param: - object: a formula.
### param: - ...: additional params passed to lm fit
### other params are documented within MASS:boxcox
### ----------------------------------------------------------
gg_boxcox <- function (object, lambda = seq(-2, 2, 1/10),
   interp = (m < 100), eps = 1/50, xlab = expression(lambda), 
   ylab = "log-Likelihood", ...) 
 {
   object <- lm(object, y = TRUE, qr = TRUE, ...)
   # if (is.null(object$y) || is.null(object$qr)) 
   #   object <- update(object, y = TRUE, qr = TRUE, ...)
   y <- object$y
   xqr <- object$qr
   if (any(y <= 0)) 
     stop("response variable must be positive")
   n <- length(y)
   y <- y/exp(mean(log(y)))
   logy <- log(y)
   xl <- loglik <- as.vector(lambda)
   m <- length(xl)
   for (i in 1L:m) {
     if (abs(la <- xl[i]) > eps) 
       yt <- (y^la - 1)/la
     else yt <- logy * (1 + (la * logy)/2 * (1 + (la * logy)/3 * 
       (1 + (la * logy)/4)))
     loglik[i] <- -n/2 * log(sum(qr.resid(xqr, yt)^2))
   }
   if (interp) {
     sp <- spline(xl, loglik, n = 100)
     xl <- sp$x
     loglik <- sp$y
     m <- length(xl)
   }
   mx <- (1L:m)[loglik == max(loglik)][1L]
   Lmax <- loglik[mx]
   lim <- Lmax - qchisq(19/20, 1)/2
   plims <- par("usr")
   y0 <- plims[3L]
   plt <-
     ggplot()+
     geom_line(mapping = aes(x = xl, y = loglik), size=.5, color = grey(0.1))+
     labs(x = xlab, y = ylab)+
     geom_hline(aes(yintercept = lim), linetype = 'dashed')+
     geom_text(aes(x=min(lambda),y=lim, label='95%'), hjust='left', vjust='bottom')+
     ylim(min(loglik, lim), max(loglik, lim))
   la <- xl[mx]
   # browser()
   if (mx > 1 && mx < m) 
     plt <- plt+
     geom_segment(aes(x=la, y=min(loglik), xend=la, yend=Lmax), linetype='dashed', color='red', size=.5)+
     geom_text(aes(x=la,y=min(loglik),label=round(la,digits = 2)),color='red',vjust='top',
               hjust='center')
   ind <- range((1L:m)[loglik > lim])
   if (loglik[1L] < lim) {
     i <- ind[1L]
     x <- xl[i - 1] + ((lim - loglik[i - 1]) * (xl[i] - 
                                                  xl[i - 1]))/(loglik[i] - loglik[i - 1])
     plt <- plt+
       geom_segment(aes(x=x, y=min(loglik), xend=x, yend=lim), linetype='dashed', color=grey(.5), size=.5)
   }
   if (loglik[m] < lim) {
     i <- ind[2L] + 1
     x <- xl[i - 1] + ((lim - loglik[i - 1]) * (xl[i] - 
                                                  xl[i - 1]))/(loglik[i] - loglik[i - 1])
     plt <- plt+
       geom_segment(aes(x=x, y=min(loglik), xend=x, yend=lim), linetype='dashed', color=grey(.5), size=.5)
   }
   plt
 }
```

```{r, warning=FALSE}

lin_timika2.1 <- all2_new %>%
  mutate(timika2=as.numeric(sqrt(timika))) %>% dplyr::select(timika, timika2, lineage, age10, country, immi) %>%
  filter(!is.na(timika2) & !is.na(lineage) & !is.na(age10) & !is.na(country) & !is.na(immi))
t14.1 <- tbl_summary(
    lin_timika2.1,
    #by = NULL, # split table by group
    percent = "col",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  #add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

mod3.1 <- glm(timika2 ~ lineage + rcs(age10,3) + country + immi, lin_timika2.1, family = "gaussian")
t15.1 <- tbl_regression(mod3.1, estimate_fun = ~style_ratio(.x, digits = 1), pvalue_fun=~style_pvalue(.x,digits=3)) %>% add_global_p()

# merge sample description and outcome
tbl_merge_ex3.1 <-
  tbl_merge(
    tbls = list(t14.1, t15.1),
    tab_spanner = c("**Sample**", "**Regression**")
  )

tbl_merge_ex3.1
summary(lin_timika2.1[lin_timika2.1$lineage == "Lineage 1", ]$timika2)
sd(lin_timika2.1[lin_timika2.1$lineage == "Lineage 1", ]$timika2)
summary(lin_timika2.1[lin_timika2.1$country == "indonesia", ]$timika2)
sd(lin_timika2.1[lin_timika2.1$country == "indonesia", ]$timika2)
summary(lin_timika2.1[lin_timika2.1$immi == 0, ]$timika2)
sd(lin_timika2.1[lin_timika2.1$immi == 0, ]$timika2)

library(rms)
theme_set(theme_bw())
dd <- datadist(lin_timika2.1)
options(datadist="dd")

fit <- rms::ols(timika2 ~ lineage + rcs(age10,3) + country + immi, data=lin_timika2.1)
anova(fit)
summary(fit, lineage="Lineage 1")
df <- data.frame(variable  = colnames(fit$var),
                 Beta      = fit$coefficients,
                 CI_lower  = fit$coefficients + qnorm(0.025) * sqrt(diag(fit$var)),
                 CI_upper  = fit$coefficients + qnorm(0.975) * sqrt(diag(fit$var)),
                 row.names = NULL)

df
```

```{r boxcox1}
# - Do the boxcox to find the best value
timika.boxcox <- with(lin_timika2.1, gg_boxcox((timika+1) ~ lineage + age10 + country + immi))
timika.boxcox
```

```{r, warning=FALSE}

lin_timika2.2 <- all2_new %>%
  mutate(timika2=as.numeric(sqrt(timika))) %>% dplyr::select(timika2, lineage, age, sex, country, hiv, immi)
t14.2 <- tbl_summary(
    lin_timika2.2,
    #by = NULL, # split table by group
    percent = "col",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  #add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

mod3.2 <- lm(timika2 ~ lineage + age + sex + country + hiv + immi, lin_timika2.2)
t15.2 <- tbl_regression(mod3.2, pvalue_fun=~style_pvalue(.x,digits=2))

# merge sample description and outcome
tbl_merge_ex3.2 <-
  tbl_merge(
    tbls = list(t14.2, t15.2),
    tab_spanner = c("**Sample**", "**Regression**")
  )

tbl_merge_ex3.2
```

```{r}
library(gam)
gam = gam(timika2 ~ lineage + s(age, 3) + sex + country + hiv + immi, data = lin_timika2.2)
par(mfrow=c(1,3))
plot(gam, se = TRUE, col = "green")
summary(gam)
```

```{r, warning=FALSE}

lin_timika2.3 <- all2_new %>%
  mutate(timika2=as.numeric(sqrt(timika))) %>% dplyr::select(timika2, lineage, age10, sex, country, dm, immi)
t14.3 <- tbl_summary(
    lin_timika2.3,
    #by = NULL, # split table by group
    percent = "col",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  #add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

mod3.3 <- glm(timika2 ~ lineage + age10 + sex + country + dm + immi, lin_timika2.3, family = "gaussian")
t15.3 <- tbl_regression(mod3.3, pvalue_fun=~style_pvalue(.x,digits=2))

# merge sample description and outcome
tbl_merge_ex3.3 <-
  tbl_merge(
    tbls = list(t14.3, t15.3),
    tab_spanner = c("**Sample**", "**Regression**")
  )

tbl_merge_ex3.3


library(rms)
theme_set(theme_bw())
dd <- datadist(lin_timika2.1)
options(datadist="dd")

fit <- ols(timika2 ~ lineage + rcs(age10,3) + country + immi, data=lin_timika2.3)
anova(fit)

summary(fit, lineage="Lineage 1")
df <- data.frame(variable  = colnames(fit$var),
                 Beta      = fit$coefficients,
                 CI_lower  = fit$coefficients + qnorm(0.025) * sqrt(diag(fit$var)),
                 CI_upper  = fit$coefficients + qnorm(0.975) * sqrt(diag(fit$var)),
                 row.names = NULL)

df

pred <- rms::Predict(fit, age10=min(lin_timika2.1$age10):max(lin_timika2.1$age10), lineage=NA, immi=NA, country=NA)
ggplot(pred, rdata=lin_timika2.1, ylab=expression(paste(hat(Mean),"(timika)")), legend.position="top") +
  scale_color_discrete(name="Lineage") + 
  scale_x_continuous(name = "Age") + 
  theme(text = element_text(size=15), axis.text.x = element_text(size=14), axis.text.y = element_text(size=14), legend.text=element_text(size=14)) + 
  geom_line(size=1.25) + 
  geom_ribbon(aes(ymin = pred$lower, ymax = pred$upper), alpha=0.05) + 
  annotate("text", x=5, y=0.85, label="p-value=0.0034")

ggsave("figures/lin_timika.png", width = 7, height = 5)
```

```{r}
library(gam)
gam = gam(timika2 ~ lineage + s(age10, 3) + country + dm + immi, data = lin_timika2.3)
par(mfrow=c(1,3))
plot(gam, se = TRUE, col = "green")
summary(gam)
```

# Lineage and time to sputum culture conversion

```{r, results='hide', warning=FALSE, message=FALSE}
lin2_time_cul2 <- all2_new %>% dplyr::select(id, lin1234, country, ltimeculture, rtimeculture, age, sex, immi) %>%
  mutate(time=as.numeric((rtimeculture + ltimeculture)/2)) %>%
  filter(!is.na(ltimeculture) & !is.na(rtimeculture) & (ltimeculture==0 & rtimeculture==0)) %>% as.data.table()
fwrite(x=lin2_time_cul2, file="lin_cul_0.csv")
```

```{r, results='hide', warning=FALSE, message=FALSE}
lin2_time_smear2 <- all2_new %>% dplyr::select(id, lin1234, country, ltimesmear, rtimesmear, age, sex, immi) %>%
  mutate(time=as.numeric((rtimesmear + ltimesmear)/2)) %>%
  filter(!is.na(ltimesmear) & !is.na(rtimesmear) & (ltimesmear==0 & rtimesmear==0)) %>% as.data.table()
fwrite(x=lin2_time_smear2, file="lin_smear_0.csv")
```

```{r, warning=FALSE}
library(survival)
lin_time_cul2 <- all2_new %>% dplyr::select(lin1234, country, ltimeculture, rtimeculture, age, age10, sex, immi) %>%
  filter(!(rtimeculture==0 & ltimeculture==0) & lin1234!="Lineage 3") %>%
  mutate(lin1234=droplevels(lin1234),
         ltimeculture=ifelse(is.na(ltimeculture), 0, ltimeculture),
         rtimeculture=ifelse(is.na(rtimeculture), Inf, rtimeculture)) %>%
  filter(!is.na(lin1234) & !is.na(country) & !is.na(sex) & !is.na(age) & !is.na(immi))

t37 <- tbl_summary(
    lin_time_cul2,
    #by = lin1234, # split table by group
    percent = "col",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  #add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()
t37
```

In this dataset, 779 patients (593 males and 186 females), median (1st quartile - 3rd quartile) age: 42 (31,51) who belonged to mostly lineage 2 (73%), then lineage 1 (16%) and lineage 4 (10%) are followed, with time from last culture negative to first culture positive being the response time of interest. For all patients, the event time was known and treated only up to an interval due to unknown time of the event occurred. The dataset contains these variables: left time, right time, sex, age and lineage. The variables left time and right time represent the observational interval of the culture conversion. The main effect of lineage will be examined with adjustment for sex, age, country, cavity and drug resistance.

First, the non-parametric maximum likelihood estimator (NPMLE) is fit to each group. The syntax for this is very similar to fitting the Kaplan Meier curves with survival::survfit, but the response must either be a Surv object with type = "interval2" or of the form cbind(l, r), where l, r are the left and right side of the observation interval for each subject. This syntax is also used for ic_sp and ic_par. Plots of the NPMLE for each group can be created using the plot function. This can be seen in Figure 1.

```{r, message=FALSE, warning=FALSE}
library(icenReg)
#Non-Parametric Estimator for Interval Censored Data
npmleFit <- ic_np(cbind(ltimeculture, rtimeculture) ~ lin1234, data = lin_time_cul2)
plot(npmleFit, main = "NPMLE by Lineage", col = c("blue", "orange", "black"))
```

While the three NPMLE fits give a full picture of comparing the three groups, we can use a regression model to more succinctly describe the difference between the three groups. One can begin with visually assessing which regression model appears more appropriate.

Examining Figure 2, some deviation from the regression assumptions can be seen; the transformed difference between the groups is greater early on but becomes less as time goes on. However, for the proportional odds model, the deviation is less and acceptable for inference. Because of this, it was chosen to model the data with a proportional odds effect of lineage.

```{r}
#Evaluate covariate effect for regression model
#diag_covar(cbind(ltimeculture, rtimeculture) ~ lin1234, data = lin_time_cul2, model = "ph", col = c("blue", "orange", "black"))
#diag_covar(cbind(ltimeculture, rtimeculture) ~ lin1234, data = lin_time_cul2, model = "po", col = c("blue", "orange", "black"))
```

Given that the bootstrap is required for estimating the standard errors.

```{r, message=FALSE, warning=FALSE}
#install.packages("doParallel")
library(doParallel)
myClust <- makeCluster(2)
registerDoParallel(myClust)
#Semi-Parametric models for Interval Censored Data
sp_fit <- ic_sp(cbind(ltimeculture, rtimeculture) ~ factor(lin1234), model = "ph", data = lin_time_cul2, bs_samples = 1000, useMCores = TRUE)
stopCluster(myClust)
summary(sp_fit)
exp(coefficients(sp_fit))
exp(confint(sp_fit))
aic_ph_sp <- 2*3 - 2*sp_fit$llk
aic_ph_sp
```

From the summary, it can be seen that there is a statistically significant difference in the hazards of having culture conversion at a given time between lineages in the study. It is estimated that the odds of having culture conversion at any given time will be 0.74 times higher for Lineage 2 than for Lineage 1 (95% CI = [0.59, 0.94], p = 0.015), and the hazards of having culture conversion at any given time will be 0.73 times higher for Lineage 4 than for Lineage 1 (95% CI = [0.52, 1.03], p = 0.074) under the assumption of proportional hazards.

We plot estimated survival curves between the three groups. The plotted curves can be found in Figure 3.

```{r}
newdata <- data.frame(lin1234 = c("Lineage 1", "Lineage 2", "Lineage 4"))
rownames(newdata) <- c("Lineage 1", "Lineage 2", "Lineage 4")
plot(sp_fit, newdata, main = "Semi-parametric Fits by Lineage", col = c("blue", "orange", "black"))
```

In some cases, a parametric model may be preferred. For example, even though bootstrapping can be used for inference on the regression parameters, it cannot be used for inference on the baseline survival distribution (and thus the conditional survival probabilities as well). If a parametric model is chosen, it is important to check that the chosen baseline distribution is appropriate. We can view how the different parametric models compare with the SPT fit under proportional hazards model. This is plotted in Figure 3. It was decided that the log-logistic distribution was the most appropriate, given that there appears no systematic deviation from the SPT fit.

```{r, message=FALSE, warning=FALSE}
#Compare parametric baseline distributions with semi-parametric baseline
#Creates plots to diagnosis fit of different choices of parametric baseline model. Plots the semi paramtric model against different choices of parametric models.
diag_baseline(sp_fit, lgdLocation = "topright")
diag_baseline(sp_fit, dist = "exponential", lgdLocation = "topright")
diag_baseline(sp_fit, dist = "weibull", lgdLocation = "topright")
diag_baseline(sp_fit, dist = "gamma", lgdLocation = "topright")
diag_baseline(sp_fit, dist = "lnorm", lgdLocation = "topright")
diag_baseline(sp_fit, dist = "loglogistic", lgdLocation = "topright")
#It was decided that the log-logistic distribution was the most appropriate, given that there appears no systematic deviation from the SPT fit
```

```{r}
#The proportional hazards model with a log-logistic baseline distribution can be fit using ic_par
par_fit_ph <- ic_par(cbind(ltimeculture, rtimeculture) ~ factor(lin1234), data = lin_time_cul2, model = "ph", dist = "loglogistic")
summary(par_fit_ph)
exp(coefficients(par_fit_ph))
exp(confint(par_fit_ph))
```

The results from the parametric fit under the assumption of proportional hazards agree with the SPT model; a statistically significant difference was found in the proportional hazards of having culture conversion for Lineage 2 and Lineage 4 compared with Lineage 1 but in other direction. The hazards of having culture conversion at any given time will be 0.79 times higher for Lineage 2 than for Lineage 1 (95% CI = [0.64, 0.96, p = 0.021), and the hazards of having culture conversion at any given time will be 0.86 times higher for Lineage 4 than for Lineage 1 (95% CI = [0.64, 1.51], p = 0.312) under the assumption of proportional hazards.

```{r}
#The proportional hazards model with a log-logistic baseline distribution and adjusting for covariates
lin_time_cul2_c <- lin_time_cul2 %>% filter(!is.na(country) & !is.na(age10) & !is.na(immi))
par_fit_ph_loglog <- ic_par(cbind(ltimeculture, rtimeculture) ~ factor(lin1234) + rcs(age10,3) + country + immi, data = lin_time_cul2_c, model = "ph", dist = "loglogistic")
summary(par_fit_ph_loglog)
exp(coefficients(par_fit_ph_loglog))
exp(confint(par_fit_ph_loglog))
aic_ph_loglog <- 2*9 - 2*par_fit_ph_loglog$llk
aic_ph_loglog
```
The results from the parametric fit under the assumption of proportional hazards with adjusting for covariates do not agree with the SPT model; a statistically significant difference was found in the proportional hazards of having culture conversion for Lineage 2 and Lineage 4 compared with Lineage 1 but in other direction. The hazards of having culture conversion at any given time will be 0.74 times higher for Lineage 2 than for Lineage 1 (95% CI = [0.60, 0.91, p = 0.004), and the hazards of having culture conversion at any given time will be 0.72 times higher for Lineage 4 than for Lineage 1 (95% CI = [0.52, 0.98], p = 0.040) under the assumption of proportional hazards and after adjusting for covariates including sex, age and country.

```{r}
#The proportional hazards model with a exponential baseline distribution and adjusting for covariates
lin_time_cul2_c <- lin_time_cul2 %>% filter(!is.na(country) & !is.na(age10) & !is.na(immi))
par_fit_ph_expo <- ic_par(cbind(ltimeculture, rtimeculture) ~ factor(lin1234) + rcs(age10,3) + country + immi, data = lin_time_cul2_c, model = "ph", dist = "exponential")
summary(par_fit_ph_expo)
exp(coefficients(par_fit_ph_expo))
exp(confint(par_fit_ph_expo))
aic_ph_expo <- 2*9 - 2*par_fit_ph_expo$llk
aic_ph_expo
```

```{r}
#The proportional hazards model with a Weibull baseline distribution and adjusting for covariates
lin_time_cul2_c <- lin_time_cul2 %>% filter(!is.na(country) & !is.na(age10) & !is.na(immi))
par_fit_ph_wei <- ic_par(cbind(ltimeculture, rtimeculture) ~ factor(lin1234) + rcs(age10,3) + country + immi, data = lin_time_cul2_c, model = "ph", dist = "weibull")
summary(par_fit_ph_wei)
exp(coefficients(par_fit_ph_wei))
exp(confint(par_fit_ph_wei))
aic_ph_wei <- 2*9 - 2*par_fit_ph_wei$llk
aic_ph_wei
```

```{r}
#The proportional hazards model with a log-normal baseline distribution and adjusting for covariates
lin_time_cul2_c <- lin_time_cul2 %>% filter(!is.na(country) & !is.na(age10) & !is.na(immi))
par_fit_ph_lnorm <- ic_par(cbind(ltimeculture, rtimeculture) ~ factor(lin1234) + rcs(age10,3) + country + immi, data = lin_time_cul2_c, model = "ph", dist = "lnorm")
summary(par_fit_ph_lnorm)
exp(coefficients(par_fit_ph_lnorm))
exp(confint(par_fit_ph_lnorm))
aic_ph_lnorm <- 2*9 - 2*par_fit_ph_lnorm$llk
aic_ph_lnorm
```

```{r}
#The proportional hazards model with a gamma baseline distribution and adjusting for covariates
lin_time_cul2_c <- lin_time_cul2 %>% filter(!is.na(country) & !is.na(age10) & !is.na(immi))
par_fit_ph_gam <- ic_par(cbind(ltimeculture, rtimeculture) ~ factor(lin1234) + rcs(age10,3) + country + immi, data = lin_time_cul2_c, model = "ph", dist = "gamma")
summary(par_fit_ph_gam)
exp(coefficients(par_fit_ph_gam))
exp(confint(par_fit_ph_gam))
aic_ph_gam <- 2*9 - 2*par_fit_ph_gam$llk
aic_ph_gam
```

The accelerated failure time model with a log-logistic baseline distribution can also be fit.

```{r}
#The accelerated failure time model with a log-logistic baseline distribution can be fit using ic_par
par_fit_aft_loglog <- ic_par(cbind(ltimeculture, rtimeculture) ~ factor(lin1234) + rcs(age10,3) + country + immi, data = lin_time_cul2_c, model = "aft", dist = "loglogistic")
summary(par_fit_aft_loglog)
exp(coefficients(par_fit_aft_loglog))
exp(confint(par_fit_aft_loglog))
aic_aft_loglog <- 2*9 - 2*par_fit_aft_loglog$llk
aic_aft_loglog
```

The results from the parametric accelerated failure time model fit closely agree with the SPT model; a statistically significant difference was found in the time to having culture conversion for Lineage 2 but not Lineage 4 compared with Lineage 1. The time to having culture conversion at any given time will be 1.29 times higher for Lineage 2 than for Lineage 1 (95% CI = [1.07, 1.57, p = 0.009), the time to having culture conversion at any given time will be 1.21 times higher for Lineage 4 than for Lineage 1 (95% CI = [0.90, 1.65], p = 0.021) under the assumption of log-logistic baseline distribution after adjusting for covariates.

```{r}
#The accelerated failure time model with a exponential baseline distribution can be fit using ic_par
par_fit_aft_expo <- ic_par(cbind(ltimeculture, rtimeculture) ~ factor(lin1234) + rcs(age10,3) + country + immi, data = lin_time_cul2_c, model = "aft", dist = "exponential")
summary(par_fit_aft_expo)
exp(coefficients(par_fit_aft_expo))
exp(confint(par_fit_aft_expo))
aic_aft_expo <- 2*9 - 2*par_fit_aft_expo$llk
aic_aft_expo
```

```{r}
#The accelerated failure time model with a Weibull baseline distribution can be fit using ic_par
par_fit_aft_wei <- ic_par(cbind(ltimeculture, rtimeculture) ~ factor(lin1234) + rcs(age10,3) + country + immi, data = lin_time_cul2_c, model = "aft", dist = "weibull")
summary(par_fit_aft_wei)
exp(coefficients(par_fit_aft_wei))
exp(confint(par_fit_aft_wei))
aic_aft_wei <- 2*9 - 2*par_fit_aft_wei$llk
aic_aft_wei
```

```{r}
#The accelerated failure time model with a log-normal baseline distribution can be fit using ic_par
par_fit_aft_lnorm <- ic_par(cbind(ltimeculture, rtimeculture) ~ factor(lin1234) + rcs(age10,3) + country + immi, data = lin_time_cul2_c, model = "aft", dist = "lnorm")
summary(par_fit_aft_lnorm)
exp(coefficients(par_fit_aft_lnorm))
exp(confint(par_fit_aft_lnorm))
aic_aft_lnorm <- 2*9 - 2*par_fit_aft_lnorm$llk
aic_aft_lnorm
```

```{r}
#The accelerated failure time model with a gamma baseline distribution can be fit using ic_par
par_fit_aft_gam <- ic_par(cbind(ltimeculture, rtimeculture) ~ factor(lin1234) + rcs(age10,3) + country + immi, data = lin_time_cul2_c, model = "aft", dist = "gamma")
summary(par_fit_aft_gam)
exp(coefficients(par_fit_aft_gam))
exp(confint(par_fit_aft_gam))
aic_aft_gam <- 2*9 - 2*par_fit_aft_gam$llk
aic_aft_gam
```

## Comparison of the PH model and the AFT using AIC criteria

```{r, warning=FALSE}
model_cul_fit <- data.frame(
  model = c("ph.loglogistic", "ph.exponential", "ph.weibull", "ph.lnorm", "ph.gamma", "aft.loglogistic", "aft.exponenital", "aft.weibull", "aft.lnorm", "aft.gamma"),
  aic = c(aic_ph_loglog, aic_ph_expo, aic_ph_wei, aic_ph_lnorm, aic_ph_gam, aic_aft_loglog, aic_aft_expo, aic_aft_wei, aic_aft_lnorm, aic_aft_gam),
  llk = c(par_fit_ph_loglog$llk, par_fit_ph_expo$llk, par_fit_ph_wei$llk, par_fit_ph_lnorm$llk, par_fit_ph_gam$llk, par_fit_aft_loglog$llk, par_fit_aft_expo$llk, par_fit_aft_wei$llk, par_fit_aft_lnorm$llk, par_fit_aft_gam$llk)
)
model_cul_fit %>% flextable::flextable()
```


```{r, warning=FALSE}
lineage_ph <- tibble(subset = "Lineage")

lineage_data_ph <- tibble(mean= c(1, 0.79, 0.82),
                          lower = c(1, 0.65, 0.63),
                          upper = c(1, 0.96, 1.07),
                          subset = c("Lineage 1", "Lineage 2", "Lineage 4"))

country_ph <- tibble(subset = "Country")

country_data_ph <- tibble(mean  = c(1, 2.95, 0.77, 1.05),
                          lower = c(1, 1.07, 0.58, 0.83),
                          upper = c(1, 8.13, 1.01, 1.33),
                          subset = c("Indonesia", "Italy", "South Africa", "Vietnam"))

age_ph <- tibble(subset = "Age in 10 years")

age_data_ph <- tibble(mean  = c(0.75, 1.22),
                      lower = c(0.65, 1.04),
                      upper = c(0.85, 1.43),
                      subset = c("Age (10 years)", "Age (10 years)'"))

immi_ph <- tibble(subset = "Immigration")

immi_data_ph <- tibble(mean  = c(1, 0.69),
                      lower = c(1, 0.24),
                      upper = c(1, 2.02),
                      subset = c("No", "Yes"))

lin_cul_output_ph <- bind_rows(lineage_ph,
                               lineage_data_ph,
                               country_ph,
                               country_data_ph,
                               age_ph,
                               age_data_ph,
                               immi_ph,
                               immi_data_ph)

lineage_aft <- tibble(subset = "Lineage")

lineage_data_aft <- tibble(mean= c(1, 1.23, 1.12),
                          lower = c(1, 1.03, 0.88),
                          upper = c(1, 1.47, 1.42),
                          subset = c("Lineage 1", "Lineage 2", "Lineage 4"))

country_aft <- tibble(subset = "Country")

country_data_aft <- tibble(mean  = c(1, 0.49, 1.15, 0.72),
                          lower = c(1, 0.22, 0.91, 0.59),
                          upper = c(1, 1.07, 1.46, 0.88),
                          subset = c("Indonesia", "Italy", "South Africa", "Vietnam"))

age_aft <- tibble(subset = "Age in 10 years")

age_data_aft <- tibble(mean  = c(1.27, 0.86),
                      lower = c(1.13, 1.43),
                      upper = c(0.75, 0.99),
                      subset = c("Age (10 years)", "Age (10 years)'"))

immi_aft <- tibble(subset = "Immigration")

immi_data_aft <- tibble(mean  = c(1, 1.03),
                      lower = c(1, 0.44),
                      upper = c(1, 2.44),
                      subset = c("No", "Yes"))

lin_cul_output_aft <- bind_rows(lineage_aft,
                                lineage_data_aft,
                                country_aft,
                                country_data_aft,
                                age_aft,
                                age_data_aft,
                                immi_aft,
                                immi_data_aft)

dat <- rbind(cbind(lin_cul_output_ph, df = "Proportional hazards"), cbind(lin_cul_output_aft, df = "Accelerated Failure Time"))
```

```{r, message=FALSE, warning=FALSE}
library(forestplot)
# png(file='Figure4_lin_cul.png', width = 1334, height = 750)
dat %>%
  group_by(df) %>%
  forestplot::forestplot(labeltext = c(subset),
                         legend = c("Accelerated Failure Time", "Proportional hazards"),
             clip = c(0.00, 12.00),
             shapes_gp = fpShapesGp(box = c("black", "red") %>% lapply(function(x) gpar(fill = x, col = "#555555")),
                                    default = gpar(vertices = TRUE)),
             ci.vertices = TRUE,
             ci.vertices.height = 0.1,
             line.margin = .1, # We need to add this to avoid crowding
             zero=1, #Reference line
             boxsize = .2, # We set the box size to better visualize the type
             #shapes_gp = fpShapesGp(default = gpar(lwd = 3)),
             xlab = "Time/Hazards Ratios (95% CI)",
             title = "Estimated time/hazard ratios to having culture conversion",
             is.summary = c(TRUE, rep(FALSE, 3), TRUE, rep(FALSE, 4), TRUE, rep(FALSE, 2), TRUE, rep(FALSE, 2)))

# dev.off()
```

# Lineage and time to sputum smear conversion

```{r, warning=FALSE}
lin_time_smear2 <- all2_new %>% dplyr::select(lin1234, country, ltimesmear, rtimesmear, age, age10, immi) %>%
  filter(!(rtimesmear==0 & ltimesmear==0) & lin1234!="Lineage 3") %>%
  mutate(lin1234=droplevels(lin1234),
         ltimesmear=ifelse(is.na(ltimesmear), 0, ltimesmear),
         rtimesmear=ifelse(is.na(rtimesmear), Inf, rtimesmear)) %>%
  filter(!is.na(lin1234) & !is.na(country) & !is.na(age) & !is.na(immi))

t37 <- tbl_summary(
    lin_time_smear2,
    #by = lin1234, # split table by group
    percent = "col",
    missing = "no" # don't list missing data separately
  ) %>%
  add_n() %>% # add column with total number of non-missing observations
  #add_p(pvalue_fun=~style_pvalue(.x,digits=2)) %>% # test for a difference between groups
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()
t37
```

```{r, message=FALSE, warning=FALSE}
library(icenReg)
#Non-Parametric Estimator for Interval Censored Data
npmleFit <- ic_np(cbind(ltimesmear, rtimesmear) ~ lin1234, data = lin_time_smear2)
plot(npmleFit, main = "NPMLE by Lineage", col = c("blue", "orange", "black"))
```

While the three NPMLE fits give a full picture of comparing the three groups, we can use a regression model to more succinctly describe the difference between the three groups. One can begin with visually assessing which regression model appears more appropriate.

Examining Figure 2, some deviation from the regression assumptions can be seen; the transformed difference between the groups is greater early on but becomes less as time goes on. However, for the proportional odds model, the deviation is less and acceptable for inference. Because of this, it was chosen to model the data with a proportional odds effect of lineage.

```{r}
#Evaluate covariate effect for regression model
#diag_covar(cbind(ltimesmear, rtimesmear) ~ lin1234, data = lin_time_smear2, model = "ph", col = c("blue", "orange", "black"))
#diag_covar(cbind(ltimesmear, rtimesmear) ~ lin1234, data = lin_time_smear2, model = "po", col = c("blue", "orange", "black"))
```

```{r, message=FALSE, warning=FALSE}
#install.packages("doParallel")
library(doParallel)
myClust <- makeCluster(2)
registerDoParallel(myClust)
#Semi-Parametric models for Interval Censored Data
sp_fit <- ic_sp(cbind(ltimesmear, rtimesmear) ~ factor(lin1234), model = "ph", data = lin_time_smear2, bs_samples = 1000, useMCores = TRUE)
stopCluster(myClust)
summary(sp_fit)
exp(coefficients(sp_fit))
exp(confint(sp_fit))
aic_ph_sp <- 2*3 - 2*sp_fit$llk
aic_ph_sp
```

From the summary, it can be seen that there is a statistically significant difference in the hazards of having smear conversion at a given time between lineages in the study. It is estimated that the hazards of having smear conversion at any given time will be 0.85 times higher for Lineage 2 than for Lineage 1 (95% CI = [0.75, 0.96], p = 0.009), and the hazards of having smear conversion at any given time will be 1.15 times higher for Lineage 4 than for Lineage 1 (95% CI = [0.97, 1.37], p = 0.105) under the assumption of proportional hazards.

We plot estimated survival curves between the three groups. The plotted curves can be found in Figure 3.

```{r}
newdata <- data.frame(lin1234 = c("Lineage 1", "Lineage 2", "Lineage 4"))
rownames(newdata) <- c("Lineage 1", "Lineage 2", "Lineage 4")
plot(sp_fit, newdata, main = "Semi-parametric Fits by Lineage", col = c("blue", "orange", "black"))
```

In some cases, a parametric model may be preferred. For example, even though bootstrapping can be used for inference on the regression parameters, it cannot be used for inference on the baseline survival distribution (and thus the conditional survival probabilities as well). If a parametric model is chosen, it is important to check that the chosen baseline distribution is appropriate. We can view how the different parametric models compare with the SPT fit under proportional hazards model. This is plotted in Figure 3. It was decided that the log-logistic distribution was the most appropriate, given that there appears no systematic deviation from the SPT fit.

```{r, message=FALSE, warning=FALSE}
#Compare parametric baseline distributions with semi-parametric baseline
#Creates plots to diagnosis fit of different choices of parametric baseline model. Plots the semi paramtric model against different choices of parametric models.
diag_baseline(sp_fit, lgdLocation = "topright")
diag_baseline(sp_fit, dist = "exponential", lgdLocation = "topright")
diag_baseline(sp_fit, dist = "weibull", lgdLocation = "topright")
diag_baseline(sp_fit, dist = "gamma", lgdLocation = "topright")
diag_baseline(sp_fit, dist = "lnorm", lgdLocation = "topright")
diag_baseline(sp_fit, dist = "loglogistic", lgdLocation = "topright")
#It was decided that the log-logistic distribution was the most appropriate, given that there appears no systematic deviation from the SPT fit
```

It was decided that the loglogistic distribution was the most appropriate, given that there appears no systematic deviation from the SPT fit.

The proportional hazards model with a loglogistic baseline distribution can be fit.

```{r}
#The proportional hazards model with a log-logistic baseline distribution can be fit using ic_par
par_fit_ph <- ic_par(cbind(ltimesmear, rtimesmear) ~ factor(lin1234), data = lin_time_smear2, model = "ph", dist = "loglogistic")
summary(par_fit_ph)
exp(coefficients(par_fit_ph))
exp(confint(par_fit_ph))
```

The results from the parametric fit under the assumption of proportional hazards agree with the SPT model; a statistically significant difference was found in the proportional hazards of having smear conversion for Lineage 2 and Lineage 4 compared with Lineage 1. The hazards of having smear conversion at any given time will be 0.84 times higher for Lineage 2 than for Lineage 1 (95% CI = [0.75, 0.94, p = 0.003), and the hazards of having smear conversion at any given time will be 1.15 times higher for Lineage 4 than for Lineage 1 (95% CI = [0.97, 1.37], p = 0.107) under the assumption of proportional hazards.

```{r}
#The proportional hazards model with a log-logistic baseline distribution and adjusting for covariates
lin_time_smear2_c <- lin_time_smear2 %>% filter(!is.na(country) & !is.na(age10) & !is.na(immi))
par_fit_ph_loglog <- ic_par(cbind(ltimesmear, rtimesmear) ~ factor(lin1234) + rcs(age10,3) + country + immi, data = lin_time_smear2_c, model = "ph", dist = "loglogistic")
summary(par_fit_ph_loglog)
exp(coefficients(par_fit_ph_loglog))
exp(confint(par_fit_ph_loglog))
aic_ph_loglog <- 2*9 - 2*par_fit_ph_loglog$llk
aic_ph_loglog
```
The results from the parametric fit under the assumption of proportional hazards with adjusting for covariates do not agree with the SPT model; a statistically significant difference was found in the proportional hazards of having smear conversion for Lineage 2 and Lineage 4 compared with Lineage 1. The hazards of having smear conversion at any given time will be 0.81 times higher for Lineage 2 than for Lineage 1 (95% CI = [0.72, 0.91, p = 0.0001), and the hazards of having smear conversion at any given time will be 1.15 times higher for Lineage 4 than for Lineage 1 (95% CI = [0.96, 1.37], p = 0.130) under the assumption of proportional hazards and after adjusting for covariates including sex, age, country and immigration status.

```{r}
#The proportional hazards model with a exponential baseline distribution and adjusting for covariates
lin_time_smear2_c <- lin_time_smear2 %>% filter(!is.na(country) & !is.na(age10) & !is.na(immi))
par_fit_ph_expo <- ic_par(cbind(ltimesmear, rtimesmear) ~ factor(lin1234) + rcs(age10,3) + country + immi, data = lin_time_smear2_c, model = "ph", dist = "exponential")
summary(par_fit_ph_expo)
exp(coefficients(par_fit_ph_expo))
exp(confint(par_fit_ph_expo))
aic_ph_expo <- 2*9 - 2*par_fit_ph_expo$llk
aic_ph_expo
```

```{r}
#The proportional hazards model with a Weibull baseline distribution and adjusting for covariates
lin_time_smear2_c <- lin_time_smear2 %>% filter(!is.na(country) & !is.na(age10) & !is.na(immi))
par_fit_ph_wei <- ic_par(cbind(ltimesmear, rtimesmear) ~ factor(lin1234) + rcs(age10,3) + country + immi, data = lin_time_smear2_c, model = "ph", dist = "weibull")
summary(par_fit_ph_wei)
exp(coefficients(par_fit_ph_wei))
exp(confint(par_fit_ph_wei))
aic_ph_wei <- 2*9 - 2*par_fit_ph_wei$llk
aic_ph_wei
```

```{r}
#The proportional hazards model with a log-normal baseline distribution and adjusting for covariates
lin_time_smear2_c <- lin_time_smear2 %>% filter(!is.na(country) & !is.na(age10) & !is.na(immi))
par_fit_ph_lnorm <- ic_par(cbind(ltimesmear, rtimesmear) ~ factor(lin1234) + rcs(age10,3) + country + immi, data = lin_time_smear2_c, model = "ph", dist = "lnorm")
summary(par_fit_ph_lnorm)
exp(coefficients(par_fit_ph_lnorm))
exp(confint(par_fit_ph_lnorm))
aic_ph_lnorm <- 2*9 - 2*par_fit_ph_lnorm$llk
aic_ph_lnorm
```

```{r}
#The proportional hazards model with a gamma baseline distribution and adjusting for covariates
lin_time_smear2_c <- lin_time_smear2 %>% filter(!is.na(country) & !is.na(age10) & !is.na(immi))
par_fit_ph_gam <- ic_par(cbind(ltimesmear, rtimesmear) ~ factor(lin1234) + rcs(age10,3) + country + immi, data = lin_time_smear2_c, model = "ph", dist = "gamma")
summary(par_fit_ph_gam)
exp(coefficients(par_fit_ph_gam))
exp(confint(par_fit_ph_gam))
aic_ph_gam <- 2*9 - 2*par_fit_ph_gam$llk
aic_ph_gam
```

The accelerated failure time model with a log-logistic baseline distribution can also be fit.

```{r}
#The accelerated failure time model with a log-logistic baseline distribution can be fit using ic_par
par_fit_aft_loglog <- ic_par(cbind(ltimesmear, rtimesmear) ~ factor(lin1234) + rcs(age10,3) + country + immi, data = lin_time_smear2_c, model = "aft", dist = "loglogistic")
summary(par_fit_aft_loglog)
exp(coefficients(par_fit_aft_loglog))
exp(confint(par_fit_aft_loglog))
aic_aft_loglog <- 2*9 - 2*par_fit_aft_loglog$llk
aic_aft_loglog
```

The results from the parametric accelerated failure time model fit closely agree with the SPT model; a statistically significant difference was found in the time to having smear conversion for Lineage 2 but not Lineage 4 compared with Lineage 1. The time to having smear conversion at any given time will be 1.30 times higher for Lineage 2 than for Lineage 1 (95% CI = [1.14, 1.50, p = 0.0002), the time to having smear conversion at any given time will be 0.89 times higher for Lineage 4 than for Lineage 1 (95% CI = [0.72, 1.11], p = 0.304) under the assumption of log-logistic baseline distribution after adjusting for covariates.

```{r}
#The accelerated failure time model with a exponential baseline distribution can be fit using ic_par
par_fit_aft_expo <- ic_par(cbind(ltimesmear, rtimesmear) ~ factor(lin1234) + sex + age10 + country + immi, data = lin_time_smear2_c, model = "aft", dist = "exponential")
summary(par_fit_aft_expo)
exp(coefficients(par_fit_aft_expo))
exp(confint(par_fit_aft_expo))
aic_aft_expo <- 2*9 - 2*par_fit_aft_expo$llk
aic_aft_expo
```

```{r}
#The accelerated failure time model with a Weibull baseline distribution can be fit using ic_par
par_fit_aft_wei <- ic_par(cbind(ltimesmear, rtimesmear) ~ factor(lin1234) + sex + age10 + country + immi, data = lin_time_smear2_c, model = "aft", dist = "weibull")
summary(par_fit_aft_wei)
exp(coefficients(par_fit_aft_wei))
exp(confint(par_fit_aft_wei))
aic_aft_wei <- 2*9 - 2*par_fit_aft_wei$llk
aic_aft_wei
```

```{r}
#The accelerated failure time model with a log-normal baseline distribution can be fit using ic_par
par_fit_aft_lnorm <- ic_par(cbind(ltimesmear, rtimesmear) ~ factor(lin1234) + sex + age10 + country + immi, data = lin_time_smear2_c, model = "aft", dist = "lnorm")
summary(par_fit_aft_lnorm)
exp(coefficients(par_fit_aft_lnorm))
exp(confint(par_fit_aft_lnorm))
aic_aft_lnorm <- 2*9 - 2*par_fit_aft_lnorm$llk
aic_aft_lnorm
```

```{r}
#The accelerated failure time model with a gamma baseline distribution can be fit using ic_par
par_fit_aft_gam <- ic_par(cbind(ltimesmear, rtimesmear) ~ factor(lin1234) + sex + age10 + country + immi, data = lin_time_smear2_c, model = "aft", dist = "gamma")
summary(par_fit_aft_gam)
exp(coefficients(par_fit_aft_gam))
exp(confint(par_fit_aft_gam))
aic_aft_gam <- 2*9 - 2*par_fit_aft_gam$llk
aic_aft_gam
```

## Comparison of the PH model and the AFT using AIC criteria

```{r, warning=FALSE}
model_smear_fit <- data.frame(
  model = c("ph.loglogistic", "ph.exponential", "ph.weibull", "ph.lnorm", "ph.gamma", "aft.loglogistic", "aft.exponenital", "aft.weibull", "aft.lnorm", "aft.gamma"),
  aic = c(aic_ph_loglog, aic_ph_expo, aic_ph_wei, aic_ph_lnorm, aic_ph_gam, aic_aft_loglog, aic_aft_expo, aic_aft_wei, aic_aft_lnorm, aic_aft_gam),
  llk = c(par_fit_ph_loglog$llk, par_fit_ph_expo$llk, par_fit_ph_wei$llk, par_fit_ph_lnorm$llk, par_fit_ph_gam$llk, par_fit_aft_loglog$llk, par_fit_aft_expo$llk, par_fit_aft_wei$llk, par_fit_aft_lnorm$llk, par_fit_aft_gam$llk)
)
model_smear_fit %>% flextable::flextable()
```

```{r, warning=FALSE}
lineage_ph <- tibble(subset = "Lineage")

lineage_data_ph <- tibble(mean= c(1, 0.82, 1.11),
                          lower = c(1, 0.73, 0.94),
                          upper = c(1, 0.92, 1.32),
                          subset = c("Lineage 1", "Lineage 2", "Lineage 4"))

country_ph <- tibble(subset = "Country")

country_data_ph <- tibble(mean  = c(1, 1.90, 1.59),
                          lower = c(1, 0.37, 1.28),
                          upper = c(1, 9.86, 1.97),
                          subset = c("Indonesia", "Italy", "Vietnam"))

sex_ph <- tibble(subset = "Sex")

sex_data_ph <- tibble(mean  = c(1, 0.89),
                      lower = c(1, 0.80),
                      upper = c(1, 0.99),
                      subset = c("Female", "Male"))

age_ph <- tibble(subset = "Age in 10 years")

age_data_ph <- tibble(mean  = c(0.90),
                      lower = c(0.86),
                      upper = c(0.93),
                      subset = c("Age (10 years)"))

immi_ph <- tibble(subset = "Immigration")

immi_data_ph <- tibble(mean  = c(1, 0.98),
                      lower = c(1, 0.19),
                      upper = c(1, 5.15),
                      subset = c("No", "Yes"))

lin_smear_output_ph <- bind_rows(lineage_ph,
                               lineage_data_ph,
                               country_ph,
                               country_data_ph,
                               sex_ph,
                               sex_data_ph,
                               age_ph,
                               age_data_ph,
                               immi_ph,
                               immi_data_ph)

lineage_aft <- tibble(subset = "Lineage")

lineage_data_aft <- tibble(mean= c(1, 1.27, 0.93),
                          lower = c(1, 1.11, 0.76),
                          upper = c(1, 1.45, 1.13),
                          subset = c("Lineage 1", "Lineage 2", "Lineage 4"))

country_aft <- tibble(subset = "Country")

country_data_aft <- tibble(mean  = c(1, 0.60, 0.49),
                          lower = c(1, 0.11, 0.39),
                          upper = c(1, 3.28, 0.60),
                          subset = c("Indonesia", "Italy", "Vietnam"))

sex_aft <- tibble(subset = "Sex")

sex_data_aft <- tibble(mean  = c(1, 1.16),
                      lower = c(1, 1.03),
                      upper = c(1, 1.30),
                      subset = c("Female", "Male"))

age_aft <- tibble(subset = "Age in 10 years")

age_data_aft <- tibble(mean  = c(1.12),
                      lower = c(1.08),
                      upper = c(1.16),
                      subset = c("Age (10 years)"))

immi_aft <- tibble(subset = "Immigration")

immi_data_aft <- tibble(mean  = c(1, 0.87),
                      lower = c(1, 0.15),
                      upper = c(1, 5.12),
                      subset = c("No", "Yes"))

lin_smear_output_aft <- bind_rows(lineage_aft,
                                lineage_data_aft,
                                country_aft,
                                country_data_aft,
                                sex_aft,
                                sex_data_aft,
                                age_aft,
                                age_data_aft,
                                immi_aft,
                                immi_data_aft)

dat <- rbind(cbind(lin_smear_output_ph, df = "Proportional hazards"), cbind(lin_smear_output_aft, df = "Accelerated Failure Time"))
```

```{r, message=FALSE, warning=FALSE}
library(forestplot)
# png(file='Figure5_lin_smear.png', width = 1334, height = 750)
dat %>%
  group_by(df) %>%
  forestplot::forestplot(labeltext = c(subset),
                         legend = c("Accelerated Failure Time", "Proportional hazards"),
             clip = c(0.00, 12.00),
             shapes_gp = fpShapesGp(box = c("black", "red") %>% lapply(function(x) gpar(fill = x, col = "#555555")),
                                    default = gpar(vertices = TRUE)),
             ci.vertices = TRUE,
             ci.vertices.height = 0.1,
             line.margin = .1, # We need to add this to avoid crowding
             zero=1, #Reference line
             boxsize = .2, # We set the box size to better visualize the type
             #shapes_gp = fpShapesGp(default = gpar(lwd = 3)),
             xlab = "Time/Hazards Ratios (95% CI)",
             title = "Estimated time/hazards ratios to having smear conversion",
             is.summary = c(TRUE, rep(FALSE, 3), TRUE, rep(FALSE, 3), TRUE, rep(FALSE, 2), TRUE, rep(FALSE, 1), TRUE, rep(FALSE, 2)),
             txt_gp = fpTxtGp(label = list(gpar(fontfamily = font),
                                           gpar(fontfamily = "",
                                                col = "#660000")),
                              ticks = gpar(fontfamily = "", cex = 1),
                              xlab  = gpar(fontfamily = font, cex = 1),
                              legend = gpar(fontfamily = font, cex = 0.9)))

# dev.off()
```

```{r, warning=FALSE}
library(dplyr)
library(ggtext)
library(glue)

lin_cul_ph <- data.frame(
  var=c("Lineage", "Lineage 1", "Lineage 2", "Lineage 4", 
        "Country", "Indonesia", "Italy", "South Africa", "Vietnam",
        "Age in 10 years", "Age (10 years)", "Age (10 years)'",
        "Immigration", "Born local", "Born overseas"),
  result=c("", "", "0.79 (0.65-0.96) *", "0.82 (0.63-1.07)",
           "", "", "2.95 (1.07-8.13) *", "0.77 (0.58-1.01)", "1.05 (0.83-1.33)",
           "", "0.75 (0.65-0.85) ***", "1.22 (1.04-1.43) *",
           "", "", "0.69 (0.24-2.02)"),
  ratio=c(NA, 1, 0.79, 0.82,
       NA, 1, 2.95, 0.77, 1.05,
       NA, 0.75, 1.22,
       NA, 1, 0.69),
  lower=c(NA, 1, 0.65, 0.63,
          NA, 1, 1.07, 0.58, 0.83,
          NA, 0.65, 1.04,
          NA, 1, 0.24),
  upper=c(NA, 1, 0.96, 1.07,
          NA, 1, 8.13, 1.01, 1.33,
          NA, 0.85, 1.43,
          NA, 1, 2.02)
)

plot_lin_cul_ph <- lin_cul_ph %>% 
  ggplot(aes(x = ratio, 
             y = factor(var, levels = c("Born overseas", "Born local", "Immigration",
                                        "Age (10 years)'", "Age (10 years)", "Age in 10 years",
                                        "Vietnam", "South Africa", "Italy", "Indonesia", "Country",
                                        "Lineage 4", "Lineage 2", "Lineage 1", "Lineage")))) + 
  #geom_rect(aes(xmin = 0.001, xmax = 100,
  #              ymin = -Inf, ymax = Inf, fill = lineage)) +
  geom_errorbarh(aes(xmin = lower, xmax = upper)) +
  geom_text(aes(x=2.5,label=result),size=7, position = position_dodge(0.8), vjust = -0.5) +
  geom_point(size = 1.5) +
  geom_vline(aes(xintercept = 1), linetype = 2) +
  #geom_hline(aes(yintercept = 3.5), linetype = "dotted", color="grey") +
  #scale_shape_discrete(name="Lineage", labels = c("Lineage 2", "Lineage 3", "Lineage 4")) +
  #scale_color_discrete(name="Lineage", labels = c("Lineage 2", "Lineage 3", "Lineage 4")) +
  xlab("Hazards Ratios (95% CIs)") +
  ylab("") +
  #scale_shape_manual(values = c(1:7), name="Lineage", labels = c("Lineage 2", "Lineage 3", "Lineage 4")) +
  #scale_color_manual(values = c(1:7), name="Lineage", labels = c("Lineage 2", "Lineage 3", "Lineage 4")) +
  scale_x_log10() +
  scale_y_discrete(labels = c("Born overseas", "Born local", expression(bold("Immigration")),
                              "Age (10 years)'", "Age (10 years)", expression(bold("Age in 10 years")),
                              "Vietnam", "South Africa", "Italy", "Indonesia", expression(bold("Country")),
                              "Lineage 4", "Lineage 2", "Lineage 1", expression(bold("Lineage")))) +
  #coord_cartesian(xlim = c(0.01, 100)) +
  #facet_grid(factor(site, levels = c("TBM", "Osteo", "Other"))~., switch = "y") +
  theme_bw() +
  theme(panel.spacing.y = unit(0, "points"),
        panel.border = element_blank(),
        panel.grid.minor = element_blank(),
        text = element_text(size=20),
        axis.text.y = element_text(size=20),
        axis.text.x = element_text(size=20),
        legend.text = element_text(size=20),
        legend.title = element_text(size=20),
        legend.position = "bottom",
        #legend.box = "horizontal",
        axis.title = element_text(size=20),
        axis.ticks.length.y = unit(0, "points"),
        strip.text.y.left = element_text(angle = 0),
        strip.background.y = element_blank(),
        strip.placement = "outside",
        axis.line = element_line()
        ) +
  guides(color = guide_legend(nrow = 1), shape = guide_legend(nrow = 1)) +
  labs(caption = "") #+
  #ggtitle("Estimated odds ratio of different forms of EPTB compared to PTB, by lineage")

plot_lin_cul_ph
ggsave("Figure5_lin_cul_ph.png")
```

```{r, warning=FALSE}
library(dplyr)
library(ggtext)
library(glue)

lin_smear_ph <- data.frame(
  var=c("Lineage", "Lineage 1", "Lineage 2", "Lineage 4", 
        "Country", "Indonesia", "Italy", "Vietnam",
        "Age in 10 years", "Age (10 years)", "Age (10 years)'",
        "Immigration", "Born local", "Born overseas"),
  result=c("", "", "0.82 (0.73-0.92) ***", "1.13 (0.95-1.34)",
           "", "", "1.91 (0.42-8.79)", "1.55 (1.25-1.92) ***",
           "", "0.79 (0.73-0.87) ***", "1.15 (1.04-1.27) **",
           "", "", "0.94 (0.19-4.59)"),
  ratio=c(NA, 1, 0.82, 1.13,
       NA, 1, 1.91, 1.55,
       NA, 0.79, 1.15,
       NA, 1, 0.94),
  lower=c(NA, 1, 0.73, 0.95,
          NA, 1, 0.42, 1.25,
          NA, 0.73, 1.04,
          NA, 1, 0.19),
  upper=c(NA, 1, 0.92, 1.34,
          NA, 1, 8.79, 1.92,
          NA, 0.87, 1.27,
          NA, 1, 4.59)
)

plot_lin_smear_ph <- lin_smear_ph %>% 
  ggplot(aes(x = ratio, 
             y = factor(var, levels = c("Born overseas", "Born local", "Immigration",
                                        "Age (10 years)'", "Age (10 years)", "Age in 10 years",
                                        "Vietnam", "Italy", "Indonesia", "Country",
                                        "Lineage 4", "Lineage 2", "Lineage 1", "Lineage")))) + 
  #geom_rect(aes(xmin = 0.001, xmax = 100,
  #              ymin = -Inf, ymax = Inf, fill = lineage)) +
  geom_errorbarh(aes(xmin = lower, xmax = upper)) +
  geom_text(aes(x=2.5,label=result),size=7, position = position_dodge(0.8), vjust = -0.5) +
  geom_point(size = 1.5) +
  geom_vline(aes(xintercept = 1), linetype = 2) +
  #geom_hline(aes(yintercept = 3.5), linetype = "dotted", color="grey") +
  #scale_shape_discrete(name="Lineage", labels = c("Lineage 2", "Lineage 3", "Lineage 4")) +
  #scale_color_discrete(name="Lineage", labels = c("Lineage 2", "Lineage 3", "Lineage 4")) +
  xlab("Hazards Ratios (95% CIs)") +
  ylab("") +
  #scale_shape_manual(values = c(1:7), name="Lineage", labels = c("Lineage 2", "Lineage 3", "Lineage 4")) +
  #scale_color_manual(values = c(1:7), name="Lineage", labels = c("Lineage 2", "Lineage 3", "Lineage 4")) +
  scale_x_log10() +
  scale_y_discrete(labels = c("Born overseas", "Born local", expression(bold("Immigration")),
                              "Age (10 years)'", "Age (10 years)", expression(bold("Age in 10 years")),
                              "Vietnam", "Italy", "Indonesia", expression(bold("Country")),
                              "Lineage 4", "Lineage 2", "Lineage 1", expression(bold("Lineage")))) +
  #coord_cartesian(xlim = c(0.01, 100)) +
  #facet_grid(factor(site, levels = c("TBM", "Osteo", "Other"))~., switch = "y") +
  theme_bw() +
  theme(panel.spacing.y = unit(0, "points"),
        panel.border = element_blank(),
        panel.grid.minor = element_blank(),
        text = element_text(size=20),
        axis.text.y = element_text(size=20),
        axis.text.x = element_text(size=20),
        legend.text = element_text(size=20),
        legend.title = element_text(size=20),
        legend.position = "bottom",
        #legend.box = "horizontal",
        axis.title = element_text(size=20),
        axis.ticks.length.y = unit(0, "points"),
        strip.text.y.left = element_text(angle = 0),
        strip.background.y = element_blank(),
        strip.placement = "outside",
        axis.line = element_line(),
        plot.caption = element_text(size = 20)
        ) +
  guides(color = guide_legend(nrow = 1), shape = guide_legend(nrow = 1)) +
  labs(caption = "*p<0.05, **p<0.01, ***p<0.001") #+
  #ggtitle("Estimated odds ratio of different forms of EPTB compared to PTB, by lineage")

plot_lin_smear_ph
ggsave("Figure5_lin_smear_ph.png")

plot_ph <- ggarrange(plot_lin_cul_ph, plot_lin_smear_ph, 
          labels = c("A", "B"),
          font.label = list(size = 30, color = "black"),
          ncol = 2, nrow = 1,
          common.legend = TRUE,
          legend = "bottom")

plot_ph <- annotate_figure(plot_ph, top = text_grob("Estimated hazards ratios to culture (A) and smear (B) conversion", 
               color = "black", face = "bold", size = 30))
plot_ph
ggsave("Figure5_lin_cul_smear_ph.png")
```

```{r, warning=FALSE}
library(dplyr)
library(ggtext)
library(glue)

lin_cul_aft <- data.frame(
  var=c("Lineage", "Lineage 1", "Lineage 2", "Lineage 4", 
        "Country", "Indonesia", "Italy", "South Africa", "Vietnam",
        "Age in 10 years", "Age (10 years)", "Age (10 years)'",
        "Immigration", "Born local", "Born overseas"),
  result=c("", "", "1.23 (1.04-1.47) *", "1.12 (0.88-1.42)",
           "", "", "0.49 (0.22-1.07)", "1.15 (0.91, 1.46)",  "0.72 (0.59-0.88) **",
           "", "1.27 (1.13-1.43) ***", "0.86 (0.75-0.99) *",
           "", "", "1.03 (0.44-2.44)"),
  ratio=c(NA, 1, 1.23, 1.12,
       NA, 1, 0.49, 1.15, 0.72,
       NA, 1.27, 0.86,
       NA, 1, 1.03),
  lower=c(NA, 1, 1.04, 0.88,
          NA, 1, 0.22, 0.91, 0.59,
          NA, 1.13, 0.75,
          NA, 1, 0.44),
  upper=c(NA, 1, 1.47, 1.42,
          NA, 1, 1.07, 1.46, 0.88,
          NA, 1.43, 0.99,
          NA, 1, 2.44)
)

plot_lin_cul_aft <- lin_cul_aft %>% 
  ggplot(aes(x = ratio, 
             y = factor(var, levels = c("Born overseas", "Born local", "Immigration", 
                                        "Age (10 years)'", "Age (10 years)", "Age in 10 years",
                                        "Vietnam", "South Africa", "Italy", "Indonesia", "Country",
                                        "Lineage 4", "Lineage 2", "Lineage 1", "Lineage")))) + 
  #geom_rect(aes(xmin = 0.001, xmax = 100,
  #              ymin = -Inf, ymax = Inf, fill = lineage)) +
  geom_errorbarh(aes(xmin = lower, xmax = upper)) +
  geom_text(aes(x=0.5,label=result),size=7, position = position_dodge(0.8), vjust = -0.5) +
  geom_point(size = 1.5) +
  geom_vline(aes(xintercept = 1), linetype = 2) +
  #geom_hline(aes(yintercept = 3.5), linetype = "dotted", color="grey") +
  #scale_shape_discrete(name="Lineage", labels = c("Lineage 2", "Lineage 3", "Lineage 4")) +
  #scale_color_discrete(name="Lineage", labels = c("Lineage 2", "Lineage 3", "Lineage 4")) +
  xlab("Time Ratios (95% CIs)") +
  ylab("") +
  #scale_shape_manual(values = c(1:7), name="Lineage", labels = c("Lineage 2", "Lineage 3", "Lineage 4")) +
  #scale_color_manual(values = c(1:7), name="Lineage", labels = c("Lineage 2", "Lineage 3", "Lineage 4")) +
  scale_x_log10() +
  scale_y_discrete(labels = c("Born overseas", "Born local", expression(bold("Immigration")),
                              "Age (10 years)'", "Age (10 years)", expression(bold("Age in 10 years")),
                              "Vietnam", "South Africa", "Italy", "Indonesia", expression(bold("Country")),
                              "Lineage 4", "Lineage 2", "Lineage 1", expression(bold("Lineage")))) +
  #coord_cartesian(xlim = c(0.01, 100)) +
  #facet_grid(factor(site, levels = c("TBM", "Osteo", "Other"))~., switch = "y") +
  theme_bw() +
  theme(panel.spacing.y = unit(0, "points"),
        panel.border = element_blank(),
        panel.grid.minor = element_blank(),
        text = element_text(size=20),
        axis.text.y = element_text(size=20),
        axis.text.x = element_text(size=20),
        legend.text = element_text(size=20),
        legend.title = element_text(size=20),
        legend.position = "bottom",
        #legend.box = "horizontal",
        axis.title = element_text(size=20),
        axis.ticks.length.y = unit(0, "points"),
        strip.text.y.left = element_text(angle = 0),
        strip.background.y = element_blank(),
        strip.placement = "outside",
        axis.line = element_line()
        ) +
  guides(color = guide_legend(nrow = 1), shape = guide_legend(nrow = 1)) +
  labs(caption = "") #+
  #ggtitle("Estimated odds ratio of different forms of EPTB compared to PTB, by lineage")

plot_lin_cul_aft
ggsave("Figure6_lin_cul_aft.png")
```

```{r, warning=FALSE}
library(dplyr)
library(ggtext)
library(glue)

lin_smear_aft <- data.frame(
  var=c("Lineage", "Lineage 1", "Lineage 2", "Lineage 4", 
        "Country", "Indonesia", "Italy", "Vietnam",
        "Age in 10 years", "Age (10 years)", "Age (10 years)'",
        "Immigration", "Born local", "Born overseas"),
  result=c("", "", "1.27 (1.11-1.45) ***", "0.91 (0.75-1.11)",
           "", "", "0.59 (0.12-3.02)", "0.50 (0.40-0.61) ***",
           "", "1.33 (1.20-1.47) ***", "0.83 (0.75-0.93) ***",
           "", "", "0.94 (0.17-5.07)"),
  ratio=c(NA, 1, 1.27, 0.91,
       NA, 1, 0.59, 0.50,
       NA, 1.33, 0.83,
       NA, 1, 0.94),
  lower=c(NA, 1, 1.11, 0.75,
          NA, 1, 0.12, 0.40,
          NA, 1.20, 0.75,
          NA, 1, 0.17),
  upper=c(NA, 1, 1.45, 1.11,
          NA, 1, 3.02, 0.61,
          NA, 1.47, 0.93,
          NA, 1, 5.07)
)

plot_lin_smear_aft <- lin_smear_aft %>% 
  ggplot(aes(x = ratio, 
             y = factor(var, levels = c("Born overseas", "Born local", "Immigration", 
                                        "Age (10 years)'", "Age (10 years)", "Age in 10 years",
                                        "Vietnam", "Italy", "Indonesia", "Country",
                                        "Lineage 4", "Lineage 2", "Lineage 1", "Lineage")))) + 
  #geom_rect(aes(xmin = 0.001, xmax = 100,
  #              ymin = -Inf, ymax = Inf, fill = lineage)) +
  geom_errorbarh(aes(xmin = lower, xmax = upper)) +
  geom_text(aes(x=0.5,label=result),size=7, position = position_dodge(0.8), vjust = -0.5) +
  geom_point(size = 1.5) +
  geom_vline(aes(xintercept = 1), linetype = 2) +
  #geom_hline(aes(yintercept = 3.5), linetype = "dotted", color="grey") +
  #scale_shape_discrete(name="Lineage", labels = c("Lineage 2", "Lineage 3", "Lineage 4")) +
  #scale_color_discrete(name="Lineage", labels = c("Lineage 2", "Lineage 3", "Lineage 4")) +
  xlab("Time Ratios (95% CIs)") +
  ylab("") +
  #scale_shape_manual(values = c(1:7), name="Lineage", labels = c("Lineage 2", "Lineage 3", "Lineage 4")) +
  #scale_color_manual(values = c(1:7), name="Lineage", labels = c("Lineage 2", "Lineage 3", "Lineage 4")) +
  scale_x_log10() +
  scale_y_discrete(labels = c("Born overseas", "Born local", expression(bold("Immigration")),
                              "Age (10 years)'", "Age (10 years)", expression(bold("Age in 10 years")),
                              "Vietnam", "Italy", "Indonesia", expression(bold("Country")),
                              "Lineage 4", "Lineage 2", "Lineage 1", expression(bold("Lineage")))) +
  #coord_cartesian(xlim = c(0.01, 100)) +
  #facet_grid(factor(site, levels = c("TBM", "Osteo", "Other"))~., switch = "y") +
  theme_bw() +
  theme(panel.spacing.y = unit(0, "points"),
        panel.border = element_blank(),
        panel.grid.minor = element_blank(),
        text = element_text(size=20),
        axis.text.y = element_text(size=20),
        axis.text.x = element_text(size=20),
        legend.text = element_text(size=20),
        legend.title = element_text(size=20),
        legend.position = "bottom",
        #legend.box = "horizontal",
        axis.title = element_text(size=20),
        axis.ticks.length.y = unit(0, "points"),
        strip.text.y.left = element_text(angle = 0),
        strip.background.y = element_blank(),
        strip.placement = "outside",
        axis.line = element_line(),
        plot.caption = element_text(size = 20)
        ) +
  guides(color = guide_legend(nrow = 1), shape = guide_legend(nrow = 1)) +
  labs(caption = "*p<0.05, **p<0.01, ***p<0.001") #+
  #ggtitle("Estimated odds ratio of different forms of EPTB compared to PTB, by lineage")

plot_lin_smear_aft
ggsave("Figure6_lin_smear_aft.png")

plot_aft <- ggarrange(plot_lin_cul_aft, plot_lin_smear_aft, 
          labels = c("A", "B"),
          font.label = list(size = 30, color = "black"),
          ncol = 2, nrow = 1,
          common.legend = TRUE,
          legend = "bottom")

plot_aft <- annotate_figure(plot_aft, top = text_grob("Estimated time ratios to culture (A) and smear (B) conversion", 
               color = "black", face = "bold", size = 30))
plot_aft
ggsave("Figure6_lin_cul_smear_aft.png")
```

# Mediation analysis

## Lineage and Cavity

```{r}
lin_cavity <- all2_new %>% filter(pulmonary=="Yes") %>% 
  mutate(mdr2=NA,
         mdr2=ifelse(mdr=="Drug susceptible", 0,
                     ifelse(mdr=="Isoniazid resistance", 1,
                            ifelse(mdr=="Rifampicin resistance", 1, mdr2)))) %>%
  dplyr::select(lineage, cavity, country, age, age10, immi, mdr2) %>%
  filter(!is.na(lineage) & !is.na(cavity) & !is.na(country) & !is.na(mdr2))
```

```{r}
#Creating Directed Acyclic Graphs
library(dagitty)
library(ggdag)
library(ggplot2)

dag <- dagitty("dag{y <- z -> x}")
tidy_dagitty(dag)
```

```{r}
dagified <- dagify(x ~ z,
                   y ~ z,
                   exposure = "x",
                   outcome = "y")
tidy_dagitty(dagified)
```

```{r}
ggdag(dag, layout = "circle")
```

```{r}
tidy_dag <- tidy_dagitty(dagified)
str(tidy_dag)
```

```{r}
node_parents(tidy_dag, "x")
```

```{r}
bigger_dag <- dagify(y ~ x + a + b,
                     x ~ a + b,
                     exposure = "x",
                     outcome = "y")
dag_paths(bigger_dag)
```

```{r}
#Plotting DAGs
ggdag_paths(bigger_dag)
```

```{r}
ggdag_parents(bigger_dag, "x")
```

```{r}
#Plotting directly in ggplot2
bigger_dag %>% 
    node_parents("x") %>%
    ggplot(aes(x = x, y = y, xend = xend, yend = yend, color = parent)) +
      geom_dag_point() +
      geom_dag_edges() +
      geom_dag_text(col = "white") +
      theme_dag() +
      scale_color_hue(breaks  = c("parent", "child")) #  ignores NA in legend
```

```{r}
cavity_dag <- dagify("Cavity" ~ "Lineage" + "Drug resistance" + "Country" + "Diabetes" + "HIV infection" + "Age" + "Immigrant" + "U",
                     "Lineage" ~ "Country" + "Age" + "Immigrant",
                     "Drug resistance" ~ "Lineage" + "Country",
                     "Diabetes" ~ "Country",
                     "HIV infection" ~ "Country" + "Age" + "Immigrant" + "Sex",
                     "Age" ~ "Country",
                     "Immigrant" ~ "Country",
                     "U" ~ "Country",
                     exposure = "Lineage",
                     outcome = "Cavity")
dag_paths(cavity_dag)
```

```{r}
#Plotting DAGs
ggdag_paths(cavity_dag)
```

```{r}
ggdag_parents(cavity_dag, "Lineage")
```

```{r}
#Plotting directly in ggplot2
cavity_dag %>% 
    node_parents("Lineage") %>%
    ggplot(aes(x = x, y = y, xend = xend, yend = yend, color = parent)) +
      geom_dag_point() +
      geom_dag_edges() +
      geom_dag_text(col = "white") +
      theme_dag() +
      scale_color_hue(breaks  = c("parent", "child")) #  ignores NA in legend
```
```{r}
library(CMAverse)
cmdag(outcome = "Cavity", exposure = "Lineage", mediator = "Drug resistance",
      basec = c("Country", "Diabetes", "HIV infection", "Age", "Immigrant", "U"), postc = NULL, node = TRUE, text_col = "white")
```

## Lineage and Cavity

### Option 1: OR - Imputation, bootstrap

```{r, warning=FALSE, message=FALSE}
lin_cavity <- all2_new %>% filter((country=="indonesia" & pul2==1) | (country!="indonesia" & pulmonary=="Yes")) %>% 
  mutate(cavity=ifelse(cavity=="Yes", 1, 0),
         mdr2=NA,
         mdr2=ifelse(mdr=="Drug susceptible", 0,
                     ifelse(mdr=="Isoniazid resistance", 1,
                            ifelse(mdr=="Rifampicin resistance", 1, mdr2)))) %>%
  dplyr::select(lineage, cavity, country, age, age10, immi, mdr2) %>%
  filter(!is.na(lineage) & !is.na(cavity) & !is.na(country) & !is.na(mdr2))

# CMAverse package
######################################
####### Controlled Direct Effect######
######### Natural Effects ############
######################################
#install.packages("devtools", dependencies = TRUE)
#devtools::install_github("BS1125/CMAverse")
library(CMAverse)
library(ggplot2)

## run mediation analysis with interaction using cmest()
mediation.int.m0_l2 <- cmest(data = lin_cavity, model = "rb", casecontrol = FALSE, yrare = F,
                         outcome = "cavity", 
                         exposure = "lineage", mediator = "mdr2", EMint = F,
                         basec = c("country", "age10", "immi"), 
                         mreg = list("logistic"), yreg = "logistic", 
                         a = "Lineage 2", astar = "Lineage 1", mval = list(0),
                         yval = 1,
                         estimation = "imputation", inference = "bootstrap", nboot=1000)

mediation.int.m0_l3 <- cmest(data = lin_cavity, model = "rb", casecontrol = FALSE, yrare = F,
                         outcome = "cavity", 
                         exposure = "lineage", mediator = "mdr2", EMint = F,
                         basec = c("country", "age10", "immi"), 
                         mreg = list("logistic"), yreg = "logistic", 
                         a = "Lineage 3", astar = "Lineage 1", mval = list(0),
                         yval = 1,
                         estimation = "imputation", inference = "bootstrap", nboot=1000)

mediation.int.m0_l4 <- cmest(data = lin_cavity, model = "rb", casecontrol = FALSE, yrare = F,
                         outcome = "cavity", 
                         exposure = "lineage", mediator = "mdr2", EMint = F,
                         basec = c("country", "age10", "immi"), 
                         mreg = list("logistic"), yreg = "logistic", 
                         a = "Lineage 4", astar = "Lineage 1", mval = list(0),
                         yval = 1,
                         estimation = "imputation", inference = "bootstrap", nboot=1000)

summary(mediation.int.m0_l2)
summary(mediation.int.m0_l3)
summary(mediation.int.m0_l4)

terms2<-c("NDE", "NIE", "TE")
coefs2<-c(mediation.int.m0_l2[[9]][3], mediation.int.m0_l2[[9]][5], mediation.int.m0_l2[[9]][6])
lcis2<-c(mediation.int.m0_l2[[11]][3], mediation.int.m0_l2[[11]][5], mediation.int.m0_l2[[11]][6])
ucis2<-c(mediation.int.m0_l2[[12]][3], mediation.int.m0_l2[[12]][5], mediation.int.m0_l2[[12]][6])
pval2<-c(mediation.int.m0_l2[[13]][3], mediation.int.m0_l2[[13]][5], mediation.int.m0_l2[[13]][6])

df2<-data.frame(terms2, coefs2, lcis2, ucis2, pval2)

g2 <- df2 %>%
  ggplot(aes(x=factor(terms2, levels = c("NDE", "NIE", "TE")), 
             y=log(coefs2))) +
  geom_point(size=1, color="blue") +
  geom_errorbar(aes(ymin=log(lcis2), ymax=log(ucis2)), width=0.2, size=0.5) +
  xlab("Lineage 2") +
  ylab("Point Estimate and 95% CI") +
  # geom_hline(aes(yintercept = 0), linetype = NA, color=NA) +
  geom_hline(aes(yintercept = 0), linetype = "dashed", color="red", size=1) +
  # scale_y_log10(breaks=log10(c("0.0", "0.5", "1.0", "1.5")),
  #                    labels = c("0.0", "0.5", "1.0", "1.5")) +
  # scale_y_continuous(breaks=log10(c(1, 3.162278, 10, 31.62278, 100)),
  #                    labels = c("0.0", "0.5", "1.0", "1.5", "2.0")) +
  scale_y_continuous(breaks=log(c(seq(0.4, 1.4, by=0.2))),
                     labels=c(seq(0.4, 1.4, by=0.2))) +
  # 0.1,0.32,1,3.16,10,31.6, 100
  theme(axis.text=element_text(size=18),
        text = element_text(size=20)) +
  annotate("text", x=2, y=log(1.4), label=paste0("p-value==",bquote(.(formatC(as.numeric(mediation.int.m0_l2[[13]][5]),3,format="f")))), parse = TRUE, size=8)

terms3<-c("NDE", "NIE", "TE")
coefs3<-c(mediation.int.m0_l3[[9]][3], mediation.int.m0_l3[[9]][5], mediation.int.m0_l3[[9]][6])
lcis3<-c(mediation.int.m0_l3[[11]][3], mediation.int.m0_l3[[11]][5], mediation.int.m0_l3[[11]][6])
ucis3<-c(mediation.int.m0_l3[[12]][3], mediation.int.m0_l3[[12]][5], mediation.int.m0_l3[[12]][6])
pval3<-c(mediation.int.m0_l3[[13]][3], mediation.int.m0_l3[[13]][5], mediation.int.m0_l3[[13]][6])

df3<-data.frame(terms3, coefs3, lcis3, ucis3, pval3)

g3 <- df3 %>%
  ggplot(aes(x=factor(terms2, levels = c("NDE", "NIE", "TE")), 
             y=log(coefs3))) +
  geom_point(size=1, color="blue") +
  geom_errorbar(aes(ymin=log(lcis3), ymax=log(ucis3)), width=0.2, size=0.5) +
  xlab("Lineage 3") +
  ylab("Point Estimate and 95% CI") +
  geom_hline(aes(yintercept = 0), linetype = "dashed", color="red", size=1) +
  scale_y_continuous(breaks=log(c(seq(0.4, 1.4, by=0.2))),
                     labels=c(seq(0.4, 1.4, by=0.2))) +
  theme(axis.text=element_text(size=18),
        text = element_text(size=20)) +
  annotate("text", x=2, y=log(1.4), label=paste0("p-value==",bquote(.(formatC(as.numeric(mediation.int.m0_l3[[13]][5]),3,format="f")))), parse = TRUE, size=8)

terms4<-c("NDE", "NIE", "TE")
coefs4<-c(mediation.int.m0_l4[[9]][3], mediation.int.m0_l4[[9]][5], mediation.int.m0_l4[[9]][6])
lcis4<-c(mediation.int.m0_l4[[11]][3], mediation.int.m0_l4[[11]][5], mediation.int.m0_l4[[11]][6])
ucis4<-c(mediation.int.m0_l4[[12]][3], mediation.int.m0_l4[[12]][5], mediation.int.m0_l4[[12]][6])
pval4<-c(mediation.int.m0_l4[[13]][3], mediation.int.m0_l4[[13]][5], mediation.int.m0_l4[[13]][6])

df4<-data.frame(terms4, coefs4, lcis4, ucis4, pval4)

g4 <- df4 %>%
  ggplot(aes(x=factor(terms2, levels = c("NDE", "NIE", "TE")), 
             y=log(coefs4))) +
  geom_point(size=1, color="blue") +
  geom_errorbar(aes(ymin=log(lcis4), ymax=log(ucis4)), width=0.2, size=0.5) +
  xlab("Lineage 4") +
  ylab("Point Estimate and 95% CI") +
  geom_hline(aes(yintercept = 0), linetype = "dashed", color="red", size=1) +
  scale_y_continuous(breaks=log(c(seq(0.4, 1.4, by=0.2))),
                     labels=c(seq(0.4, 1.4, by=0.2))) +
  theme(axis.text=element_text(size=18),
        text = element_text(size=20)) +
  annotate("text", x=2, y=log(1.4), label=paste0("p-value==",bquote(.(formatC(as.numeric(mediation.int.m0_l4[[13]][5]),3,format="f")))), parse = TRUE, size=8)

library(flextable)
t2 <- flextable::flextable(df2)
t3 <- flextable::flextable(df3)
t4 <- flextable::flextable(df4)
t2
t3
t4

yreg <- glm(cavity ~ lineage + mdr2 + country + age10 + immi, family = binomial(), data = lin_cavity)
#Ratio, confidence interval, and P-value
cbind(exp(cbind(coef(yreg), confint(yreg))), summary(yreg)[12][[1]][,4])

mreg <- glm(mdr2 ~ lineage + country + age10 + immi, family = binomial(), data = lin_cavity)
#Ratio, confidence interval, and P-value
cbind(exp(cbind(coef(mreg), confint(mreg))), summary(mreg)[12][[1]][,4])
```

```{r plot med_lin_cavity}
plot1 <- ggarrange(g2,g3,g4,nrow = 1, ncol = 3, labels = NULL, hjust=-1.7, vjust=1.5, font.label = list(size=30))
annotate_figure(plot1, top = text_grob("CMA of the effect of lineage on cavity mediated by drug resistance", 
               color = "red", face = "bold", size = 30))

ggsave("med_lin_cavity.png")
```

```{r, message=FALSE, warning=FALSE}
######################################
####### Sensitivity Analysis #########
###### Unmeasured confounding ########
######################################

cmsens(mediation.int.m0_l2, sens="uc")
cmsens(mediation.int.m0_l3, sens="uc")
cmsens(mediation.int.m0_l4, sens="uc")

terms2<-c("NDE", "NIE", "TE")
coefs2<-c(mediation.int.m0_l2[[9]][3], mediation.int.m0_l2[[9]][5], mediation.int.m0_l2[[9]][6])
lcis2<-c(mediation.int.m0_l2[[11]][3], mediation.int.m0_l2[[11]][5], mediation.int.m0_l2[[11]][6])
ucis2<-c(mediation.int.m0_l2[[12]][3], mediation.int.m0_l2[[12]][5], mediation.int.m0_l2[[12]][6])
pval2<-c(mediation.int.m0_l2[[13]][3], mediation.int.m0_l2[[13]][5], mediation.int.m0_l2[[13]][6])

df2<-data.frame(terms2, coefs2, lcis2, ucis2, pval2)

g2 <- df2 %>%
  ggplot(aes(x=factor(terms2, levels = c("NDE", "NIE", "TE")), 
             y=log(coefs2))) +
  geom_point(size=1, color="blue") +
  geom_errorbar(aes(ymin=log(lcis2), ymax=log(ucis2)), width=0.2, size=0.5) +
  xlab("Lineage 2") +
  ylab("Point Estimate and 95% CI") +
  geom_hline(aes(yintercept = 0), linetype = "dashed", color="red", size=1) +
  scale_y_continuous(breaks=log(c(seq(0.4, 1.4, by=0.2))),
                     labels=c(seq(0.4, 1.4, by=0.2))) +
  theme(axis.text=element_text(size=18),
        text = element_text(size=20)) +
  annotate("text", x=2, y=log(1.4), label=paste0("p-value==",bquote(.(formatC(as.numeric(mediation.int.m0_l2[[13]][5]),3,format="f")))), parse = TRUE, size=8)

terms3<-c("NDE", "NIE", "TE")
coefs3<-c(mediation.int.m0_l3[[9]][3], mediation.int.m0_l3[[9]][5], mediation.int.m0_l3[[9]][6])
lcis3<-c(mediation.int.m0_l3[[11]][3], mediation.int.m0_l3[[11]][5], mediation.int.m0_l3[[11]][6])
ucis3<-c(mediation.int.m0_l3[[12]][3], mediation.int.m0_l3[[12]][5], mediation.int.m0_l3[[12]][6])
pval3<-c(mediation.int.m0_l3[[13]][3], mediation.int.m0_l3[[13]][5], mediation.int.m0_l3[[13]][6])

df3<-data.frame(terms3, coefs3, lcis3, ucis3, pval3)

g3 <- df3 %>%
  ggplot(aes(x=factor(terms2, levels = c("NDE", "NIE", "TE")), 
             y=log(coefs3))) +
  geom_point(size=1, color="blue") +
  geom_errorbar(aes(ymin=log(lcis3), ymax=log(ucis3)), width=0.2, size=0.5) +
  xlab("Lineage 3") +
  ylab("Point Estimate and 95% CI") +
  geom_hline(aes(yintercept = 0), linetype = "dashed", color="red", size=1) +
  scale_y_continuous(breaks=log(c(seq(0.4, 1.4, by=0.2))),
                     labels=c(seq(0.4, 1.4, by=0.2))) +
  theme(axis.text=element_text(size=18),
        text = element_text(size=20)) +
  annotate("text", x=2, y=log(1.4), label=paste0("p-value==",bquote(.(formatC(as.numeric(mediation.int.m0_l3[[13]][5]),3,format="f")))), parse = TRUE, size=8)

terms4<-c("NDE", "NIE", "TE")
coefs4<-c(mediation.int.m0_l4[[9]][3], mediation.int.m0_l4[[9]][5], mediation.int.m0_l4[[9]][6])
lcis4<-c(mediation.int.m0_l4[[11]][3], mediation.int.m0_l4[[11]][5], mediation.int.m0_l4[[11]][6])
ucis4<-c(mediation.int.m0_l4[[12]][3], mediation.int.m0_l4[[12]][5], mediation.int.m0_l4[[12]][6])
pval4<-c(mediation.int.m0_l4[[13]][3], mediation.int.m0_l4[[13]][5], mediation.int.m0_l4[[13]][6])

df4<-data.frame(terms4, coefs4, lcis4, ucis4, pval4)

g4 <- df4 %>%
  ggplot(aes(x=factor(terms2, levels = c("NDE", "NIE", "TE")), 
             y=log(coefs4))) +
  geom_point(size=1, color="blue") +
  geom_errorbar(aes(ymin=log(lcis4), ymax=log(ucis4)), width=0.2, size=0.5) +
  xlab("Lineage 4") +
  ylab("Point Estimate and 95% CI") +
  geom_hline(aes(yintercept = 0), linetype = "dashed", color="red", size=1) +
  scale_y_continuous(breaks=log(c(seq(0.4, 1.4, by=0.2))),
                     labels=c(seq(0.4, 1.4, by=0.2))) +
  theme(axis.text=element_text(size=18),
        text = element_text(size=20)) +
  annotate("text", x=2, y=log(1.4), label=paste0("p-value==",bquote(.(formatC(as.numeric(mediation.int.m0_l4[[13]][5]),3,format="f")))), parse = TRUE, size=8)

library(flextable)
t2 <- flextable::flextable(df2)
t3 <- flextable::flextable(df3)
t4 <- flextable::flextable(df4)
t2
t3
t4
```

```{r plot med_lin_cavity2}
plot1_sen <- ggarrange(g2,g3,g4,nrow = 1, ncol = 3, labels = NULL, hjust=-1.7, vjust=1.5, font.label = list(size=30))
annotate_figure(plot1_sen, top = text_grob("Sensitivity analysis (CMA) of the effect of lineage on cavity mediated by drug resistance", 
               color = "red", face = "bold", size = 30))

ggsave("med_lin_cavity_sen.png")
```

### Option 1: OR - Imputation, bootstrap with diabetes

```{r, warning=FALSE, message=FALSE}
lin_cavity <- all2_new %>% filter(pulmonary=="Yes") %>% 
  mutate(cavity=ifelse(cavity=="Yes", 1, 0),
         dm=ifelse(dm=="Yes", 1, 0),
         mdr2=NA,
         mdr2=ifelse(mdr=="Drug susceptible", 0,
                     ifelse(mdr=="Isoniazid resistance", 1,
                            ifelse(mdr=="Rifampicin resistance", 1, mdr2)))) %>%
  dplyr::select(lineage, cavity, country, age, age10, immi, mdr2, dm) %>%
  filter(!is.na(lineage) & !is.na(cavity) & !is.na(country) & !is.na(mdr2) & !is.na(dm))

# CMAverse package
######################################
####### Controlled Direct Effect######
######### Natural Effects ############
######################################
#install.packages("devtools", dependencies = TRUE)
#devtools::install_github("BS1125/CMAverse")
library(CMAverse)
library(ggplot2)

## run mediation analysis with interaction using cmest()
mediation.int.m0_l2 <- cmest(data = lin_cavity, model = "rb", casecontrol = FALSE, yrare = F,
                         outcome = "cavity", 
                         exposure = "lineage", mediator = "mdr2", EMint = F,
                         basec = c("country", "age10", "immi", "dm"), 
                         mreg = list("logistic"), yreg = "logistic", 
                         a = "Lineage 2", astar = "Lineage 1", mval = list(0),
                         yval = 1,
                         estimation = "imputation", inference = "bootstrap", nboot=1000)

mediation.int.m0_l3 <- cmest(data = lin_cavity, model = "rb", casecontrol = FALSE, yrare = F,
                         outcome = "cavity", 
                         exposure = "lineage", mediator = "mdr2", EMint = F,
                         basec = c("country", "age10", "immi", "dm"), 
                         mreg = list("logistic"), yreg = "logistic", 
                         a = "Lineage 3", astar = "Lineage 1", mval = list(0),
                         yval = 1,
                         estimation = "imputation", inference = "bootstrap", nboot=1000)

mediation.int.m0_l4 <- cmest(data = lin_cavity, model = "rb", casecontrol = FALSE, yrare = F,
                         outcome = "cavity", 
                         exposure = "lineage", mediator = "mdr2", EMint = F,
                         basec = c("country", "age10", "immi", "dm"), 
                         mreg = list("logistic"), yreg = "logistic", 
                         a = "Lineage 4", astar = "Lineage 1", mval = list(0),
                         yval = 1,
                         estimation = "imputation", inference = "bootstrap", nboot=1000)

summary(mediation.int.m0_l2)
summary(mediation.int.m0_l3)
summary(mediation.int.m0_l4)

terms2<-c("NDE", "NIE", "TE")
coefs2<-c(mediation.int.m0_l2[[9]][3], mediation.int.m0_l2[[9]][5], mediation.int.m0_l2[[9]][6])
lcis2<-c(mediation.int.m0_l2[[11]][3], mediation.int.m0_l2[[11]][5], mediation.int.m0_l2[[11]][6])
ucis2<-c(mediation.int.m0_l2[[12]][3], mediation.int.m0_l2[[12]][5], mediation.int.m0_l2[[12]][6])
pval2<-c(mediation.int.m0_l2[[13]][3], mediation.int.m0_l2[[13]][5], mediation.int.m0_l2[[13]][6])

df2<-data.frame(terms2, coefs2, lcis2, ucis2, pval2)

terms3<-c("NDE", "NIE", "TE")
coefs3<-c(mediation.int.m0_l3[[9]][3], mediation.int.m0_l3[[9]][5], mediation.int.m0_l3[[9]][6])
lcis3<-c(mediation.int.m0_l3[[11]][3], mediation.int.m0_l3[[11]][5], mediation.int.m0_l3[[11]][6])
ucis3<-c(mediation.int.m0_l3[[12]][3], mediation.int.m0_l3[[12]][5], mediation.int.m0_l3[[12]][6])
pval3<-c(mediation.int.m0_l3[[13]][3], mediation.int.m0_l3[[13]][5], mediation.int.m0_l3[[13]][6])

df3<-data.frame(terms3, coefs3, lcis3, ucis3, pval3)

terms4<-c("NDE", "NIE", "TE")
coefs4<-c(mediation.int.m0_l4[[9]][3], mediation.int.m0_l4[[9]][5], mediation.int.m0_l4[[9]][6])
lcis4<-c(mediation.int.m0_l4[[11]][3], mediation.int.m0_l4[[11]][5], mediation.int.m0_l4[[11]][6])
ucis4<-c(mediation.int.m0_l4[[12]][3], mediation.int.m0_l4[[12]][5], mediation.int.m0_l4[[12]][6])
pval4<-c(mediation.int.m0_l4[[13]][3], mediation.int.m0_l4[[13]][5], mediation.int.m0_l4[[13]][6])

df4<-data.frame(terms4, coefs4, lcis4, ucis4, pval4)

library(flextable)
t2 <- flextable::flextable(df2)
t3 <- flextable::flextable(df3)
t4 <- flextable::flextable(df4)
t2
t3
t4

yreg <- glm(cavity ~ lineage + mdr2 + country + age10 + immi + dm, family = binomial(), data = lin_cavity)
#Ratio, confidence interval, and P-value
cbind(exp(cbind(coef(yreg), confint(yreg))), summary(yreg)[12][[1]][,4])

mreg <- glm(mdr2 ~ lineage + country + age10 + immi + dm, family = binomial(), data = lin_cavity)
#Ratio, confidence interval, and P-value
cbind(exp(cbind(coef(mreg), confint(mreg))), summary(mreg)[12][[1]][,4])
```

### Option 2: OR - Parametric, delta

```{r, warning=FALSE, message=FALSE}
lin_cavity <- all2_new %>% filter(pulmonary=="Yes") %>% 
  mutate(cavity=ifelse(cavity=="Yes", 1, 0),
         mdr2=NA,
         mdr2=ifelse(mdr=="Drug susceptible", 0,
                     ifelse(mdr=="Isoniazid resistance", 1,
                            ifelse(mdr=="Rifampicin resistance", 1, mdr2)))) %>%
  dplyr::select(lineage, cavity, country, age, age10, immi, mdr2) %>%
  filter(!is.na(lineage) & !is.na(cavity) & !is.na(country) & !is.na(mdr2))

# CMAverse package
######################################
####### Controlled Direct Effect######
######### Natural Effects ############
######################################
#install.packages("devtools", dependencies = TRUE)
#devtools::install_github("BS1125/CMAverse")
library(CMAverse)
library(ggplot2)

## run mediation analysis with interaction using cmest()
mediation.int.m0_l2 <- cmest(data = lin_cavity, model = "rb", casecontrol = FALSE, yrare = F,
                         outcome = "cavity", 
                         exposure = "lineage", mediator = "mdr2", EMint = F,
                         basec = c("country", "age10", "immi"), 
                         mreg = list("logistic"), yreg = "logistic", 
                         a = "Lineage 2", astar = "Lineage 1", mval = list(0),
                         yval = 1,
                         estimation = "paramfunc", inference = "delta")

mediation.int.m0_l3 <- cmest(data = lin_cavity, model = "rb", casecontrol = FALSE, yrare = F,
                         outcome = "cavity", 
                         exposure = "lineage", mediator = "mdr2", EMint = F,
                         basec = c("country", "age10", "immi"), 
                         mreg = list("logistic"), yreg = "logistic", 
                         a = "Lineage 3", astar = "Lineage 1", mval = list(0),
                         yval = 1,
                         estimation = "paramfunc", inference = "delta")

mediation.int.m0_l4 <- cmest(data = lin_cavity, model = "rb", casecontrol = FALSE, yrare = F,
                         outcome = "cavity", 
                         exposure = "lineage", mediator = "mdr2", EMint = F,
                         basec = c("country", "age10", "immi"), 
                         mreg = list("logistic"), yreg = "logistic", 
                         a = "Lineage 4", astar = "Lineage 1", mval = list(0),
                         yval = 1,
                         estimation = "paramfunc", inference = "delta")

summary(mediation.int.m0_l2)
summary(mediation.int.m0_l3)
summary(mediation.int.m0_l4)

terms2<-c("NDE", "NIE", "TE")
coefs2<-c(mediation.int.m0_l2[[9]][3], mediation.int.m0_l2[[9]][5], mediation.int.m0_l2[[9]][6])
lcis2<-c(mediation.int.m0_l2[[11]][3], mediation.int.m0_l2[[11]][5], mediation.int.m0_l2[[11]][6])
ucis2<-c(mediation.int.m0_l2[[12]][3], mediation.int.m0_l2[[12]][5], mediation.int.m0_l2[[12]][6])
pval2<-c(mediation.int.m0_l2[[13]][3], mediation.int.m0_l2[[13]][5], mediation.int.m0_l2[[13]][6])

df2<-data.frame(terms2, coefs2, lcis2, ucis2, pval2)

terms3<-c("NDE", "NIE", "TE")
coefs3<-c(mediation.int.m0_l3[[9]][3], mediation.int.m0_l3[[9]][5], mediation.int.m0_l3[[9]][6])
lcis3<-c(mediation.int.m0_l3[[11]][3], mediation.int.m0_l3[[11]][5], mediation.int.m0_l3[[11]][6])
ucis3<-c(mediation.int.m0_l3[[12]][3], mediation.int.m0_l3[[12]][5], mediation.int.m0_l3[[12]][6])
pval3<-c(mediation.int.m0_l3[[13]][3], mediation.int.m0_l3[[13]][5], mediation.int.m0_l3[[13]][6])

df3<-data.frame(terms3, coefs3, lcis3, ucis3, pval3)

terms4<-c("NDE", "NIE", "TE")
coefs4<-c(mediation.int.m0_l4[[9]][3], mediation.int.m0_l4[[9]][5], mediation.int.m0_l4[[9]][6])
lcis4<-c(mediation.int.m0_l4[[11]][3], mediation.int.m0_l4[[11]][5], mediation.int.m0_l4[[11]][6])
ucis4<-c(mediation.int.m0_l4[[12]][3], mediation.int.m0_l4[[12]][5], mediation.int.m0_l4[[12]][6])
pval4<-c(mediation.int.m0_l4[[13]][3], mediation.int.m0_l4[[13]][5], mediation.int.m0_l4[[13]][6])

df4<-data.frame(terms4, coefs4, lcis4, ucis4, pval4)

library(flextable)
t2 <- flextable::flextable(df2)
t3 <- flextable::flextable(df3)
t4 <- flextable::flextable(df4)
t2
t3
t4

yreg <- glm(cavity ~ lineage + mdr2 + country + age10 + immi, family = binomial(), data = lin_cavity)
#Ratio, confidence interval, and P-value
cbind(exp(cbind(coef(yreg), confint(yreg))), summary(yreg)[12][[1]][,4])

mreg <- glm(mdr2 ~ lineage + country + age10 + immi, family = binomial(), data = lin_cavity)
#Ratio, confidence interval, and P-value
cbind(exp(cbind(coef(mreg), confint(mreg))), summary(mreg)[12][[1]][,4])
```

### Option 3: RR - Imputation, bootstrap

```{r, warning=FALSE, message=FALSE}
lin_cavity <- all2_new %>% filter(pulmonary=="Yes") %>% 
  mutate(cavity=ifelse(cavity=="Yes", 1, 0),
         mdr2=NA,
         mdr2=ifelse(mdr=="Drug susceptible", 0,
                     ifelse(mdr=="Isoniazid resistance", 1,
                            ifelse(mdr=="Rifampicin resistance", 1, mdr2)))) %>%
  dplyr::select(lineage, cavity, country, age, age10, immi, mdr2) %>%
  filter(!is.na(lineage) & !is.na(cavity) & !is.na(country) & !is.na(mdr2))

# CMAverse package
######################################
####### Controlled Direct Effect######
######### Natural Effects ############
######################################
#install.packages("devtools", dependencies = TRUE)
#devtools::install_github("BS1125/CMAverse")
library(CMAverse)
library(ggplot2)

## run mediation analysis with interaction using cmest()
mediation.int.m0_l2 <- cmest(data = lin_cavity, model = "rb", casecontrol = FALSE, yrare = F,
                         outcome = "cavity", 
                         exposure = "lineage", mediator = "mdr2", EMint = F,
                         basec = c("country", "age10", "immi"), 
                         mreg = list("logistic"), yreg = "loglinear", 
                         a = "Lineage 2", astar = "Lineage 1", mval = list(0),
                         yval = 1,
                         estimation = "imputation", inference = "bootstrap", nboot=1000)

mediation.int.m0_l3 <- cmest(data = lin_cavity, model = "rb", casecontrol = FALSE, yrare = F,
                         outcome = "cavity", 
                         exposure = "lineage", mediator = "mdr2", EMint = F,
                         basec = c("country", "age10", "immi"), 
                         mreg = list("logistic"), yreg = "loglinear", 
                         a = "Lineage 3", astar = "Lineage 1", mval = list(0),
                         yval = 1,
                         estimation = "imputation", inference = "bootstrap", nboot=1000)

mediation.int.m0_l4 <- cmest(data = lin_cavity, model = "rb", casecontrol = FALSE, yrare = F,
                         outcome = "cavity", 
                         exposure = "lineage", mediator = "mdr2", EMint = F,
                         basec = c("country", "age10", "immi"), 
                         mreg = list("logistic"), yreg = "loglinear", 
                         a = "Lineage 4", astar = "Lineage 1", mval = list(0),
                         yval = 1,
                         estimation = "imputation", inference = "bootstrap", nboot=1000)

summary(mediation.int.m0_l2)
summary(mediation.int.m0_l3)
summary(mediation.int.m0_l4)

terms2<-c("NDE", "NIE", "TE")
coefs2<-c(mediation.int.m0_l2[[9]][3], mediation.int.m0_l2[[9]][5], mediation.int.m0_l2[[9]][6])
lcis2<-c(mediation.int.m0_l2[[11]][3], mediation.int.m0_l2[[11]][5], mediation.int.m0_l2[[11]][6])
ucis2<-c(mediation.int.m0_l2[[12]][3], mediation.int.m0_l2[[12]][5], mediation.int.m0_l2[[12]][6])
pval2<-c(mediation.int.m0_l2[[13]][3], mediation.int.m0_l2[[13]][5], mediation.int.m0_l2[[13]][6])

df2<-data.frame(terms2, coefs2, lcis2, ucis2, pval2)

terms3<-c("NDE", "NIE", "TE")
coefs3<-c(mediation.int.m0_l3[[9]][3], mediation.int.m0_l3[[9]][5], mediation.int.m0_l3[[9]][6])
lcis3<-c(mediation.int.m0_l3[[11]][3], mediation.int.m0_l3[[11]][5], mediation.int.m0_l3[[11]][6])
ucis3<-c(mediation.int.m0_l3[[12]][3], mediation.int.m0_l3[[12]][5], mediation.int.m0_l3[[12]][6])
pval3<-c(mediation.int.m0_l3[[13]][3], mediation.int.m0_l3[[13]][5], mediation.int.m0_l3[[13]][6])

df3<-data.frame(terms3, coefs3, lcis3, ucis3, pval3)

terms4<-c("NDE", "NIE", "TE")
coefs4<-c(mediation.int.m0_l4[[9]][3], mediation.int.m0_l4[[9]][5], mediation.int.m0_l4[[9]][6])
lcis4<-c(mediation.int.m0_l4[[11]][3], mediation.int.m0_l4[[11]][5], mediation.int.m0_l4[[11]][6])
ucis4<-c(mediation.int.m0_l4[[12]][3], mediation.int.m0_l4[[12]][5], mediation.int.m0_l4[[12]][6])
pval4<-c(mediation.int.m0_l4[[13]][3], mediation.int.m0_l4[[13]][5], mediation.int.m0_l4[[13]][6])

df4<-data.frame(terms4, coefs4, lcis4, ucis4, pval4)

library(flextable)
t2 <- flextable::flextable(df2)
t3 <- flextable::flextable(df3)
t4 <- flextable::flextable(df4)
t2
t3
t4

yreg <- glm(cavity ~ lineage + mdr2 + country + age10 + immi, family = poisson(), data = lin_cavity)
#Ratio, confidence interval, and P-value
cbind(exp(cbind(coef(yreg), confint(yreg))), summary(yreg)[12][[1]][,4])

mreg <- glm(mdr2 ~ lineage + country + age10 + immi, family = binomial(), data = lin_cavity)
#Ratio, confidence interval, and P-value
cbind(exp(cbind(coef(mreg), confint(mreg))), summary(mreg)[12][[1]][,4])
```

### Option 4: RR - Parametric, bootstrap

```{r, warning=FALSE, message=FALSE}
lin_cavity <- all2_new %>% filter(pulmonary=="Yes") %>% 
  mutate(cavity=ifelse(cavity=="Yes", 1, 0),
         mdr2=NA,
         mdr2=ifelse(mdr=="Drug susceptible", 0,
                     ifelse(mdr=="Isoniazid resistance", 1,
                            ifelse(mdr=="Rifampicin resistance", 1, mdr2)))) %>%
  dplyr::select(lineage, cavity, country, age, age10, immi, mdr2) %>%
  filter(!is.na(lineage) & !is.na(cavity) & !is.na(country) & !is.na(mdr2))

# CMAverse package
######################################
####### Controlled Direct Effect######
######### Natural Effects ############
######################################
#install.packages("devtools", dependencies = TRUE)
#devtools::install_github("BS1125/CMAverse")
library(CMAverse)
library(ggplot2)

## run mediation analysis with interaction using cmest()
mediation.int.m0_l2 <- cmest(data = lin_cavity, model = "rb", casecontrol = FALSE, yrare = F,
                         outcome = "cavity", 
                         exposure = "lineage", mediator = "mdr2", EMint = F,
                         basec = c("country", "age10", "immi"), 
                         mreg = list("logistic"), yreg = "loglinear", 
                         a = "Lineage 2", astar = "Lineage 1", mval = list(0),
                         yval = 1,
                         estimation = "paramfunc", inference = "bootstrap", nboot=1000)

mediation.int.m0_l3 <- cmest(data = lin_cavity, model = "rb", casecontrol = FALSE, yrare = F,
                         outcome = "cavity", 
                         exposure = "lineage", mediator = "mdr2", EMint = F,
                         basec = c("country", "age10", "immi"), 
                         mreg = list("logistic"), yreg = "loglinear", 
                         a = "Lineage 3", astar = "Lineage 1", mval = list(0),
                         yval = 1,
                         estimation = "paramfunc", inference = "bootstrap", nboot=1000)

mediation.int.m0_l4 <- cmest(data = lin_cavity, model = "rb", casecontrol = FALSE, yrare = F,
                         outcome = "cavity", 
                         exposure = "lineage", mediator = "mdr2", EMint = F,
                         basec = c("country", "age10", "immi"), 
                         mreg = list("logistic"), yreg = "loglinear", 
                         a = "Lineage 4", astar = "Lineage 1", mval = list(0),
                         yval = 1,
                         estimation = "paramfunc", inference = "bootstrap", nboot=1000)

summary(mediation.int.m0_l2)
summary(mediation.int.m0_l3)
summary(mediation.int.m0_l4)

terms2<-c("NDE", "NIE", "TE")
coefs2<-c(mediation.int.m0_l2[[9]][3], mediation.int.m0_l2[[9]][5], mediation.int.m0_l2[[9]][6])
lcis2<-c(mediation.int.m0_l2[[11]][3], mediation.int.m0_l2[[11]][5], mediation.int.m0_l2[[11]][6])
ucis2<-c(mediation.int.m0_l2[[12]][3], mediation.int.m0_l2[[12]][5], mediation.int.m0_l2[[12]][6])
pval2<-c(mediation.int.m0_l2[[13]][3], mediation.int.m0_l2[[13]][5], mediation.int.m0_l2[[13]][6])

df2<-data.frame(terms2, coefs2, lcis2, ucis2, pval2)

terms3<-c("NDE", "NIE", "TE")
coefs3<-c(mediation.int.m0_l3[[9]][3], mediation.int.m0_l3[[9]][5], mediation.int.m0_l3[[9]][6])
lcis3<-c(mediation.int.m0_l3[[11]][3], mediation.int.m0_l3[[11]][5], mediation.int.m0_l3[[11]][6])
ucis3<-c(mediation.int.m0_l3[[12]][3], mediation.int.m0_l3[[12]][5], mediation.int.m0_l3[[12]][6])
pval3<-c(mediation.int.m0_l3[[13]][3], mediation.int.m0_l3[[13]][5], mediation.int.m0_l3[[13]][6])

df3<-data.frame(terms3, coefs3, lcis3, ucis3, pval3)

terms4<-c("NDE", "NIE", "TE")
coefs4<-c(mediation.int.m0_l4[[9]][3], mediation.int.m0_l4[[9]][5], mediation.int.m0_l4[[9]][6])
lcis4<-c(mediation.int.m0_l4[[11]][3], mediation.int.m0_l4[[11]][5], mediation.int.m0_l4[[11]][6])
ucis4<-c(mediation.int.m0_l4[[12]][3], mediation.int.m0_l4[[12]][5], mediation.int.m0_l4[[12]][6])
pval4<-c(mediation.int.m0_l4[[13]][3], mediation.int.m0_l4[[13]][5], mediation.int.m0_l4[[13]][6])

df4<-data.frame(terms4, coefs4, lcis4, ucis4, pval4)

library(flextable)
t2 <- flextable::flextable(df2)
t3 <- flextable::flextable(df3)
t4 <- flextable::flextable(df4)
t2
t3
t4

yreg <- glm(cavity ~ lineage + mdr2 + country + age10 + immi, family = poisson(), data = lin_cavity)
#Ratio, confidence interval, and P-value
cbind(exp(cbind(coef(yreg), confint(yreg))), summary(yreg)[12][[1]][,4])

mreg <- glm(mdr2 ~ lineage + country + age10 + immi, family = binomial(), data = lin_cavity)
#Ratio, confidence interval, and P-value
cbind(exp(cbind(coef(mreg), confint(mreg))), summary(mreg)[12][[1]][,4])
```

### Option 5: RR - Parametric, delta

```{r, warning=FALSE, message=FALSE}
lin_cavity <- all2_new %>% filter(pulmonary=="Yes") %>% 
  mutate(cavity=ifelse(cavity=="Yes", 1, 0),
         mdr2=NA,
         mdr2=ifelse(mdr=="Drug susceptible", 0,
                     ifelse(mdr=="Isoniazid resistance", 1,
                            ifelse(mdr=="Rifampicin resistance", 1, mdr2)))) %>%
  dplyr::select(lineage, cavity, country, age, age10, immi, mdr2) %>%
  filter(!is.na(lineage) & !is.na(cavity) & !is.na(country) & !is.na(mdr2))

# CMAverse package
######################################
####### Controlled Direct Effect######
######### Natural Effects ############
######################################
#install.packages("devtools", dependencies = TRUE)
#devtools::install_github("BS1125/CMAverse")
library(CMAverse)
library(ggplot2)

## run mediation analysis with interaction using cmest()
mediation.int.m0_l2 <- cmest(data = lin_cavity, model = "rb", casecontrol = FALSE, yrare = F,
                         outcome = "cavity", 
                         exposure = "lineage", mediator = "mdr2", EMint = F,
                         basec = c("country", "age10", "immi"), 
                         mreg = list("logistic"), yreg = "loglinear", 
                         a = "Lineage 2", astar = "Lineage 1", mval = list(0),
                         yval = 1,
                         estimation = "paramfunc", inference = "delta")

mediation.int.m0_l3 <- cmest(data = lin_cavity, model = "rb", casecontrol = FALSE, yrare = F,
                         outcome = "cavity", 
                         exposure = "lineage", mediator = "mdr2", EMint = F,
                         basec = c("country", "age10", "immi"), 
                         mreg = list("logistic"), yreg = "loglinear", 
                         a = "Lineage 3", astar = "Lineage 1", mval = list(0),
                         yval = 1,
                         estimation = "paramfunc", inference = "delta")

mediation.int.m0_l4 <- cmest(data = lin_cavity, model = "rb", casecontrol = FALSE, yrare = F,
                         outcome = "cavity", 
                         exposure = "lineage", mediator = "mdr2", EMint = F,
                         basec = c("country", "age10", "immi"), 
                         mreg = list("logistic"), yreg = "loglinear", 
                         a = "Lineage 4", astar = "Lineage 1", mval = list(0),
                         yval = 1,
                         estimation = "paramfunc", inference = "delta")

summary(mediation.int.m0_l2)
summary(mediation.int.m0_l3)
summary(mediation.int.m0_l4)

terms2<-c("NDE", "NIE", "TE")
coefs2<-c(mediation.int.m0_l2[[9]][3], mediation.int.m0_l2[[9]][5], mediation.int.m0_l2[[9]][6])
lcis2<-c(mediation.int.m0_l2[[11]][3], mediation.int.m0_l2[[11]][5], mediation.int.m0_l2[[11]][6])
ucis2<-c(mediation.int.m0_l2[[12]][3], mediation.int.m0_l2[[12]][5], mediation.int.m0_l2[[12]][6])
pval2<-c(mediation.int.m0_l2[[13]][3], mediation.int.m0_l2[[13]][5], mediation.int.m0_l2[[13]][6])

df2<-data.frame(terms2, coefs2, lcis2, ucis2, pval2)

terms3<-c("NDE", "NIE", "TE")
coefs3<-c(mediation.int.m0_l3[[9]][3], mediation.int.m0_l3[[9]][5], mediation.int.m0_l3[[9]][6])
lcis3<-c(mediation.int.m0_l3[[11]][3], mediation.int.m0_l3[[11]][5], mediation.int.m0_l3[[11]][6])
ucis3<-c(mediation.int.m0_l3[[12]][3], mediation.int.m0_l3[[12]][5], mediation.int.m0_l3[[12]][6])
pval3<-c(mediation.int.m0_l3[[13]][3], mediation.int.m0_l3[[13]][5], mediation.int.m0_l3[[13]][6])

df3<-data.frame(terms3, coefs3, lcis3, ucis3, pval3)

terms4<-c("NDE", "NIE", "TE")
coefs4<-c(mediation.int.m0_l4[[9]][3], mediation.int.m0_l4[[9]][5], mediation.int.m0_l4[[9]][6])
lcis4<-c(mediation.int.m0_l4[[11]][3], mediation.int.m0_l4[[11]][5], mediation.int.m0_l4[[11]][6])
ucis4<-c(mediation.int.m0_l4[[12]][3], mediation.int.m0_l4[[12]][5], mediation.int.m0_l4[[12]][6])
pval4<-c(mediation.int.m0_l4[[13]][3], mediation.int.m0_l4[[13]][5], mediation.int.m0_l4[[13]][6])

df4<-data.frame(terms4, coefs4, lcis4, ucis4, pval4)

library(flextable)
t2 <- flextable::flextable(df2)
t3 <- flextable::flextable(df3)
t4 <- flextable::flextable(df4)
t2
t3
t4

yreg <- glm(cavity ~ lineage + mdr2 + country + age10 + immi, family = poisson(), data = lin_cavity)
#Ratio, confidence interval, and P-value
cbind(exp(cbind(coef(yreg), confint(yreg))), summary(yreg)[12][[1]][,4])

mreg <- glm(mdr2 ~ lineage + country + age10 + immi, family = binomial(), data = lin_cavity)
#Ratio, confidence interval, and P-value
cbind(exp(cbind(coef(mreg), confint(mreg))), summary(mreg)[12][[1]][,4])
```

```{r}
# mediation package
#Fit a logistic regression model for drug resistance on lineage
mmodel <- glm(mdr2 ~ lineage  + country + age10 + immi, 
              data= lin_cavity, family = binomial(link = "logit"))
print(summary(mmodel))

#Coefficient and confidence interval:
(cbind(coef(mmodel), confint.default(mmodel)))  
#Odds ratio and confidence interval
exp(cbind(coef(mmodel), confint.default(mmodel)))  

#Fit a multivariable logistic regression model for cavity on drug resistance 
#and lineage adjusted for country, sex, age and immigration.
ymodel1 <- glm(cavity ~ lineage + mdr2 + country + age10 + immi, 
              data= lin_cavity, family = binomial(link = "logit"))
print(ymodel1)

#Coefficient and confidence interval:
(cbind(coef(ymodel1), confint.default(ymodel1)))  

#Required packages: 
require(mediation)

# perform a causal mediation analysis of the effect of lineage on 
# cavity mediated by drug resistance using the previous component models

medeff1 <- mediate(model.m = mmodel, model.y = ymodel1, sims = 1000, 
            interaction = FALSE, treat = "lineage", mediator = "mdr2", 
            control.value = "Lineage 1", treat.value = "Lineage 2", 
            long = TRUE)

print(summary(medeff1))

# ACME" (the average causal mediation effect) is the natural indirect effect, and "ADE" (the average direct effect) is the natural direct effect.
# 
# It seems as though there is evidence of the effect of lineage on cavity being mediated by drug resistance.
# About 8% of the total effect of lineage 2 on the cavity is mediated. P-value <2e-16.


# 
# What does it mean that ACME (treated) is 0.00698?
# 
# 0.00698 is the estimated average increase in the dependent variable among Lineage 2 that arrives as a result of the mediators rather than 'directly' from being lineage itself.
# 
# The dependent variable in this example is the probability of having cavity, the mediator is drug resistance caused by lineage, and the main exposure is lineage. So this number means that of the estimated -0.09394 (the Total Effect) increase in this probability due to lineage, an estimated 0.00732 (ACME (average)) is as a result of the drug resistance changes caused by lineage and the remaining -0.10125 (ADE (average)) is from lineage itself.
# 
# In short Total Effect = ACME (average) + ADE (average)
# 
# However, there is no reason that the average mediation effect (ACME) is the same for people having Lineage 2 and people having Lineage 1, so two mediation effects are estimated: ACME (control) (0.00766) and ACME (treated) (0.00698). The average of these average treatment effects is ACME (average) (which is a bit confusing). A similar argument holds for the direct effects.
# 
# The assumption that there is only one mediation effect and one direct effect in this population is called 'no interference' in the the authors of the package.
# 
# It's helpful when interpreting the output to bear in mind the definitions in the accompanying papers and push your ordinary understanding of regression tables into the background a little bit.
# 
# The proportion of the causal effect of lineage that is mediated by drug resistance rather than direct would normally be calculated as something like ACME (average) / Total Effect, but here it is not (quite). Some discussion of how to compute this quantity for models where the dependent variable is discrete, as it is here, appears in Appendix G of Imai et al. 2010: https://imai.fas.harvard.edu/research/files/BaronKenny.pdf.

```

## Lineage and Pulmonary TB

### Option 1: OR - Imputation, bootstrap

```{r, message=FALSE, warning=FALSE}
#install.packages("labelled")
# install.packages("labelled",dependencies = TRUE)
# install.packages("Rcpp")
# library(labelled)
lin_pul <- all2_new %>% 
  mutate(pulmonary=ifelse(pulmonary=="Yes", 1, 0),
         age10=ifelse(country=="uk", mean(age10[country=="germany"]), age10),
         mdr2=NA,
         mdr2=ifelse(mdr=="Drug susceptible", 0,
                     ifelse(mdr=="Isoniazid resistance", 1,
                            ifelse(mdr=="Rifampicin resistance", 1, mdr2)))) %>%
  dplyr::select(lineage, pulmonary, cavity, country, age, age10, immi, mdr2, hiv, dm) %>% 
  dplyr::filter(country %in% c("germany", "uk", "vietnam", "indonesia")) %>% 
  filter(!is.na(lineage) & !is.na(pulmonary) & !is.na(country) & !is.na(mdr2) & !is.na(immi) & !is.na(age10))

# CMAverse package
######################################
####### Controlled Direct Effect######
######### Natural Effects ############
######################################
#install.packages("devtools", dependencies = TRUE)
#devtools::install_github("BS1125/CMAverse")
library(CMAverse)
library(ggplot2)

## run mediation analysis with interaction using cmest()
mediation.int.m0_l2 <- cmest(data = lin_pul, model = "rb", casecontrol = FALSE, yrare = F,
                         outcome = "pulmonary", 
                         exposure = "lineage", mediator = "mdr2", EMint = F,
                         basec = c("country", "age10", "immi"), 
                         mreg = list("logistic"), yreg = "logistic", 
                         a = "Lineage 2", astar = "Lineage 1", mval = list(0),
                         yval = 1,
                         estimation = "imputation", inference = "bootstrap", nboot = 1000)

mediation.int.m0_l3 <- cmest(data = lin_pul, model = "rb", casecontrol = FALSE, yrare = F,
                         outcome = "pulmonary", 
                         exposure = "lineage", mediator = "mdr2", EMint = F,
                         basec = c("country", "age10", "immi"), 
                         mreg = list("logistic"), yreg = "logistic", 
                         a = "Lineage 3", astar = "Lineage 1", mval = list(0),
                         yval = 1,
                         estimation = "imputation", inference = "bootstrap", nboot = 1000)

mediation.int.m0_l4 <- cmest(data = lin_pul, model = "rb", casecontrol = FALSE, yrare = F,
                         outcome = "pulmonary", 
                         exposure = "lineage", mediator = "mdr2", EMint = F,
                         basec = c("country", "age10", "immi"), 
                         mreg = list("logistic"), yreg = "logistic", 
                         a = "Lineage 4", astar = "Lineage 1", mval = list(0),
                         yval = 1,
                         estimation = "imputation", inference = "bootstrap", nboot = 1000)

summary(mediation.int.m0_l2)
summary(mediation.int.m0_l3)
summary(mediation.int.m0_l4)

terms2<-c("NDE", "NIE", "TE")
coefs2<-c(mediation.int.m0_l2[[9]][3], mediation.int.m0_l2[[9]][5], mediation.int.m0_l2[[9]][6])
lcis2<-c(mediation.int.m0_l2[[11]][3], mediation.int.m0_l2[[11]][5], mediation.int.m0_l2[[11]][6])
ucis2<-c(mediation.int.m0_l2[[12]][3], mediation.int.m0_l2[[12]][5], mediation.int.m0_l2[[12]][6])
pval2<-c(mediation.int.m0_l2[[13]][3], mediation.int.m0_l2[[13]][5], mediation.int.m0_l2[[13]][6])

df2<-data.frame(terms2, coefs2, lcis2, ucis2, pval2)

g2 <- df2 %>%
  ggplot(aes(x=factor(terms2, levels = c("NDE", "NIE", "TE")), 
             y=log(coefs2))) +
  geom_point(size=1, color="blue") +
  geom_errorbar(aes(ymin=log(lcis2), ymax=log(ucis2)), width=0.2, size=0.5) +
  xlab("Lineage 2") +
  ylab("Point Estimate and 95% CI") +
  geom_hline(aes(yintercept = 0), linetype = "dashed", color="red", size=1) +
  scale_y_continuous(breaks=log(c(seq(0.5, 2.5, by=0.5))),
                     labels=c(seq(0.5, 2.5, by=0.5))) +
  theme(axis.text=element_text(size=18),
        text = element_text(size=20)) +
  annotate("text", x=2, y=log(2.5), label=paste0("p-value==",bquote(.(formatC(as.numeric(mediation.int.m0_l2[[13]][5]),3,format="f")))), parse = TRUE, size=8)

terms3<-c("NDE", "NIE", "TE")
coefs3<-c(mediation.int.m0_l3[[9]][3], mediation.int.m0_l3[[9]][5], mediation.int.m0_l3[[9]][6])
lcis3<-c(mediation.int.m0_l3[[11]][3], mediation.int.m0_l3[[11]][5], mediation.int.m0_l3[[11]][6])
ucis3<-c(mediation.int.m0_l3[[12]][3], mediation.int.m0_l3[[12]][5], mediation.int.m0_l3[[12]][6])
pval3<-c(mediation.int.m0_l3[[13]][3], mediation.int.m0_l3[[13]][5], mediation.int.m0_l3[[13]][6])

df3<-data.frame(terms3, coefs3, lcis3, ucis3, pval3)

g3 <- df3 %>%
  ggplot(aes(x=factor(terms2, levels = c("NDE", "NIE", "TE")), 
             y=log(coefs3))) +
  geom_point(size=1, color="blue") +
  geom_errorbar(aes(ymin=log(lcis3), ymax=log(ucis3)), width=0.2, size=0.5) +
  xlab("Lineage 3") +
  ylab("Point Estimate and 95% CI") +
  geom_hline(aes(yintercept = 0), linetype = "dashed", color="red", size=1) +
  scale_y_continuous(breaks=log(c(seq(0, 4, by=1))),
                     labels=c(seq(0, 4, by=1))) +
  theme(axis.text=element_text(size=18),
        text = element_text(size=20)) +
  annotate("text", x=2, y=log(4), label=paste0("p-value==",bquote(.(formatC(as.numeric(mediation.int.m0_l3[[13]][5]),3,format="f")))), parse = TRUE, size=8)

terms4<-c("NDE", "NIE", "TE")
coefs4<-c(mediation.int.m0_l4[[9]][3], mediation.int.m0_l4[[9]][5], mediation.int.m0_l4[[9]][6])
lcis4<-c(mediation.int.m0_l4[[11]][3], mediation.int.m0_l4[[11]][5], mediation.int.m0_l4[[11]][6])
ucis4<-c(mediation.int.m0_l4[[12]][3], mediation.int.m0_l4[[12]][5], mediation.int.m0_l4[[12]][6])
pval4<-c(mediation.int.m0_l4[[13]][3], mediation.int.m0_l4[[13]][5], mediation.int.m0_l4[[13]][6])

df4<-data.frame(terms4, coefs4, lcis4, ucis4, pval4)

g4 <- df4 %>%
  ggplot(aes(x=factor(terms2, levels = c("NDE", "NIE", "TE")), 
             y=log(coefs4))) +
  geom_point(size=1, color="blue") +
  geom_errorbar(aes(ymin=log(lcis4), ymax=log(ucis4)), width=0.2, size=0.5) +
  xlab("Lineage 4") +
  ylab("Point Estimate and 95% CI") +
  geom_hline(aes(yintercept = 0), linetype = "dashed", color="red", size=1) +
  scale_y_continuous(breaks=log(c(seq(0.5, 2.5, by=0.5))),
                     labels=c(seq(0.5, 2.5, by=0.5))) +
  theme(axis.text=element_text(size=18),
        text = element_text(size=20)) +
  annotate("text", x=2, y=log(2.5), label=paste0("p-value==",bquote(.(formatC(as.numeric(mediation.int.m0_l4[[13]][5]),3,format="f")))), parse = TRUE, size=8)

library(flextable)
t2 <- flextable::flextable(df2)
t3 <- flextable::flextable(df3)
t4 <- flextable::flextable(df4)
t2
t3
t4

yreg <- glm(pulmonary ~ lineage + mdr2 + country + age10 + immi, family = binomial(), data = lin_pul)
#Ratio, confidence interval, and P-value
cbind(exp(cbind(coef(yreg), confint(yreg))), summary(yreg)[12][[1]][,4])

mreg <- glm(mdr2 ~ lineage + country + age10 + immi, family = binomial(), data = lin_pul)
#Ratio, confidence interval, and P-value
cbind(exp(cbind(coef(mreg), confint(mreg))), summary(mreg)[12][[1]][,4])
```

```{r plot med_lin_pul}
plot2 <- ggarrange(g2,g3,g4,nrow = 1, ncol = 3, labels = NULL, hjust=-1.7, vjust=1.5, font.label = list(size=30))
annotate_figure(plot2, top = text_grob("CMA of the effect of lineage on pulmonary TB mediated by drug resistance", 
               color = "red", face = "bold", size = 30))

ggsave("med_lin_pul.png")
```

```{r, message=FALSE, warning=FALSE}
######################################
####### Sensitivity Analysis #########
###### Unmeasured confounding ########
######################################

cmsens(mediation.int.m0_l2, sens="uc")
cmsens(mediation.int.m0_l3, sens="uc")
cmsens(mediation.int.m0_l4, sens="uc")

terms2<-c("NDE", "NIE", "TE")
coefs2<-c(mediation.int.m0_l2[[9]][3], mediation.int.m0_l2[[9]][5], mediation.int.m0_l2[[9]][6])
lcis2<-c(mediation.int.m0_l2[[11]][3], mediation.int.m0_l2[[11]][5], mediation.int.m0_l2[[11]][6])
ucis2<-c(mediation.int.m0_l2[[12]][3], mediation.int.m0_l2[[12]][5], mediation.int.m0_l2[[12]][6])
pval2<-c(mediation.int.m0_l2[[13]][3], mediation.int.m0_l2[[13]][5], mediation.int.m0_l2[[13]][6])

df2<-data.frame(terms2, coefs2, lcis2, ucis2, pval2)

g2 <- df2 %>%
  ggplot(aes(x=factor(terms2, levels = c("NDE", "NIE", "TE")), 
             y=log(coefs2))) +
  geom_point(size=1, color="blue") +
  geom_errorbar(aes(ymin=log(lcis2), ymax=log(ucis2)), width=0.2, size=0.5) +
  xlab("Lineage 2") +
  ylab("Point Estimate and 95% CI") +
  geom_hline(aes(yintercept = 0), linetype = "dashed", color="red", size=1) +
  scale_y_continuous(breaks=log(c(seq(0.5, 2.5, by=0.5))),
                     labels=c(seq(0.5, 2.5, by=0.5))) +
  theme(axis.text=element_text(size=18),
        text = element_text(size=20)) +
  annotate("text", x=2, y=log(2.5), label=paste0("p-value==",bquote(.(formatC(as.numeric(mediation.int.m0_l2[[13]][5]),3,format="f")))), parse = TRUE, size=8)

terms3<-c("NDE", "NIE", "TE")
coefs3<-c(mediation.int.m0_l3[[9]][3], mediation.int.m0_l3[[9]][5], mediation.int.m0_l3[[9]][6])
lcis3<-c(mediation.int.m0_l3[[11]][3], mediation.int.m0_l3[[11]][5], mediation.int.m0_l3[[11]][6])
ucis3<-c(mediation.int.m0_l3[[12]][3], mediation.int.m0_l3[[12]][5], mediation.int.m0_l3[[12]][6])
pval3<-c(mediation.int.m0_l3[[13]][3], mediation.int.m0_l3[[13]][5], mediation.int.m0_l3[[13]][6])

df3<-data.frame(terms3, coefs3, lcis3, ucis3, pval3)

g3 <- df3 %>%
  ggplot(aes(x=factor(terms2, levels = c("NDE", "NIE", "TE")), 
             y=log(coefs3))) +
  geom_point(size=1, color="blue") +
  geom_errorbar(aes(ymin=log(lcis3), ymax=log(ucis3)), width=0.2, size=0.5) +
  xlab("Lineage 3") +
  ylab("Point Estimate and 95% CI") +
  geom_hline(aes(yintercept = 0), linetype = "dashed", color="red", size=1) +
  scale_y_continuous(breaks=log(c(seq(0, 4, by=1))),
                     labels=c(seq(0, 4, by=1))) +
  theme(axis.text=element_text(size=18),
        text = element_text(size=20)) +
  annotate("text", x=2, y=log(4), label=paste0("p-value==",bquote(.(formatC(as.numeric(mediation.int.m0_l3[[13]][5]),3,format="f")))), parse = TRUE, size=8)

terms4<-c("NDE", "NIE", "TE")
coefs4<-c(mediation.int.m0_l4[[9]][3], mediation.int.m0_l4[[9]][5], mediation.int.m0_l4[[9]][6])
lcis4<-c(mediation.int.m0_l4[[11]][3], mediation.int.m0_l4[[11]][5], mediation.int.m0_l4[[11]][6])
ucis4<-c(mediation.int.m0_l4[[12]][3], mediation.int.m0_l4[[12]][5], mediation.int.m0_l4[[12]][6])
pval4<-c(mediation.int.m0_l4[[13]][3], mediation.int.m0_l4[[13]][5], mediation.int.m0_l4[[13]][6])

df4<-data.frame(terms4, coefs4, lcis4, ucis4, pval4)

g4 <- df4 %>%
  ggplot(aes(x=factor(terms2, levels = c("NDE", "NIE", "TE")), 
             y=log(coefs4))) +
  geom_point(size=1, color="blue") +
  geom_errorbar(aes(ymin=log(lcis4), ymax=log(ucis4)), width=0.2, size=0.5) +
  xlab("Lineage 4") +
  ylab("Point Estimate and 95% CI") +
  geom_hline(aes(yintercept = 0), linetype = "dashed", color="red", size=1) +
  scale_y_continuous(breaks=log(c(seq(0.5, 2.5, by=0.5))),
                     labels=c(seq(0.5, 2.5, by=0.5))) +
  theme(axis.text=element_text(size=18),
        text = element_text(size=20)) +
  annotate("text", x=2, y=log(2.5), label=paste0("p-value==",bquote(.(formatC(as.numeric(mediation.int.m0_l4[[13]][5]),3,format="f")))), parse = TRUE, size=8)

library(flextable)
t2 <- flextable::flextable(df2)
t3 <- flextable::flextable(df3)
t4 <- flextable::flextable(df4)
t2
t3
t4
```

```{r plot med_lin_pul2}
plot2_sen <- ggarrange(g2,g3,g4,nrow = 1, ncol = 3, labels = NULL, hjust=-1.7, vjust=1.5, font.label = list(size=30))
annotate_figure(plot2_sen, top = text_grob("Sensitivity analysis (CMA) of the effect of lineage on pulmonary TB mediated by drug resistance with interaction", 
               color = "red", face = "bold", size = 30))

ggsave("med_lin_pul_sen.png")
```

### Option 1: OR - Imputation, bootstrap with diabetes

```{r, message=FALSE, warning=FALSE}
#install.packages("labelled")
# install.packages("labelled",dependencies = TRUE)
# install.packages("Rcpp")
# library(labelled)
lin_pul <- all2_new %>% 
  mutate(pulmonary=ifelse(pulmonary=="Yes", 1, 0),
         dm=ifelse(dm=="Yes", 1, 0),
         mdr2=NA,
         mdr2=ifelse(mdr=="Drug susceptible", 0,
                     ifelse(mdr=="Isoniazid resistance", 1,
                            ifelse(mdr=="Rifampicin resistance", 1, mdr2)))) %>%
  dplyr::select(lineage, pulmonary, cavity, country, age, age10, immi, mdr2, hiv, dm) %>% 
  dplyr::filter(country %in% c("germany", "uk", "vietnam", "indonesia")) %>% 
  filter(!is.na(lineage) & !is.na(pulmonary) & !is.na(country) & !is.na(mdr2) & !is.na(dm))

# CMAverse package
######################################
####### Controlled Direct Effect######
######### Natural Effects ############
######################################
#install.packages("devtools", dependencies = TRUE)
#devtools::install_github("BS1125/CMAverse")
library(CMAverse)
library(ggplot2)

## run mediation analysis with interaction using cmest()
mediation.int.m0_l2 <- cmest(data = lin_pul, model = "rb", casecontrol = FALSE, yrare = F,
                         outcome = "pulmonary", 
                         exposure = "lineage", mediator = "mdr2", EMint = F,
                         basec = c("country", "age10", "immi", "dm"), 
                         mreg = list("logistic"), yreg = "logistic", 
                         a = "Lineage 2", astar = "Lineage 1", mval = list(0),
                         yval = 1,
                         estimation = "imputation", inference = "bootstrap", nboot = 1000)

mediation.int.m0_l3 <- cmest(data = lin_pul, model = "rb", casecontrol = FALSE, yrare = F,
                         outcome = "pulmonary", 
                         exposure = "lineage", mediator = "mdr2", EMint = F,
                         basec = c("country", "age10", "immi", "dm"), 
                         mreg = list("logistic"), yreg = "logistic", 
                         a = "Lineage 3", astar = "Lineage 1", mval = list(0),
                         yval = 1,
                         estimation = "imputation", inference = "bootstrap", nboot = 1000)

mediation.int.m0_l4 <- cmest(data = lin_pul, model = "rb", casecontrol = FALSE, yrare = F,
                         outcome = "pulmonary", 
                         exposure = "lineage", mediator = "mdr2", EMint = F,
                         basec = c("country", "age10", "immi", "dm"), 
                         mreg = list("logistic"), yreg = "logistic", 
                         a = "Lineage 4", astar = "Lineage 1", mval = list(0),
                         yval = 1,
                         estimation = "imputation", inference = "bootstrap", nboot = 1000)

summary(mediation.int.m0_l2)
summary(mediation.int.m0_l3)
summary(mediation.int.m0_l4)

terms2<-c("NDE", "NIE", "TE")
coefs2<-c(mediation.int.m0_l2[[9]][3], mediation.int.m0_l2[[9]][5], mediation.int.m0_l2[[9]][6])
lcis2<-c(mediation.int.m0_l2[[11]][3], mediation.int.m0_l2[[11]][5], mediation.int.m0_l2[[11]][6])
ucis2<-c(mediation.int.m0_l2[[12]][3], mediation.int.m0_l2[[12]][5], mediation.int.m0_l2[[12]][6])
pval2<-c(mediation.int.m0_l2[[13]][3], mediation.int.m0_l2[[13]][5], mediation.int.m0_l2[[13]][6])

df2<-data.frame(terms2, coefs2, lcis2, ucis2, pval2)

g2 <- df2 %>%
  ggplot(aes(x=factor(terms2, levels = c("NDE", "NIE", "TE")), 
             y=coefs2)) +
  geom_point(size=1, color="blue") +
  geom_errorbar(aes(ymin=lcis2, ymax=ucis2), width=0.2, size=0.5) +
  xlab("Lineage 2") +
  ylab("Point Estimate and 95% CI") +
  # geom_hline(aes(yintercept = 0), linetype = "dashed", color="red", size=1) +
  geom_hline(aes(yintercept = 1), linetype = "dashed", color="red", size=1) +
  scale_y_continuous(breaks=c(0, 0.5, 1, 1.5, 2, 2.5),
                     labels = c("0.0", "0.5", "1.0", "1.5", "2.0", "2.5")) +
  theme(axis.text=element_text(size=18),
        text = element_text(size=20)) +
  annotate("text", x=2, y=2.5, label=paste0("p-value==",bquote(.(formatC(as.numeric(mediation.int.m0_l2[[13]][5]),3,format="f")))), parse = TRUE, size=8)

terms3<-c("NDE", "NIE", "TE")
coefs3<-c(mediation.int.m0_l3[[9]][3], mediation.int.m0_l3[[9]][5], mediation.int.m0_l3[[9]][6])
lcis3<-c(mediation.int.m0_l3[[11]][3], mediation.int.m0_l3[[11]][5], mediation.int.m0_l3[[11]][6])
ucis3<-c(mediation.int.m0_l3[[12]][3], mediation.int.m0_l3[[12]][5], mediation.int.m0_l3[[12]][6])
pval3<-c(mediation.int.m0_l3[[13]][3], mediation.int.m0_l3[[13]][5], mediation.int.m0_l3[[13]][6])

df3<-data.frame(terms3, coefs3, lcis3, ucis3, pval3)

g3 <- df3 %>%
  ggplot(aes(x=factor(terms3, levels = c("NDE", "NIE", "TE")), 
             y=coefs3)) +
  geom_point(size=1, color="blue") +
  geom_errorbar(aes(ymin=lcis3, ymax=ucis3), width=0.2, size=0.5) +  xlab("Lineage 3") +
  ylab("Point Estimate and 95% CI") +
  # geom_hline(aes(yintercept = 0), linetype = "dashed", color="red", size=1) +
  geom_hline(aes(yintercept = 1), linetype = "dashed", color="red", size=1) +
  scale_y_continuous(breaks=c(-6, -4, -2, 0, 2, 4, 6),
                     labels = c("-6.0", "-4.0", "-2.0", "0.0", "2.0", "4.0", "6.0")) +
  theme(axis.text=element_text(size=18),
        text = element_text(size=20)) +
  annotate("text", x=2, y=4, label=paste0("p-value==",bquote(.(formatC(as.numeric(mediation.int.m0_l3[[13]][5]),3,format="f")))), parse = TRUE, size=8)

terms4<-c("NDE", "NIE", "TE")
coefs4<-c(mediation.int.m0_l4[[9]][3], mediation.int.m0_l4[[9]][5], mediation.int.m0_l4[[9]][6])
lcis4<-c(mediation.int.m0_l4[[11]][3], mediation.int.m0_l4[[11]][5], mediation.int.m0_l4[[11]][6])
ucis4<-c(mediation.int.m0_l4[[12]][3], mediation.int.m0_l4[[12]][5], mediation.int.m0_l4[[12]][6])
pval4<-c(mediation.int.m0_l4[[13]][3], mediation.int.m0_l4[[13]][5], mediation.int.m0_l4[[13]][6])

df4<-data.frame(terms4, coefs4, lcis4, ucis4, pval4)

g4 <- df4 %>%
  ggplot(aes(x=factor(terms4, levels = c("NDE", "NIE", "TE")), 
             y=coefs4)) +
  geom_point(size=1, color="blue") +
  geom_errorbar(aes(ymin=lcis4, ymax=ucis4), width=0.2, size=0.5) +
  xlab("Lineage 4") +
  ylab("Point Estimate and 95% CI") +
  # geom_hline(aes(yintercept = 0), linetype = "dashed", color="red", size=1) +
  geom_hline(aes(yintercept = 1), linetype = "dashed", color="red", size=1) +
  scale_y_continuous(breaks=c(0, 0.5, 1, 1.5, 2, 2.5, 3),
                     labels = c("0.0", "0.5", "1.0", "1.5", "2.0", "2.5", "3.0")) +
  theme(axis.text=element_text(size=18),
        text = element_text(size=20)) +
  annotate("text", x=2, y=2.5, label=paste0("p-value==",bquote(.(formatC(as.numeric(mediation.int.m0_l4[[13]][5]),3,format="f")))), parse = TRUE, size=8)
library(flextable)
t2 <- flextable::flextable(df2)
t3 <- flextable::flextable(df3)
t4 <- flextable::flextable(df4)
t2
t3
t4

yreg <- glm(pulmonary ~ lineage + mdr2 + country + age10 + immi + dm, family = binomial(), data = lin_pul)
#Ratio, confidence interval, and P-value
cbind(exp(cbind(coef(yreg), confint(yreg))), summary(yreg)[12][[1]][,4])

mreg <- glm(mdr2 ~ lineage + country + age10 + immi + dm, family = binomial(), data = lin_pul)
#Ratio, confidence interval, and P-value
cbind(exp(cbind(coef(mreg), confint(mreg))), summary(mreg)[12][[1]][,4])
```

### Option 2: OR - Parametric, delta

```{r, message=FALSE, warning=FALSE}
#install.packages("labelled")
# install.packages("labelled",dependencies = TRUE)
# install.packages("Rcpp")
# library(labelled)
lin_pul <- all2_new %>% 
  mutate(pulmonary=ifelse(pulmonary=="Yes", 1, 0),
         mdr2=NA,
         mdr2=ifelse(mdr=="Drug susceptible", 0,
                     ifelse(mdr=="Isoniazid resistance", 1,
                            ifelse(mdr=="Rifampicin resistance", 1, mdr2)))) %>%
  dplyr::select(lineage, pulmonary, cavity, country, age, age10, immi, mdr2, hiv, dm) %>% 
  dplyr::filter(country %in% c("germany", "uk", "vietnam", "indonesia")) %>% 
  filter(!is.na(lineage) & !is.na(pulmonary) & !is.na(country) & !is.na(mdr2))

# CMAverse package
######################################
####### Controlled Direct Effect######
######### Natural Effects ############
######################################
#install.packages("devtools", dependencies = TRUE)
#devtools::install_github("BS1125/CMAverse")
library(CMAverse)
library(ggplot2)

## run mediation analysis with interaction using cmest()
mediation.int.m0_l2 <- cmest(data = lin_pul, model = "rb", casecontrol = FALSE, yrare = F,
                         outcome = "pulmonary", 
                         exposure = "lineage", mediator = "mdr2", EMint = F,
                         basec = c("country", "age10", "immi"), 
                         mreg = list("logistic"), yreg = "logistic", 
                         a = "Lineage 2", astar = "Lineage 1", mval = list(0),
                         yval = 1,
                         estimation = "paramfunc", inference = "delta")

mediation.int.m0_l3 <- cmest(data = lin_pul, model = "rb", casecontrol = FALSE, yrare = F,
                         outcome = "pulmonary", 
                         exposure = "lineage", mediator = "mdr2", EMint = F,
                         basec = c("country", "age10", "immi"), 
                         mreg = list("logistic"), yreg = "logistic", 
                         a = "Lineage 3", astar = "Lineage 1", mval = list(0),
                         yval = 1,
                         estimation = "paramfunc", inference = "delta")

mediation.int.m0_l4 <- cmest(data = lin_pul, model = "rb", casecontrol = FALSE, yrare = F,
                         outcome = "pulmonary", 
                         exposure = "lineage", mediator = "mdr2", EMint = F,
                         basec = c("country", "age10", "immi"), 
                         mreg = list("logistic"), yreg = "logistic", 
                         a = "Lineage 4", astar = "Lineage 1", mval = list(0),
                         yval = 1,
                         estimation = "paramfunc", inference = "delta")

summary(mediation.int.m0_l2)
summary(mediation.int.m0_l3)
summary(mediation.int.m0_l4)

terms2<-c("NDE", "NIE", "TE")
coefs2<-c(mediation.int.m0_l2[[9]][3], mediation.int.m0_l2[[9]][5], mediation.int.m0_l2[[9]][6])
lcis2<-c(mediation.int.m0_l2[[11]][3], mediation.int.m0_l2[[11]][5], mediation.int.m0_l2[[11]][6])
ucis2<-c(mediation.int.m0_l2[[12]][3], mediation.int.m0_l2[[12]][5], mediation.int.m0_l2[[12]][6])
pval2<-c(mediation.int.m0_l2[[13]][3], mediation.int.m0_l2[[13]][5], mediation.int.m0_l2[[13]][6])

df2<-data.frame(terms2, coefs2, lcis2, ucis2, pval2)

g2 <- df2 %>%
  ggplot(aes(x=factor(terms2, levels = c("NDE", "NIE", "TE")), 
             y=coefs2)) +
  geom_point(size=1, color="blue") +
  geom_errorbar(aes(ymin=lcis2, ymax=ucis2), width=0.2, size=0.5) +
  xlab("Lineage 2") +
  ylab("Point Estimate and 95% CI") +
  geom_hline(aes(yintercept = 0), linetype = "dashed", color="red", size=1) +
  geom_hline(aes(yintercept = 1), linetype = "dashed", color="red", size=1) +
  scale_y_continuous(breaks=c(0, 0.5, 1, 1.5, 2),
                     labels = c("0.0", "0.5", "1.0", "1.5", "2.0")) +
  theme(axis.text=element_text(size=18),
        text = element_text(size=20)) +
  annotate("text", x=2, y=2, label=paste0("p-value==",bquote(.(formatC(as.numeric(mediation.int.m0_l2[[13]][5]),3,format="f")))), parse = TRUE, size=8)

terms3<-c("NDE", "NIE", "TE")
coefs3<-c(mediation.int.m0_l3[[9]][3], mediation.int.m0_l3[[9]][5], mediation.int.m0_l3[[9]][6])
lcis3<-c(mediation.int.m0_l3[[11]][3], mediation.int.m0_l3[[11]][5], mediation.int.m0_l3[[11]][6])
ucis3<-c(mediation.int.m0_l3[[12]][3], mediation.int.m0_l3[[12]][5], mediation.int.m0_l3[[12]][6])
pval3<-c(mediation.int.m0_l3[[13]][3], mediation.int.m0_l3[[13]][5], mediation.int.m0_l3[[13]][6])

df3<-data.frame(terms3, coefs3, lcis3, ucis3, pval3)

g3 <- df3 %>%
  ggplot(aes(x=factor(terms3, levels = c("NDE", "NIE", "TE")), 
             y=coefs3)) +
  geom_point(size=1, color="blue") +
  geom_errorbar(aes(ymin=lcis3, ymax=ucis3), width=0.2, size=0.5) +
  xlab("Lineage 3") +
  ylab("Point Estimate and 95% CI") +
  geom_hline(aes(yintercept = 0), linetype = "dashed", color="red", size=1) +
  geom_hline(aes(yintercept = 1), linetype = "dashed", color="red", size=1) +
  scale_y_continuous(breaks=c(-6, -4, -2, 0, 2, 4, 6),
                     labels = c("-6.0", "-4.0", "-2.0", "0.0", "2.0", "4.0", "6.0")) +
  theme(axis.text=element_text(size=18),
        text = element_text(size=20)) +
  annotate("text", x=2, y=4, label=paste0("p-value==",bquote(.(formatC(as.numeric(mediation.int.m0_l3[[13]][5]),3,format="f")))), parse = TRUE, size=8)

terms4<-c("NDE", "NIE", "TE")
coefs4<-c(mediation.int.m0_l4[[9]][3], mediation.int.m0_l4[[9]][5], mediation.int.m0_l4[[9]][6])
lcis4<-c(mediation.int.m0_l4[[11]][3], mediation.int.m0_l4[[11]][5], mediation.int.m0_l4[[11]][6])
ucis4<-c(mediation.int.m0_l4[[12]][3], mediation.int.m0_l4[[12]][5], mediation.int.m0_l4[[12]][6])
pval4<-c(mediation.int.m0_l4[[13]][3], mediation.int.m0_l4[[13]][5], mediation.int.m0_l4[[13]][6])

df4<-data.frame(terms4, coefs4, lcis4, ucis4, pval4)

g4 <- df4 %>%
  ggplot(aes(x=factor(terms4, levels = c("NDE", "NIE", "TE")), 
             y=coefs4)) +
  geom_point(size=1, color="blue") +
  geom_errorbar(aes(ymin=lcis4, ymax=ucis4), width=0.2, size=0.5) +
  xlab("Lineage 4") +
  ylab("Point Estimate and 95% CI") +
  geom_hline(aes(yintercept = 0), linetype = "dashed", color="red", size=1) +
  geom_hline(aes(yintercept = 1), linetype = "dashed", color="red", size=1) +
  scale_y_continuous(breaks=c(0, 0.5, 1, 1.5, 2, 2.5, 3),
                     labels = c("0.0", "0.5", "1.0", "1.5", "2.0", "2.5", "3.0")) +
  theme(axis.text=element_text(size=18),
        text = element_text(size=20)) +
  annotate("text", x=2, y=2, label=paste0("p-value==",bquote(.(formatC(as.numeric(mediation.int.m0_l4[[13]][5]),3,format="f")))), parse = TRUE, size=8)
library(flextable)
t2 <- flextable::flextable(df2)
t3 <- flextable::flextable(df3)
t4 <- flextable::flextable(df4)
t2
t3
t4

yreg <- glm(pulmonary ~ lineage + mdr2 + country + age10 + immi, family = binomial(), data = lin_pul)
#Ratio, confidence interval, and P-value
cbind(exp(cbind(coef(yreg), confint(yreg))), summary(yreg)[13][[1]][,4])

mreg <- glm(mdr2 ~ lineage + country + age10 + immi, family = binomial(), data = lin_pul)
#Ratio, confidence interval, and P-value
cbind(exp(cbind(coef(mreg), confint(mreg))), summary(mreg)[13][[1]][,4])
```

### Option 3: RR - Imputation, bootstrap

```{r, message=FALSE, warning=FALSE}
#install.packages("labelled")
# install.packages("labelled",dependencies = TRUE)
# install.packages("Rcpp")
# library(labelled)
lin_pul <- all2_new %>% 
  mutate(pulmonary=ifelse(pulmonary=="Yes", 1, 0),
         mdr2=NA,
         mdr2=ifelse(mdr=="Drug susceptible", 0,
                     ifelse(mdr=="Isoniazid resistance", 1,
                            ifelse(mdr=="Rifampicin resistance", 1, mdr2)))) %>%
  dplyr::select(lineage, pulmonary, cavity, country, age, age10, immi, mdr2, hiv, dm) %>% 
  dplyr::filter(country %in% c("germany", "uk", "vietnam", "indonesia")) %>% 
  filter(!is.na(lineage) & !is.na(pulmonary) & !is.na(country) & !is.na(mdr2))

# CMAverse package
######################################
####### Controlled Direct Effect######
######### Natural Effects ############
######################################
#install.packages("devtools", dependencies = TRUE)
#devtools::install_github("BS1125/CMAverse")
library(CMAverse)
library(ggplot2)

## run mediation analysis with interaction using cmest()
mediation.int.m0_l2 <- cmest(data = lin_pul, model = "rb", casecontrol = FALSE, yrare = F,
                         outcome = "pulmonary", 
                         exposure = "lineage", mediator = "mdr2", EMint = F,
                         basec = c("country", "age10", "immi"), 
                         mreg = list("logistic"), yreg = "loglinear", 
                         a = "Lineage 2", astar = "Lineage 1", mval = list(0),
                         yval = 1,
                         estimation = "imputation", inference = "bootstrap", nboot = 1000)

mediation.int.m0_l3 <- cmest(data = lin_pul, model = "rb", casecontrol = FALSE, yrare = F,
                         outcome = "pulmonary", 
                         exposure = "lineage", mediator = "mdr2", EMint = F,
                         basec = c("country", "age10", "immi"), 
                         mreg = list("logistic"), yreg = "loglinear", 
                         a = "Lineage 3", astar = "Lineage 1", mval = list(0),
                         yval = 1,
                         estimation = "imputation", inference = "bootstrap", nboot = 1000)

mediation.int.m0_l4 <- cmest(data = lin_pul, model = "rb", casecontrol = FALSE, yrare = F,
                         outcome = "pulmonary", 
                         exposure = "lineage", mediator = "mdr2", EMint = F,
                         basec = c("country", "age10", "immi"), 
                         mreg = list("logistic"), yreg = "loglinear", 
                         a = "Lineage 4", astar = "Lineage 1", mval = list(0),
                         yval = 1,
                         estimation = "imputation", inference = "bootstrap", nboot = 1000)

summary(mediation.int.m0_l2)
summary(mediation.int.m0_l3)
summary(mediation.int.m0_l4)

terms2<-c("NDE", "NIE", "TE")
coefs2<-c(mediation.int.m0_l2[[9]][3], mediation.int.m0_l2[[9]][5], mediation.int.m0_l2[[9]][6])
lcis2<-c(mediation.int.m0_l2[[11]][3], mediation.int.m0_l2[[11]][5], mediation.int.m0_l2[[11]][6])
ucis2<-c(mediation.int.m0_l2[[12]][3], mediation.int.m0_l2[[12]][5], mediation.int.m0_l2[[12]][6])
pval2<-c(mediation.int.m0_l2[[13]][3], mediation.int.m0_l2[[13]][5], mediation.int.m0_l2[[13]][6])

df2<-data.frame(terms2, coefs2, lcis2, ucis2, pval2)

g2 <- df2 %>%
  ggplot(aes(x=factor(terms2, levels = c("NDE", "NIE", "TE")), 
             y=coefs2)) +
  geom_point(size=1, color="blue") +
  geom_errorbar(aes(ymin=lcis2, ymax=ucis2), width=0.2, size=0.5) +
  xlab("Lineage 2") +
  ylab("Point Estimate and 95% CI") +
  geom_hline(aes(yintercept = 0), linetype = "dashed", color="red", size=1) +
  geom_hline(aes(yintercept = 1), linetype = "dashed", color="red", size=1) +
  scale_y_continuous(breaks=c(0, 0.5, 1, 1.5, 2),
                     labels = c("0.0", "0.5", "1.0", "1.5", "2.0")) +
  theme(axis.text=element_text(size=18),
        text = element_text(size=20)) +
  annotate("text", x=2, y=2, label=paste0("p-value==",bquote(.(formatC(as.numeric(mediation.int.m0_l2[[13]][5]),3,format="f")))), parse = TRUE, size=8)

terms3<-c("NDE", "NIE", "TE")
coefs3<-c(mediation.int.m0_l3[[9]][3], mediation.int.m0_l3[[9]][5], mediation.int.m0_l3[[9]][6])
lcis3<-c(mediation.int.m0_l3[[11]][3], mediation.int.m0_l3[[11]][5], mediation.int.m0_l3[[11]][6])
ucis3<-c(mediation.int.m0_l3[[12]][3], mediation.int.m0_l3[[12]][5], mediation.int.m0_l3[[12]][6])
pval3<-c(mediation.int.m0_l3[[13]][3], mediation.int.m0_l3[[13]][5], mediation.int.m0_l3[[13]][6])

df3<-data.frame(terms3, coefs3, lcis3, ucis3, pval3)

g3 <- df3 %>%
  ggplot(aes(x=factor(terms3, levels = c("NDE", "NIE", "TE")), 
             y=coefs3)) +
  geom_point(size=1, color="blue") +
  geom_errorbar(aes(ymin=lcis3, ymax=ucis3), width=0.2, size=0.5) +
  xlab("Lineage 3") +
  ylab("Point Estimate and 95% CI") +
  geom_hline(aes(yintercept = 0), linetype = "dashed", color="red", size=1) +
  geom_hline(aes(yintercept = 1), linetype = "dashed", color="red", size=1) +
  scale_y_continuous(breaks=c(-6, -4, -2, 0, 2, 4, 6),
                     labels = c("-6.0", "-4.0", "-2.0", "0.0", "2.0", "4.0", "6.0")) +
  theme(axis.text=element_text(size=18),
        text = element_text(size=20)) +
  annotate("text", x=2, y=4, label=paste0("p-value==",bquote(.(formatC(as.numeric(mediation.int.m0_l3[[13]][5]),3,format="f")))), parse = TRUE, size=8)

terms4<-c("NDE", "NIE", "TE")
coefs4<-c(mediation.int.m0_l4[[9]][3], mediation.int.m0_l4[[9]][5], mediation.int.m0_l4[[9]][6])
lcis4<-c(mediation.int.m0_l4[[11]][3], mediation.int.m0_l4[[11]][5], mediation.int.m0_l4[[11]][6])
ucis4<-c(mediation.int.m0_l4[[12]][3], mediation.int.m0_l4[[12]][5], mediation.int.m0_l4[[12]][6])
pval4<-c(mediation.int.m0_l4[[13]][3], mediation.int.m0_l4[[13]][5], mediation.int.m0_l4[[13]][6])

df4<-data.frame(terms4, coefs4, lcis4, ucis4, pval4)

g4 <- df4 %>%
  ggplot(aes(x=factor(terms4, levels = c("NDE", "NIE", "TE")), 
             y=coefs4)) +
  geom_point(size=1, color="blue") +
  geom_errorbar(aes(ymin=lcis4, ymax=ucis4), width=0.2, size=0.5) +
  xlab("Lineage 4") +
  ylab("Point Estimate and 95% CI") +
  geom_hline(aes(yintercept = 0), linetype = "dashed", color="red", size=1) +
  geom_hline(aes(yintercept = 1), linetype = "dashed", color="red", size=1) +
  scale_y_continuous(breaks=c(0, 0.5, 1, 1.5, 2, 2.5, 3),
                     labels = c("0.0", "0.5", "1.0", "1.5", "2.0", "2.5", "3.0")) +
  theme(axis.text=element_text(size=18),
        text = element_text(size=20)) +
  annotate("text", x=2, y=2, label=paste0("p-value==",bquote(.(formatC(as.numeric(mediation.int.m0_l4[[13]][5]),3,format="f")))), parse = TRUE, size=8)
library(flextable)
t2 <- flextable::flextable(df2)
t3 <- flextable::flextable(df3)
t4 <- flextable::flextable(df4)
t2
t3
t4

yreg <- glm(pulmonary ~ lineage + mdr2 + country + age10 + immi, family = poisson(), data = lin_pul)
#Ratio, confidence interval, and P-value
cbind(exp(cbind(coef(yreg), confint(yreg))), summary(yreg)[13][[1]][,4])

mreg <- glm(mdr2 ~ lineage + country + age10 + immi, family = binomial(), data = lin_pul)
#Ratio, confidence interval, and P-value
cbind(exp(cbind(coef(mreg), confint(mreg))), summary(mreg)[13][[1]][,4])
```

### Option 4: RR - Parametric, bootstrap

```{r, message=FALSE, warning=FALSE}
#install.packages("labelled")
# install.packages("labelled",dependencies = TRUE)
# install.packages("Rcpp")
# library(labelled)
lin_pul <- all2_new %>% 
  mutate(pulmonary=ifelse(pulmonary=="Yes", 1, 0),
         mdr2=NA,
         mdr2=ifelse(mdr=="Drug susceptible", 0,
                     ifelse(mdr=="Isoniazid resistance", 1,
                            ifelse(mdr=="Rifampicin resistance", 1, mdr2)))) %>%
  dplyr::select(lineage, pulmonary, cavity, country, age, age10, immi, mdr2, hiv, dm) %>% 
  dplyr::filter(country %in% c("germany", "uk", "vietnam", "indonesia")) %>% 
  filter(!is.na(lineage) & !is.na(pulmonary) & !is.na(country) & !is.na(mdr2))

# CMAverse package
######################################
####### Controlled Direct Effect######
######### Natural Effects ############
######################################
#install.packages("devtools", dependencies = TRUE)
#devtools::install_github("BS1125/CMAverse")
library(CMAverse)
library(ggplot2)

## run mediation analysis with interaction using cmest()
mediation.int.m0_l2 <- cmest(data = lin_pul, model = "rb", casecontrol = FALSE, yrare = F,
                         outcome = "pulmonary", 
                         exposure = "lineage", mediator = "mdr2", EMint = F,
                         basec = c("country", "age10", "immi"), 
                         mreg = list("logistic"), yreg = "loglinear", 
                         a = "Lineage 2", astar = "Lineage 1", mval = list(0),
                         yval = 1,
                         estimation = "paramfunc", inference = "bootstrap", nboot = 1000)

mediation.int.m0_l3 <- cmest(data = lin_pul, model = "rb", casecontrol = FALSE, yrare = F,
                         outcome = "pulmonary", 
                         exposure = "lineage", mediator = "mdr2", EMint = F,
                         basec = c("country", "age10", "immi"), 
                         mreg = list("logistic"), yreg = "loglinear", 
                         a = "Lineage 3", astar = "Lineage 1", mval = list(0),
                         yval = 1,
                         estimation = "paramfunc", inference = "bootstrap", nboot = 1000)

mediation.int.m0_l4 <- cmest(data = lin_pul, model = "rb", casecontrol = FALSE, yrare = F,
                         outcome = "pulmonary", 
                         exposure = "lineage", mediator = "mdr2", EMint = F,
                         basec = c("country", "age10", "immi"), 
                         mreg = list("logistic"), yreg = "loglinear", 
                         a = "Lineage 4", astar = "Lineage 1", mval = list(0),
                         yval = 1,
                         estimation = "paramfunc", inference = "bootstrap", nboot = 1000)

summary(mediation.int.m0_l2)
summary(mediation.int.m0_l3)
summary(mediation.int.m0_l4)

terms2<-c("NDE", "NIE", "TE")
coefs2<-c(mediation.int.m0_l2[[9]][3], mediation.int.m0_l2[[9]][5], mediation.int.m0_l2[[9]][6])
lcis2<-c(mediation.int.m0_l2[[11]][3], mediation.int.m0_l2[[11]][5], mediation.int.m0_l2[[11]][6])
ucis2<-c(mediation.int.m0_l2[[12]][3], mediation.int.m0_l2[[12]][5], mediation.int.m0_l2[[12]][6])
pval2<-c(mediation.int.m0_l2[[13]][3], mediation.int.m0_l2[[13]][5], mediation.int.m0_l2[[13]][6])

df2<-data.frame(terms2, coefs2, lcis2, ucis2, pval2)

g2 <- df2 %>%
  ggplot(aes(x=factor(terms2, levels = c("NDE", "NIE", "TE")), 
             y=coefs2)) +
  geom_point(size=1, color="blue") +
  geom_errorbar(aes(ymin=lcis2, ymax=ucis2), width=0.2, size=0.5) +
  xlab("Lineage 2") +
  ylab("Point Estimate and 95% CI") +
  geom_hline(aes(yintercept = 0), linetype = "dashed", color="red", size=1) +
  geom_hline(aes(yintercept = 1), linetype = "dashed", color="red", size=1) +
  scale_y_continuous(breaks=c(0, 0.5, 1, 1.5, 2),
                     labels = c("0.0", "0.5", "1.0", "1.5", "2.0")) +
  theme(axis.text=element_text(size=18),
        text = element_text(size=20)) +
  annotate("text", x=2, y=2, label=paste0("p-value==",bquote(.(formatC(as.numeric(mediation.int.m0_l2[[13]][5]),3,format="f")))), parse = TRUE, size=8)

terms3<-c("NDE", "NIE", "TE")
coefs3<-c(mediation.int.m0_l3[[9]][3], mediation.int.m0_l3[[9]][5], mediation.int.m0_l3[[9]][6])
lcis3<-c(mediation.int.m0_l3[[11]][3], mediation.int.m0_l3[[11]][5], mediation.int.m0_l3[[11]][6])
ucis3<-c(mediation.int.m0_l3[[12]][3], mediation.int.m0_l3[[12]][5], mediation.int.m0_l3[[12]][6])
pval3<-c(mediation.int.m0_l3[[13]][3], mediation.int.m0_l3[[13]][5], mediation.int.m0_l3[[13]][6])

df3<-data.frame(terms3, coefs3, lcis3, ucis3, pval3)

g3 <- df3 %>%
  ggplot(aes(x=factor(terms3, levels = c("NDE", "NIE", "TE")), 
             y=coefs3)) +
  geom_point(size=1, color="blue") +
  geom_errorbar(aes(ymin=lcis3, ymax=ucis3), width=0.2, size=0.5) +
  xlab("Lineage 3") +
  ylab("Point Estimate and 95% CI") +
  geom_hline(aes(yintercept = 0), linetype = "dashed", color="red", size=1) +
  geom_hline(aes(yintercept = 1), linetype = "dashed", color="red", size=1) +
  scale_y_continuous(breaks=c(-6, -4, -2, 0, 2, 4, 6),
                     labels = c("-6.0", "-4.0", "-2.0", "0.0", "2.0", "4.0", "6.0")) +
  theme(axis.text=element_text(size=18),
        text = element_text(size=20)) +
  annotate("text", x=2, y=4, label=paste0("p-value==",bquote(.(formatC(as.numeric(mediation.int.m0_l3[[13]][5]),3,format="f")))), parse = TRUE, size=8)

terms4<-c("NDE", "NIE", "TE")
coefs4<-c(mediation.int.m0_l4[[9]][3], mediation.int.m0_l4[[9]][5], mediation.int.m0_l4[[9]][6])
lcis4<-c(mediation.int.m0_l4[[11]][3], mediation.int.m0_l4[[11]][5], mediation.int.m0_l4[[11]][6])
ucis4<-c(mediation.int.m0_l4[[12]][3], mediation.int.m0_l4[[12]][5], mediation.int.m0_l4[[12]][6])
pval4<-c(mediation.int.m0_l4[[13]][3], mediation.int.m0_l4[[13]][5], mediation.int.m0_l4[[13]][6])

df4<-data.frame(terms4, coefs4, lcis4, ucis4, pval4)

g4 <- df4 %>%
  ggplot(aes(x=factor(terms4, levels = c("NDE", "NIE", "TE")), 
             y=coefs4)) +
  geom_point(size=1, color="blue") +
  geom_errorbar(aes(ymin=lcis4, ymax=ucis4), width=0.2, size=0.5) +
  xlab("Lineage 4") +
  ylab("Point Estimate and 95% CI") +
  geom_hline(aes(yintercept = 0), linetype = "dashed", color="red", size=1) +
  geom_hline(aes(yintercept = 1), linetype = "dashed", color="red", size=1) +
  scale_y_continuous(breaks=c(0, 0.5, 1, 1.5, 2, 2.5, 3),
                     labels = c("0.0", "0.5", "1.0", "1.5", "2.0", "2.5", "3.0")) +
  theme(axis.text=element_text(size=18),
        text = element_text(size=20)) +
  annotate("text", x=2, y=2, label=paste0("p-value==",bquote(.(formatC(as.numeric(mediation.int.m0_l4[[13]][5]),3,format="f")))), parse = TRUE, size=8)
library(flextable)
t2 <- flextable::flextable(df2)
t3 <- flextable::flextable(df3)
t4 <- flextable::flextable(df4)
t2
t3
t4

yreg <- glm(pulmonary ~ lineage + mdr2 + country + age10 + immi, family = poisson(), data = lin_pul)
#Ratio, confidence interval, and P-value
cbind(exp(cbind(coef(yreg), confint(yreg))), summary(yreg)[13][[1]][,4])

mreg <- glm(mdr2 ~ lineage + country + age10 + immi, family = binomial(), data = lin_pul)
#Ratio, confidence interval, and P-value
cbind(exp(cbind(coef(mreg), confint(mreg))), summary(mreg)[13][[1]][,4])
```

### Option 5: RR - Parametric, delta

```{r, message=FALSE, warning=FALSE}
#install.packages("labelled")
# install.packages("labelled",dependencies = TRUE)
# install.packages("Rcpp")
# library(labelled)
lin_pul <- all2_new %>% 
  mutate(pulmonary=ifelse(pulmonary=="Yes", 1, 0),
         mdr2=NA,
         mdr2=ifelse(mdr=="Drug susceptible", 0,
                     ifelse(mdr=="Isoniazid resistance", 1,
                            ifelse(mdr=="Rifampicin resistance", 1, mdr2)))) %>%
  dplyr::select(lineage, pulmonary, cavity, country, age, age10, immi, mdr2, hiv, dm) %>% 
  dplyr::filter(country %in% c("germany", "uk", "vietnam", "indonesia")) %>% 
  filter(!is.na(lineage) & !is.na(pulmonary) & !is.na(country) & !is.na(mdr2))

# CMAverse package
######################################
####### Controlled Direct Effect######
######### Natural Effects ############
######################################
#install.packages("devtools", dependencies = TRUE)
#devtools::install_github("BS1125/CMAverse")
library(CMAverse)
library(ggplot2)

## run mediation analysis with interaction using cmest()
mediation.int.m0_l2 <- cmest(data = lin_pul, model = "rb", casecontrol = FALSE, yrare = F,
                         outcome = "pulmonary", 
                         exposure = "lineage", mediator = "mdr2", EMint = F,
                         basec = c("country", "age10", "immi"), 
                         mreg = list("logistic"), yreg = "loglinear", 
                         a = "Lineage 2", astar = "Lineage 1", mval = list(0),
                         yval = 1,
                         estimation = "paramfunc", inference = "delta")

mediation.int.m0_l3 <- cmest(data = lin_pul, model = "rb", casecontrol = FALSE, yrare = F,
                         outcome = "pulmonary", 
                         exposure = "lineage", mediator = "mdr2", EMint = F,
                         basec = c("country", "age10", "immi"), 
                         mreg = list("logistic"), yreg = "loglinear", 
                         a = "Lineage 3", astar = "Lineage 1", mval = list(0),
                         yval = 1,
                         estimation = "paramfunc", inference = "delta")

mediation.int.m0_l4 <- cmest(data = lin_pul, model = "rb", casecontrol = FALSE, yrare = F,
                         outcome = "pulmonary", 
                         exposure = "lineage", mediator = "mdr2", EMint = F,
                         basec = c("country", "age10", "immi"), 
                         mreg = list("logistic"), yreg = "loglinear", 
                         a = "Lineage 4", astar = "Lineage 1", mval = list(0),
                         yval = 1,
                         estimation = "paramfunc", inference = "delta")

summary(mediation.int.m0_l2)
summary(mediation.int.m0_l3)
summary(mediation.int.m0_l4)

terms2<-c("NDE", "NIE", "TE")
coefs2<-c(mediation.int.m0_l2[[9]][3], mediation.int.m0_l2[[9]][5], mediation.int.m0_l2[[9]][6])
lcis2<-c(mediation.int.m0_l2[[11]][3], mediation.int.m0_l2[[11]][5], mediation.int.m0_l2[[11]][6])
ucis2<-c(mediation.int.m0_l2[[12]][3], mediation.int.m0_l2[[12]][5], mediation.int.m0_l2[[12]][6])
pval2<-c(mediation.int.m0_l2[[13]][3], mediation.int.m0_l2[[13]][5], mediation.int.m0_l2[[13]][6])

df2<-data.frame(terms2, coefs2, lcis2, ucis2, pval2)

g2 <- df2 %>%
  ggplot(aes(x=factor(terms2, levels = c("NDE", "NIE", "TE")), 
             y=coefs2)) +
  geom_point(size=1, color="blue") +
  geom_errorbar(aes(ymin=lcis2, ymax=ucis2), width=0.2, size=0.5) +
  xlab("Lineage 2") +
  ylab("Point Estimate and 95% CI") +
  geom_hline(aes(yintercept = 0), linetype = "dashed", color="red", size=1) +
  geom_hline(aes(yintercept = 1), linetype = "dashed", color="red", size=1) +
  scale_y_continuous(breaks=c(0, 0.5, 1, 1.5, 2),
                     labels = c("0.0", "0.5", "1.0", "1.5", "2.0")) +
  theme(axis.text=element_text(size=18),
        text = element_text(size=20)) +
  annotate("text", x=2, y=2, label=paste0("p-value==",bquote(.(formatC(as.numeric(mediation.int.m0_l2[[13]][5]),3,format="f")))), parse = TRUE, size=8)

terms3<-c("NDE", "NIE", "TE")
coefs3<-c(mediation.int.m0_l3[[9]][3], mediation.int.m0_l3[[9]][5], mediation.int.m0_l3[[9]][6])
lcis3<-c(mediation.int.m0_l3[[11]][3], mediation.int.m0_l3[[11]][5], mediation.int.m0_l3[[11]][6])
ucis3<-c(mediation.int.m0_l3[[12]][3], mediation.int.m0_l3[[12]][5], mediation.int.m0_l3[[12]][6])
pval3<-c(mediation.int.m0_l3[[13]][3], mediation.int.m0_l3[[13]][5], mediation.int.m0_l3[[13]][6])

df3<-data.frame(terms3, coefs3, lcis3, ucis3, pval3)

g3 <- df3 %>%
  ggplot(aes(x=factor(terms3, levels = c("NDE", "NIE", "TE")), 
             y=coefs3)) +
  geom_point(size=1, color="blue") +
  geom_errorbar(aes(ymin=lcis3, ymax=ucis3), width=0.2, size=0.5) +
  xlab("Lineage 3") +
  ylab("Point Estimate and 95% CI") +
  geom_hline(aes(yintercept = 0), linetype = "dashed", color="red", size=1) +
  geom_hline(aes(yintercept = 1), linetype = "dashed", color="red", size=1) +
  scale_y_continuous(breaks=c(-6, -4, -2, 0, 2, 4, 6),
                     labels = c("-6.0", "-4.0", "-2.0", "0.0", "2.0", "4.0", "6.0")) +
  theme(axis.text=element_text(size=18),
        text = element_text(size=20)) +
  annotate("text", x=2, y=4, label=paste0("p-value==",bquote(.(formatC(as.numeric(mediation.int.m0_l3[[13]][5]),3,format="f")))), parse = TRUE, size=8)

terms4<-c("NDE", "NIE", "TE")
coefs4<-c(mediation.int.m0_l4[[9]][3], mediation.int.m0_l4[[9]][5], mediation.int.m0_l4[[9]][6])
lcis4<-c(mediation.int.m0_l4[[11]][3], mediation.int.m0_l4[[11]][5], mediation.int.m0_l4[[11]][6])
ucis4<-c(mediation.int.m0_l4[[12]][3], mediation.int.m0_l4[[12]][5], mediation.int.m0_l4[[12]][6])
pval4<-c(mediation.int.m0_l4[[13]][3], mediation.int.m0_l4[[13]][5], mediation.int.m0_l4[[13]][6])

df4<-data.frame(terms4, coefs4, lcis4, ucis4, pval4)

g4 <- df4 %>%
  ggplot(aes(x=factor(terms4, levels = c("NDE", "NIE", "TE")), 
             y=coefs4)) +
  geom_point(size=1, color="blue") +
  geom_errorbar(aes(ymin=lcis4, ymax=ucis4), width=0.2, size=0.5) +
  xlab("Lineage 4") +
  ylab("Point Estimate and 95% CI") +
  geom_hline(aes(yintercept = 0), linetype = "dashed", color="red", size=1) +
  geom_hline(aes(yintercept = 1), linetype = "dashed", color="red", size=1) +
  scale_y_continuous(breaks=c(0, 0.5, 1, 1.5, 2, 2.5, 3),
                     labels = c("0.0", "0.5", "1.0", "1.5", "2.0", "2.5", "3.0")) +
  theme(axis.text=element_text(size=18),
        text = element_text(size=20)) +
  annotate("text", x=2, y=2, label=paste0("p-value==",bquote(.(formatC(as.numeric(mediation.int.m0_l4[[13]][5]),3,format="f")))), parse = TRUE, size=8)
library(flextable)
t2 <- flextable::flextable(df2)
t3 <- flextable::flextable(df3)
t4 <- flextable::flextable(df4)
t2
t3
t4

yreg <- glm(pulmonary ~ lineage + mdr2 + country + age10 + immi, family = poisson(), data = lin_pul)
#Ratio, confidence interval, and P-value
cbind(exp(cbind(coef(yreg), confint(yreg))), summary(yreg)[13][[1]][,4])

mreg <- glm(mdr2 ~ lineage + country + age10 + immi, family = binomial(), data = lin_pul)
#Ratio, confidence interval, and P-value
cbind(exp(cbind(coef(mreg), confint(mreg))), summary(mreg)[13][[1]][,4])
```

# Lineage and time to sputum culture conversion

```{r, warning=FALSE, message=FALSE}
lin_time_cul2 <- all2_new %>% 
  mutate(mdr2=NA,
         mdr2=ifelse(mdr=="Drug susceptible", 0,
                     ifelse(mdr=="Isoniazid resistance", 1,
                            ifelse(mdr=="Rifampicin resistance", 1, mdr2))),
         cavity2=NA,
         cavity2=ifelse(cavity=="No", 0,
                        ifelse(cavity=="Yes", 1, cavity2))) %>%
  dplyr::select(lin1234, country, ltimeculture, rtimeculture, mdr2, age, age10, cavity2, immi) %>%
  filter(!(ltimeculture==0 & rtimeculture==0) & lin1234!="Lineage 3") %>%
  mutate(lin1234=droplevels(lin1234),
         lin1234=ifelse(lin1234=="Lineage 1", 1,
                        ifelse(lin1234=="Lineage 2", 2,
                               ifelse(lin1234=="Lineage 4", 4, lin1234))),
         lin1234=factor(lin1234),
         event=NA,
         event=ifelse(!is.na(rtimeculture), 1, 0),
         ltimeculture=ifelse(is.na(ltimeculture), 0, ltimeculture),
         rtimeculture=ifelse(is.na(rtimeculture), Inf, rtimeculture),
         time=NA,
         time=ifelse(rtimeculture==Inf, ltimeculture, ((ltimeculture+rtimeculture)/2)),
         time=as.numeric(time)) %>%
  filter(!is.na(lin1234) & !is.na(country) & !is.na(cavity2) & !is.na(mdr2))

# CMAverse package
######################################
####### Controlled Direct Effect######
######### Natural Effects ############
######################################
#install.packages("devtools", dependencies = TRUE)
#devtools::install_github("BS1125/CMAverse")
library(CMAverse)
library(ggplot2)

## run mediation analysis with interaction using cmest()
mediation.int.m0_l2 <- cmest(data = lin_time_cul2, model = "gformula", casecontrol = FALSE, yrare = F,
                         outcome = "time", 
                         exposure = "lin1234", mediator = c("mdr2", "cavity2"), EMint = F,
                         basec = c("country", "age10", "immi"), 
                         mreg = list("logistic", "logistic"), yreg = "aft_weibull",
                         a = 2, astar = 1, mval = list(0, 0), event = "event", 
                         estimation = "imputation", inference = "bootstrap", nboot = 1000)

mediation.int.m0_l4 <- cmest(data = lin_time_cul2, model = "gformula", casecontrol = FALSE, yrare = F,
                         outcome = "time", 
                         exposure = "lin1234", mediator = c("mdr2", "cavity2"), EMint = F,
                         basec = c("country", "age10", "immi"), 
                         mreg = list("logistic", "logistic"), yreg = "aft_weibull",
                         a = 4, astar = 1, mval = list(0, 0), event = "event", 
                         estimation = "imputation", inference = "bootstrap", nboot = 1000)

summary(mediation.int.m0_l2)
summary(mediation.int.m0_l4)

terms2<-c("NDE", "NIE", "TE")
coefs2<-c(mediation.int.m0_l2[[9]][3], mediation.int.m0_l2[[9]][5], mediation.int.m0_l2[[9]][6])
lcis2<-c(mediation.int.m0_l2[[11]][3], mediation.int.m0_l2[[11]][5], mediation.int.m0_l2[[11]][6])
ucis2<-c(mediation.int.m0_l2[[12]][3], mediation.int.m0_l2[[12]][5], mediation.int.m0_l2[[12]][6])
pval2<-c(mediation.int.m0_l2[[13]][3], mediation.int.m0_l2[[13]][5], mediation.int.m0_l2[[13]][6])

df2<-data.frame(terms2, coefs2, lcis2, ucis2, pval2)

g2 <- df2 %>%
  ggplot(aes(x=factor(terms2, levels = c("NDE", "NIE", "TE")), 
             y=log(coefs2))) +
  geom_point(size=1, color="blue") +
  geom_errorbar(aes(ymin=log(lcis2), ymax=log(ucis2)), width=0.2, size=0.5) +
  xlab("Lineage 2") +
  ylab("Point Estimate and 95% CI") +
  geom_hline(aes(yintercept = 0), linetype = "dashed", color="red", size=1) +
  scale_y_continuous(breaks=log(c(seq(0.5, 2.5, by=0.5))),
                     labels=c(seq(0.5, 2.5, by=0.5))) +
  theme(axis.text=element_text(size=18),
        text = element_text(size=20)) +
  annotate("text", x=2, y=log(2.5), label=paste0("p-value==",bquote(.(formatC(as.numeric(mediation.int.m0_l2[[13]][5]),3,format="f")))), parse = TRUE, size=8)

terms4<-c("NDE", "NIE", "TE")
coefs4<-c(mediation.int.m0_l4[[9]][3], mediation.int.m0_l4[[9]][5], mediation.int.m0_l4[[9]][6])
lcis4<-c(mediation.int.m0_l4[[11]][3], mediation.int.m0_l4[[11]][5], mediation.int.m0_l4[[11]][6])
ucis4<-c(mediation.int.m0_l4[[12]][3], mediation.int.m0_l4[[12]][5], mediation.int.m0_l4[[12]][6])
pval4<-c(mediation.int.m0_l4[[13]][3], mediation.int.m0_l4[[13]][5], mediation.int.m0_l4[[13]][6])

df4<-data.frame(terms4, coefs4, lcis4, ucis4, pval4)

g4 <- df4 %>%
  ggplot(aes(x=factor(terms2, levels = c("NDE", "NIE", "TE")), 
             y=log(coefs4))) +
  geom_point(size=1, color="blue") +
  geom_errorbar(aes(ymin=log(lcis4), ymax=log(ucis4)), width=0.2, size=0.5) +
  xlab("Lineage 4") +
  ylab("Point Estimate and 95% CI") +
  geom_hline(aes(yintercept = 0), linetype = "dashed", color="red", size=1) +
  scale_y_continuous(breaks=log(c(seq(0.5, 2.5, by=0.5))),
                     labels=c(seq(0.5, 2.5, by=0.5))) +
  theme(axis.text=element_text(size=18),
        text = element_text(size=20)) +
  annotate("text", x=2, y=log(2.5), label=paste0("p-value==",bquote(.(formatC(as.numeric(mediation.int.m0_l4[[13]][5]),3,format="f")))), parse = TRUE, size=8)

library(flextable)
t2 <- flextable::flextable(df2)
t4 <- flextable::flextable(df4)
t2
t4

yreg <- survreg(Surv(time, event) ~ lin1234 + mdr2 + cavity2 + country + age10 + immi, dist = "weibull", data = lin_time_cul2)
#Ratio, confidence interval, and P-value
cbind(exp(cbind(coef(yreg), confint(yreg))), summary(yreg)[9][[1]][,4])

mreg1 <- glm(mdr2 ~ lin1234 + country + age10 + immi, family = binomial(), data = lin_time_cul2)
#Ratio, confidence interval, and P-value
cbind(exp(cbind(coef(mreg1), confint(mreg1))), summary(mreg1)[12][[1]][,4])

mreg2 <- glm(cavity2 ~ lin1234 + country + age10 + immi, family = binomial(), data = lin_time_cul2)
#Ratio, confidence interval, and P-value
cbind(exp(cbind(coef(mreg2), confint(mreg2))), summary(mreg2)[12][[1]][,4])
```

```{r plot med_lin_smear}
plot4 <- ggarrange(g2,g4,nrow = 1, ncol = 2, labels = NULL, hjust=-1.7, vjust=1.5, font.label = list(size=30))
annotate_figure(plot4, top = text_grob("CMA of the effect of lineage on time to culture conversion mediated by drug resistance and cavity", 
               color = "red", face = "bold", size = 30))

ggsave("med_lin_cul.png")
```

# Lineage and time to sputum culture conversion with diabetes

```{r, warning=FALSE, message=FALSE}
lin_time_cul2 <- all2_new %>% 
  mutate(mdr2=NA,
         mdr2=ifelse(mdr=="Drug susceptible", 0,
                     ifelse(mdr=="Isoniazid resistance", 1,
                            ifelse(mdr=="Rifampicin resistance", 1, mdr2))),
         dm=ifelse(dm=="Yes", 1, 0),
         cavity2=NA,
         cavity2=ifelse(cavity=="No", 0,
                        ifelse(cavity=="Yes", 1, cavity2))) %>%
  dplyr::select(lin1234, country, ltimeculture, rtimeculture, mdr2, age, age10, cavity2, immi, dm) %>%
  filter(!(ltimeculture==0 & rtimeculture==0) & lin1234!="Lineage 3") %>%
  mutate(lin1234=droplevels(lin1234),
         lin1234=ifelse(lin1234=="Lineage 1", 1,
                        ifelse(lin1234=="Lineage 2", 2,
                               ifelse(lin1234=="Lineage 4", 4, lin1234))),
         lin1234=factor(lin1234),
         event=NA,
         event=ifelse(!is.na(rtimeculture), 1, 0),
         ltimeculture=ifelse(is.na(ltimeculture), 0, ltimeculture),
         rtimeculture=ifelse(is.na(rtimeculture), Inf, rtimeculture),
         time=NA,
         time=ifelse(rtimeculture==Inf, ltimeculture, ((ltimeculture+rtimeculture)/2)),
         time=as.numeric(time)) %>%
  filter(!is.na(lin1234) & !is.na(country) & !is.na(cavity2) & !is.na(mdr2) & !is.na(dm))
```

# Lineage and time to sputum smear conversion

```{r, warning=FALSE, message=FALSE}
lin_time_smear2 <- all2_new %>% 
  mutate(mdr2=NA,
         mdr2=ifelse(mdr=="Drug susceptible", 0,
                     ifelse(mdr=="Isoniazid resistance", 1,
                            ifelse(mdr=="Rifampicin resistance", 1, mdr2))),
         cavity2=NA,
         cavity2=ifelse(cavity=="No", 0,
                        ifelse(cavity=="Yes", 1, cavity2))) %>%
  dplyr::select(lin1234, country, ltimesmear, rtimesmear, mdr2, age, age10, cavity2, immi) %>%
  filter(!(rtimesmear==0 & ltimesmear==0) & lin1234!="Lineage 3") %>%
  mutate(lin1234=droplevels(lin1234),
         lin1234=ifelse(lin1234=="Lineage 1", 1,
                        ifelse(lin1234=="Lineage 2", 2,
                               ifelse(lin1234=="Lineage 4", 4, lin1234))),
         lin1234 = factor(lin1234),
         event=NA,
         event=ifelse(!is.na(rtimesmear), 1, 0),
         ltimesmear=ifelse(is.na(ltimesmear), 0, ltimesmear),
         rtimesmear=ifelse(is.na(rtimesmear), Inf, rtimesmear),
         time=NA,
         time=ifelse(rtimesmear==Inf, ltimesmear, ((ltimesmear+rtimesmear)/2)),
         time=as.numeric(time)) %>%
  filter(!is.na(lin1234) & !is.na(country) & !is.na(cavity2) & !is.na(mdr2))

# CMAverse package
######################################
####### Controlled Direct Effect######
######### Natural Effects ############
######################################
#install.packages("devtools", dependencies = TRUE)
#devtools::install_github("BS1125/CMAverse")
library(CMAverse)
library(ggplot2)

## run mediation analysis with interaction using cmest()
mediation.int.m0_l2 <- cmest(data = lin_time_smear2, model = "gformula", casecontrol = FALSE, yrare = F,
                         outcome = "time", 
                         exposure = "lin1234", mediator = c("mdr2", "cavity2"), EMint = F,
                         basec = c("country", "age10", "immi"), 
                         mreg = list("logistic", "logistic"), yreg = "aft_weibull",
                         a = 2, astar = 1, mval = list(0, 0), event = "event", 
                         estimation = "imputation", inference = "bootstrap", nboot = 1000)

mediation.int.m0_l4 <- cmest(data = lin_time_smear2, model = "gformula", casecontrol = FALSE, yrare = F,
                         outcome = "time", 
                         exposure = "lin1234", mediator = c("mdr2", "cavity2"), EMint = F,
                         basec = c("country", "age10", "immi"), 
                         mreg = list("logistic", "logistic"), yreg = "aft_weibull",
                         a = 4, astar = 1, mval = list(0, 0), event = "event", 
                         estimation = "imputation", inference = "bootstrap", nboot = 1000)

summary(mediation.int.m0_l2)
summary(mediation.int.m0_l4)

terms2<-c("NDE", "NIE", "TE")
coefs2<-c(mediation.int.m0_l2[[9]][3], mediation.int.m0_l2[[9]][5], mediation.int.m0_l2[[9]][6])
lcis2<-c(mediation.int.m0_l2[[11]][3], mediation.int.m0_l2[[11]][5], mediation.int.m0_l2[[11]][6])
ucis2<-c(mediation.int.m0_l2[[12]][3], mediation.int.m0_l2[[12]][5], mediation.int.m0_l2[[12]][6])
pval2<-c(mediation.int.m0_l2[[13]][3], mediation.int.m0_l2[[13]][5], mediation.int.m0_l2[[13]][6])

df2<-data.frame(terms2, coefs2, lcis2, ucis2, pval2)

g2 <- df2 %>%
  ggplot(aes(x=factor(terms2, levels = c("NDE", "NIE", "TE")), 
             y=log(coefs2))) +
  geom_point(size=1, color="blue") +
  geom_errorbar(aes(ymin=log(lcis2), ymax=log(ucis2)), width=0.2, size=0.5) +
  xlab("Lineage 2") +
  ylab("Point Estimate and 95% CI") +
  geom_hline(aes(yintercept = 0), linetype = "dashed", color="red", size=1) +
  scale_y_continuous(breaks=log(c(seq(0.5, 2.5, by=0.5))),
                     labels=c(seq(0.5, 2.5, by=0.5))) +
  theme(axis.text=element_text(size=18),
        text = element_text(size=20)) +
  annotate("text", x=2, y=log(2), label=paste0("p-value==",bquote(.(formatC(as.numeric(mediation.int.m0_l2[[13]][5]),3,format="f")))), parse = TRUE, size=8)

terms4<-c("NDE", "NIE", "TE")
coefs4<-c(mediation.int.m0_l4[[9]][3], mediation.int.m0_l4[[9]][5], mediation.int.m0_l4[[9]][6])
lcis4<-c(mediation.int.m0_l4[[11]][3], mediation.int.m0_l4[[11]][5], mediation.int.m0_l4[[11]][6])
ucis4<-c(mediation.int.m0_l4[[12]][3], mediation.int.m0_l4[[12]][5], mediation.int.m0_l4[[12]][6])
pval4<-c(mediation.int.m0_l4[[13]][3], mediation.int.m0_l4[[13]][5], mediation.int.m0_l4[[13]][6])

df4<-data.frame(terms4, coefs4, lcis4, ucis4, pval4)

g4 <- df4 %>%
  ggplot(aes(x=factor(terms2, levels = c("NDE", "NIE", "TE")), 
             y=log(coefs4))) +
  geom_point(size=1, color="blue") +
  geom_errorbar(aes(ymin=log(lcis4), ymax=log(ucis4)), width=0.2, size=0.5) +
  xlab("Lineage 4") +
  ylab("Point Estimate and 95% CI") +
  geom_hline(aes(yintercept = 0), linetype = "dashed", color="red", size=1) +
  scale_y_continuous(breaks=log(c(seq(0.5, 2.5, by=0.5))),
                     labels=c(seq(0.5, 2.5, by=0.5))) +
  theme(axis.text=element_text(size=18),
        text = element_text(size=20)) +
  annotate("text", x=2, y=log(2), label=paste0("p-value==",bquote(.(formatC(as.numeric(mediation.int.m0_l4[[13]][5]),3,format="f")))), parse = TRUE, size=8)

library(flextable)
t2 <- flextable::flextable(df2)
t4 <- flextable::flextable(df4)
t2
t4

yreg <- survreg(Surv(time, event) ~ lin1234 + mdr2 + cavity2 + country + age10 + immi, dist = "weibull", data = lin_time_smear2)
#Ratio, confidence interval, and P-value
cbind(exp(cbind(coef(yreg), confint(yreg))), summary(yreg)[9][[1]][,4])

mreg1 <- glm(mdr2 ~ lin1234 + country + age10 + immi, family = binomial(), data = lin_time_smear2)
#Ratio, confidence interval, and P-value
cbind(exp(cbind(coef(mreg1), confint(mreg1))), summary(mreg1)[12][[1]][,4])

mreg2 <- glm(cavity2 ~ lin1234 + country + age10 + immi, family = binomial(), data = lin_time_smear2)
#Ratio, confidence interval, and P-value
cbind(exp(cbind(coef(mreg2), confint(mreg2))), summary(mreg2)[12][[1]][,4])
```

```{r plot med_lin_smear}
plot4 <- ggarrange(g2,g4,nrow = 1, ncol = 2, labels = NULL, hjust=-1.7, vjust=1.5, font.label = list(size=30))
annotate_figure(plot4, top = text_grob("CMA of the effect of lineage on time to smear conversion mediated by drug resistance and cavity", 
               color = "red", face = "bold", size = 30))

ggsave("med_lin_smear.png")
```



